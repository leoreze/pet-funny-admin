<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Admin ‚Äì Pet Funny</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --turquesa: #01ADB7;
      --coral: #F9A197;
      --escuro: #222222;
      --cinza-claro: #f4f4f4;
      --branco: #ffffff;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: radial-gradient(circle at top, #ffffff 0, #f4f7f8 40%, #e9f5f6 100%);
      color: var(--escuro);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .hidden { display: none !important; }

    /* HEADER GLOBAL (LOGO) */
    .top-brand {
      width: 100%;
      display: flex;
      justify-content: center;
      padding: 12px 16px 6px;
    }
    .top-brand img { max-width: 220px; height: auto; display: block; }

    /* LOGIN */
    #loginScreen {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px 16px 16px;
    }
    .login-card {
      width: 100%;
      max-width: 400px;
      background: var(--branco);
      border-radius: 20px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.12);
      padding: 22px 20px 18px;
    }
    .login-title { font-size: 20px; font-weight: 700; margin-bottom: 4px; color: #16363c; }
    .login-subtitle { font-size: 13px; color: #607d8b; margin-bottom: 16px; }
    .login-field { margin-bottom: 10px; }
    .login-label { font-size: 12px; font-weight: 500; margin-bottom: 4px; color: #455a64; }
    .login-input {
      width: 100%;
      border-radius: 12px;
      border: 1px solid #d4dde0;
      padding: 8px 10px;
      font-size: 13px;
      transition: border-color 0.12s ease, box-shadow 0.12s ease;
      font-family: inherit;
    }
    .login-input:focus {
      outline: none;
      border-color: var(--turquesa);
      box-shadow: 0 0 0 2px rgba(1, 173, 183, 0.16);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--turquesa), var(--coral));
      color: white;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      box-shadow: 0 8px 16px rgba(0,0,0,0.12);
      transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s;
      white-space: nowrap;
    }
    .btn:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 5px 12px rgba(0,0,0,0.18);
    }
    .btn-light {
      background: #edf3f4;
      color: #333;
      box-shadow: none;
      text-transform: none;
      letter-spacing: 0.04em;
    }
    .btn-danger {
      background: #c62828;
      box-shadow: 0 8px 16px rgba(198, 40, 40, 0.25);
    }
    .btn-secondary {
      background: #eceff1;
      color: #333;
      box-shadow: none;
      text-transform: none;
      letter-spacing: 0.04em;
    }
    .btn-small { font-size: 10px; padding: 4px 8px; box-shadow: none; }

    .login-footer-hint { font-size: 11px; color: #90a4ae; margin-top: 10px; }
    .login-error { font-size: 12px; color: #c62828; margin-top: 6px; }

    /* ADMIN APP */
    #adminApp { flex: 1; display: none; padding: 12px 16px 16px; }

    .container {
      max-width: 1120px;
      width: 100%;
      margin: 0 auto;
      background: var(--branco);
      border-radius: 24px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.08);
      padding: 20px 20px 24px;
    }

    .header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .logo-block { display: flex; flex-direction: column; gap: 2px; }
    .logo-title {
      font-family: "GoodDog Cool", "Comic Sans MS", system-ui, sans-serif;
      font-size: 28px;
      letter-spacing: 0.03em;
      color: var(--turquesa);
    }
    .logo-sub {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: #777;
    }

    .filters { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .filters-group { display: flex; align-items: center; gap: 6px; font-size: 13px; }

    input[type="date"], input[type="text"], input[type="time"], select, textarea {
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid #d7dde0;
      font-size: 13px;
      min-width: 120px;
      font-family: inherit;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--turquesa);
      box-shadow: 0 0 0 2px rgba(1, 173, 183, 0.18);
    }

    .section-title { font-size: 14px; font-weight: 600; margin: 8px 0 4px; color: #444; }
    .section-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin: 8px 0 4px;
      flex-wrap: wrap;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      border-bottom: 1px solid #e1e7ea;
      padding-bottom: 4px;
    }
    .tab-btn {
      border: none;
      background: transparent;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
      color: #607d8b;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .tab-btn.active {
      background: rgba(1,173,183,0.1);
      color: #015d63;
      font-weight: 600;
    }
    .tab-view { display: none; }
    .tab-view.active { display: block; }

    .form-panel {
      margin-top: 8px;
      margin-bottom: 12px;
      background: #f7fbfc;
      border-radius: 16px;
      padding: 10px 12px;
      border: 1px solid #e0edf0;
    }
    .form-row { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 8px; margin-bottom: 8px; }
    .form-row-2 { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 8px; margin-bottom: 8px; }
    .form-group { display: flex; flex-direction: column; gap: 3px; }
    label { font-size: 12px; font-weight: 500; color: #555; }
    textarea { min-height: 48px; resize: vertical; }

    .form-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 4px; flex-wrap: wrap; }
    .error-msg { font-size: 12px; color: #c62828; margin-top: 4px; }

    .stats { display: flex; flex-wrap: wrap; gap: 10px; margin: 12px 0 8px; font-size: 12px; }
    .stats-item {
      background: #f7fbfc;
      border-radius: 14px;
      padding: 8px 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .stats-label { color: #555; }
    .stats-value { font-weight: 700; color: var(--turquesa); }

    .table-wrapper {
      margin-top: 10px;
      border-radius: 16px;
      border: 1px solid #e3eaec;
      overflow: hidden;
      background: #fdfefe;
    }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    thead { background: #f2f7f8; }
    th, td { padding: 7px 8px; text-align: left; border-bottom: 1px solid #ecf1f3; }
    th { font-weight: 600; color: #555; white-space: nowrap; }

    tbody tr:nth-child(even) { background: #fafdfd; }
    tbody tr:hover { background: #eef7f8; }

    .td-mimo { font-weight: 600; color: var(--turquesa); }
    .td-obs { max-width: 220px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .td-status {
      font-weight: 600;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      display: inline-block;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .status-agendado { background: #fff3cd; color: #856404; }
    .status-confirmado { background: #e3f2fd; color: #1565c0; }
    .status-recebido { background: #ede7f6; color: #4527a0; }
    .status-em-servico { background: #fff8e1; color: #ef6c00; }
    .status-concluido { background: #e8f5e9; color: #2e7d32; }
    .status-entregue { background: #e0f7fa; color: #006064; }
    .status-cancelado { background: #ffebee; color: #c62828; }

    .actions { display: flex; gap: 6px; flex-wrap: wrap; }
    .empty { padding: 18px; text-align: center; font-size: 13px; color: #777; }

    .footer {
      margin-top: 12px;
      font-size: 11px;
      color: #888;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
    }

    .two-cols { display: grid; grid-template-columns: 1.2fr 1fr; gap: 12px; margin-top: 8px; }
    .subcard {
      background: #f7fbfc;
      border-radius: 16px;
      padding: 10px 10px 12px;
      border: 1px solid #e1e8eb;
    }
    .subcard-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #37474f;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .subtable-wrapper {
      margin-top: 6px;
      border-radius: 10px;
      border: 1px solid #dde5e8;
      background: #ffffff;
      overflow: hidden;
      max-height: 260px;
      overflow-y: auto;
    }
    .subtable-wrapper table { font-size: 11px; }

    .badge-mini {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(1,173,183,0.1);
      color: #015d63;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .badge-selected { background: rgba(249,161,151,0.15); color: #c04a36; }

    /* ===== NOVO: Toggle de visualiza√ß√£o (Lista / Cards) ===== */
    .view-toggle {
      display: inline-flex;
      align-items: center;
      border: 1px solid #dde5e8;
      background: #ffffff;
      border-radius: 999px;
      overflow: hidden;
      box-shadow: 0 6px 18px rgba(0,0,0,0.05);
    }
    .toggle-btn {
      border: none;
      background: transparent;
      padding: 8px 12px;
      font-size: 12px;
      cursor: pointer;
      color: #607d8b;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .toggle-btn.active {
      background: rgba(1,173,183,0.12);
      color: #015d63;
      font-weight: 700;
    }
    .agenda-actions-right {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* ===== NOVO: Cards da Agenda ===== */
    .cards-wrapper {
      margin-top: 10px;
    }
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }
    .agenda-card {
      background: #ffffff;
      border: 1px solid #e3eaec;
      border-radius: 16px;
      padding: 10px 10px 12px;
      box-shadow: 0 10px 22px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .agenda-card-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
    }
    .agenda-card-time {
      font-weight: 800;
      font-size: 14px;
      color: #16363c;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .agenda-card-date {
      font-size: 11px;
      color: #78909c;
      margin-top: 2px;
    }
    .agenda-card-main {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
      font-size: 12px;
      color: #37474f;
    }
    .agenda-line {
      display: flex;
      gap: 6px;
      align-items: baseline;
      flex-wrap: wrap;
    }
    .agenda-key {
      font-size: 11px;
      color: #78909c;
      min-width: 72px;
    }
    .agenda-val {
      font-weight: 600;
      color: #263238;
    }
    .agenda-muted {
      font-weight: 500;
      color: #546e7a;
    }
    .agenda-card-notes {
      background: #f7fbfc;
      border: 1px dashed #d7e9ec;
      border-radius: 12px;
      padding: 8px;
      font-size: 12px;
      color: #455a64;
      min-height: 38px;
    }
    .agenda-card-bottom {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 2px;
    }

    @media (max-width: 900px) {
      .form-row { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .form-row-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .two-cols { grid-template-columns: 1fr; }
      .cards-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 640px) {
      .header { align-items: flex-start; }
      .filters { width: 100%; }
      .form-row, .form-row-2 { grid-template-columns: 1fr; }
      .table-wrapper { overflow-x: auto; }
      .container { padding: 16px 14px 18px; }
      .cards-grid { grid-template-columns: 1fr; }
    }

    /* RODAP√â GLOBAL */
    .site-footer {
      border-top: 1px solid #dde5e8;
      padding: 12px 16px 16px;
      background: transparent;
    }
    .footer-inner {
      max-width: 1120px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .footer-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .footer-logo { max-width: 140px; height: auto; }
    .footer-info {
      font-size: 12px;
      color: #455a64;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .footer-info strong { font-size: 13px; color: #263238; }
    .footer-bottom { font-size: 11px; color: #78909c; text-align: center; margin-top: 4px; }
  </style>
</head>
<body>

<header class="top-brand">
  <img src="pet-funny-logo.svg" alt="Pet Funny" />
</header>

<section id="loginScreen">
  <div class="login-card">
    <div class="login-title">√Årea Administrativa ‚Äì Pet Funny</div>
    <div class="login-subtitle">
      Acesse com o usu√°rio e senha da equipe para ver agenda, clientes e pets.
    </div>

    <div class="login-field">
      <div class="login-label">Usu√°rio</div>
      <input type="text" id="loginUser" class="login-input" placeholder="adminpetfunny" />
    </div>

    <div class="login-field">
      <div class="login-label">Senha</div>
      <input type="password" id="loginPass" class="login-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
    </div>

    <button id="btnLogin" class="btn" style="margin-top: 8px;">
      Entrar no painel
    </button>

    <div id="loginError" class="login-error hidden">
      Usu√°rio ou senha incorretos. Tente novamente.
    </div>

    <div class="login-footer-hint">
      √Årea exclusiva para a equipe Pet Funny.
    </div>
  </div>
</section>

<div id="adminApp">
  <div class="container">
    <div class="header">
      <div class="logo-block">
        <div class="logo-title">Pet Funny</div>
        <div class="logo-sub">Painel de Agendamentos, Clientes &amp; Pets</div>
      </div>

      <div class="filters">
        <div class="filters-group">
          <span style="font-size:13px;">Data:</span>
          <input type="date" id="filtroData" />
          <button class="btn btn-light" id="btnHoje" type="button">Hoje</button>
          <button class="btn btn-light" id="btnLimparFiltro" type="button">Limpar filtro</button>
        </div>

        <div class="filters-group">
          <span style="font-size:13px;">Pesquisar:</span>
          <input type="text" id="filtroBusca" placeholder="Nome, pet ou telefone" />
        </div>

        <button class="btn btn-light" id="btnExportarCSV" type="button">Exportar CSV</button>

        <button class="btn btn-danger btn-small" id="btnLogout" type="button">Sair</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-tab="tab-agenda" type="button"><span>üìÖ</span> Agenda &amp; Mimos</button>
      <button class="tab-btn" data-tab="tab-clientes" type="button"><span>üë§</span> Clientes &amp; Pets</button>
      <button class="tab-btn" data-tab="tab-servicos" type="button"><span>üßº</span> Servi√ßos</button>
      <button class="tab-btn" data-tab="tab-hours" type="button"><span>üïí</span> Hor√°rio de Funcionamento</button>
      <button class="tab-btn" data-tab="tab-dashboard" type="button"><span>üìä</span> Dashboard</button>
    </div>

    <!-- TAB: AGENDA -->
    <section id="tab-agenda" class="tab-view active">
      <div class="section-title-row">
        <div class="section-title">Agendamentos do dia</div>

        <div class="agenda-actions-right">
          <!-- NOVO: Toggle Lista/Cards -->
          <div class="view-toggle" aria-label="Alternar visualiza√ß√£o">
            <button class="toggle-btn active" id="btnViewList" type="button">üìã Lista</button>
            <button class="toggle-btn" id="btnViewCards" type="button">üóÇÔ∏è Cards</button>
          </div>

          <button class="btn btn-light" id="btnNovoAgendamento" type="button">+ Novo agendamento</button>
        </div>
      </div>

      <div class="form-panel hidden" id="formPanel">
        <input type="hidden" id="bookingId" />
        <input type="hidden" id="bookingOriginalStatus" />

        <div class="form-row">
          <div class="form-group">
            <label for="formPhone">Telefone (WhatsApp)</label>
            <input type="text" id="formPhone" placeholder="(16) 9 9999-9999" />
          </div>
          <div class="form-group">
            <label for="formNome">Tutor(a)</label>
            <input type="text" id="formNome" placeholder="Nome do tutor" />
          </div>
          <div class="form-group">
            <label for="formPetSelect">Pet (opcional)</label>
            <select id="formPetSelect">
              <option value="">(Sem pet informado)</option>
            </select>
          </div>
          <div class="form-group">
            <label for="formPrize">Mimo (Roleta)</label>
            <select id="formPrize">
              <option value="Tosa Higi√™nica">Tosa Higi√™nica</option>
              <option value="Hidrata√ß√£o">Hidrata√ß√£o</option>
              <option value="Foto e V√≠deo Profissional">Foto e V√≠deo Profissional</option>
              <option value="Patinhas impec√°veis">Patinhas impec√°veis</option>
            </select>
          </div>
        </div>

        <div class="form-row-2">
          <div class="form-group">
            <label for="formService">Servi√ßo (do banco)</label>
            <select id="formService">
              <option value="">Carregando servi√ßos...</option>
            </select>
          </div>
          <div class="form-group">
            <label for="formDate">Data</label>
            <input type="date" id="formDate" />
          </div>
          <div class="form-group">
            <label for="formTime">Hor√°rio</label>
            <input type="time" id="formTime" />
          </div>
        </div>

        <div class="form-row-2">
          <div class="form-group">
            <label for="formStatus">Status</label>
            <select id="formStatus">
              <option value="agendado">Agendado</option>
              <option value="confirmado">Confirmado</option>
              <option value="recebido">Recebido</option>
              <option value="em servi√ßo">Em servi√ßo</option>
              <option value="conclu√≠do">Conclu√≠do</option>
              <option value="entregue">Entregue</option>
              <option value="cancelado">Cancelado</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="formNotes">Observa√ß√µes</label>
          <textarea id="formNotes" placeholder="Ex: porte, comportamento, cuidados especiais..."></textarea>
        </div>

        <div id="formError" class="error-msg" style="display:none;"></div>

        <div class="form-actions">
          <button class="btn btn-secondary" id="btnCancelarEdicao" type="button">Limpar / cancelar</button>
          <button class="btn" id="btnSalvar" type="button">Salvar</button>
        </div>
      </div>

      <div class="stats">
        <div class="stats-item"><span class="stats-label">Total de agendamentos:</span> <span class="stats-value" id="statTotal">0</span></div>
        <div class="stats-item"><span class="stats-label">Tosa Higi√™nica:</span> <span class="stats-value" id="statTosa">0</span></div>
        <div class="stats-item"><span class="stats-label">Hidrata√ß√£o:</span> <span class="stats-value" id="statHidratacao">0</span></div>
        <div class="stats-item"><span class="stats-label">Foto/V√≠deo:</span> <span class="stats-value" id="statFotoVideo">0</span></div>
        <div class="stats-item"><span class="stats-label">Patinhas impec√°veis:</span> <span class="stats-value" id="statPatinhas">0</span></div>
      </div>

      <!-- NOVO: Wrapper Lista -->
      <div id="agendaListWrapper" class="table-wrapper">
        <table>
          <thead>
          <tr>
            <th>Data</th>
            <th>Hora</th>
            <th>Tutor(a)</th>
            <th>Pet</th>
            <th>Telefone</th>
            <th>Servi√ßo</th>
            <th>Mimo</th>
            <th>Status</th>
            <th>√öltima notifica√ß√£o</th>
            <th>Obs.</th>
            <th>A√ß√µes</th>
          </tr>
          </thead>
          <tbody id="tbodyAgenda"></tbody>
        </table>
        <div id="estadoVazio" class="empty" style="display:none;">Nenhum agendamento encontrado para o filtro atual.</div>
      </div>

      <!-- NOVO: Wrapper Cards -->
      <div id="agendaCardsWrapper" class="cards-wrapper hidden">
        <div id="agendaCards" class="cards-grid"></div>
        <div id="estadoVazioCards" class="empty hidden">Nenhum agendamento encontrado para o filtro atual.</div>
      </div>
    </section>

    <!-- TAB: CLIENTES & PETS -->
    <section id="tab-clientes" class="tab-view">
      <div class="section-title">Clientes &amp; Pets</div>
      <div class="two-cols">
        <!-- CLIENTES -->
        <div class="subcard">
          <div class="subcard-title">
            <span>Clientes</span>
            <span id="badgeClienteSelecionado" class="badge-mini badge-selected hidden">Cliente selecionado</span>
            <button class="btn btn-secondary btn-small" id="btnNovoCliente" type="button">+ Novo cliente</button>
          </div>

          <div id="clienteFormBlock" class="hidden">
            <div class="form-group">
              <label for="cliPhone">Telefone (WhatsApp)</label>
              <input type="text" id="cliPhone" placeholder="(16) 9 9999-9999" />
            </div>
            <div class="form-group">
              <label for="cliName">Nome do tutor</label>
              <input type="text" id="cliName" placeholder="Nome completo" />
            </div>
            <div id="cliError" class="error-msg" style="display:none;"></div>
            <div class="form-actions">
              <button class="btn btn-secondary btn-small" id="btnCliLimpar" type="button">Limpar</button>
              <button class="btn btn-small" id="btnCliSalvar" type="button">Salvar / Atualizar</button>
            </div>
          </div>

          <div class="subtable-wrapper" style="margin-top:10px;">
            <table>
              <thead>
              <tr>
                <th>ID</th>
                <th>Tutor</th>
                <th>Telefone</th>
                <th>Pets</th>
                <th>A√ß√µes</th>
              </tr>
              </thead>
              <tbody id="tbodyClientes"></tbody>
            </table>
          </div>
        </div>

        <!-- PETS DO CLIENTE SELECIONADO -->
        <div class="subcard hidden" id="petsCard">
          <div class="subcard-title">
            <span>Pets do cliente selecionado</span>
            <button class="btn btn-secondary btn-small" id="btnNovoPet" type="button">+ Novo pet</button>
          </div>
          <div class="form-group">
            <label for="petName">Nome do pet</label>
            <input type="text" id="petName" placeholder="Nome do pet" />
          </div>
          <div class="form-group">
            <label for="petBreed">Ra√ßa</label>
            <select id="petBreed"></select>
          </div>
          <div class="form-group">
            <label for="petInfo">Mais informa√ß√µes</label>
            <textarea id="petInfo" placeholder="Porte, comportamento, medica√ß√£o, etc."></textarea>
          </div>
          <div id="petError" class="error-msg" style="display:none;"></div>
          <div class="form-actions">
            <button class="btn btn-secondary btn-small" id="btnPetLimpar" type="button">Limpar</button>
            <button class="btn btn-small" id="btnPetSalvar" type="button">Salvar pet</button>
          </div>

          <div class="subtable-wrapper" style="margin-top:10px;">
            <table>
              <thead>
              <tr>
                <th>ID</th>
                <th>Nome</th>
                <th>Ra√ßa</th>
                <th>Info</th>
                <th>A√ß√µes</th>
              </tr>
              </thead>
              <tbody id="tbodyPets"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB: SERVI√áOS -->
    <section id="tab-servicos" class="tab-view">
      <div class="section-title-row">
        <div class="section-title">Servi√ßos</div>
        <button class="btn btn-light" id="btnNovoServico" type="button">+ Novo servi√ßo</button>
      </div>

      <div class="form-panel hidden" id="serviceFormPanel">
        <input type="hidden" id="serviceId" />
        <div class="form-row-2">
          <div class="form-group">
            <label for="serviceDate">Data</label>
            <input type="date" id="serviceDate" />
          </div>
          <div class="form-group">
            <label for="serviceTitle">T√≠tulo do servi√ßo</label>
            <input type="text" id="serviceTitle" placeholder="Ex: Banho + Tosa (Porte M)" />
          </div>
          <div class="form-group">
            <label for="servicePrice">Valor (R$)</label>
            <input type="text" id="servicePrice" placeholder="R$ 0,00" inputmode="numeric" />
          </div>
        </div>

        <div id="serviceError" class="error-msg" style="display:none;"></div>

        <div class="form-actions">
          <button class="btn btn-secondary" id="btnServiceCancel" type="button">Limpar / cancelar</button>
          <button class="btn" id="btnServiceSave" type="button">Salvar</button>
        </div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Data</th>
              <th>T√≠tulo</th>
              <th>Valor</th>
              <th>Criado em</th>
              <th>Atualizado em</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tbodyServices"></tbody>
        </table>
        <div id="servicesEmpty" class="empty" style="display:none;">Nenhum servi√ßo cadastrado ainda.</div>
      </div>
    </section>

    
    <!-- TAB: HOR√ÅRIO DE FUNCIONAMENTO -->
    <section id="tab-hours" class="tab-view">
      <div class="section-title-row">
        <div class="section-title">Hor√°rio de Funcionamento</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
          <span style="font-size:12px;color:#607d8b;">Configura√ß√£o por dia (slots de 30 min)</span>
          <button class="btn btn-light" id="btnHoursReload" type="button">Recarregar</button>
          <button class="btn" id="btnHoursSave" type="button">Salvar hor√°rios</button>
        </div>
      </div>

      <div class="form-panel">
        <div style="font-size:12px;color:#455a64;line-height:1.4;">
          Defina abertura/fechamento, se o dia est√° fechado e o limite m√°ximo de agendamentos por slot de 30 minutos.
          Essa regra passa a valer para o site do cliente e para o painel admin.
        </div>
        <div id="hoursError" class="error-msg" style="display:none;margin-top:8px;"></div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Dia</th>
              <th>Fechado?</th>
              <th>Abertura</th>
              <th>Fechamento</th>
              <th>M√°x. agendamentos / 30 min</th>
            </tr>
          </thead>
          <tbody id="tbodyHours"></tbody>
        </table>
      </div>
    </section>


    <!-- TAB: DASHBOARD -->
    <section id="tab-dashboard" class="tab-view">
      <div class="section-title-row">
        <div class="section-title">Dashboard de Indicadores</div>
      </div>

      <div class="form-panel" id="dashboardFilters">
        <div class="form-row-2">
          <div class="form-group">
            <label for="dashPeriod">Per√≠odo</label>
            <select id="dashPeriod">
              <option value="today">Hoje</option>
              <option value="7">√öltimos 7 dias</option>
              <option value="30">√öltimos 30 dias</option>
              <option value="month">M√™s atual</option>
              <option value="custom">Personalizado</option>
            </select>
          </div>
          <div class="form-group dash-custom-range hidden" id="dashCustomRange">
            <label>Per√≠odo personalizado</label>
            <div style="display:flex;gap:6px;flex-wrap:wrap;">
              <input type="date" id="dashStart" />
              <input type="date" id="dashEnd" />
              <button class="btn btn-small" id="dashApply" type="button">Aplicar</button>
            </div>
          </div>
        </div>
      </div>

      <div class="stats">
        <div class="stats-item"><span class="stats-label">Agendamentos no per√≠odo:</span> <span class="stats-value" id="dashTotalBookings">0</span></div>
        <div class="stats-item"><span class="stats-label">Clientes √∫nicos no per√≠odo:</span> <span class="stats-value" id="dashUniqueCustomers">0</span></div>
        <div class="stats-item"><span class="stats-label">Total de clientes cadastrados:</span> <span class="stats-value" id="dashTotalCustomers">0</span></div>
      </div>

      <div class="section-title" style="margin-top:12px;">Status dos agendamentos</div>
      <div class="stats">
        <div class="stats-item"><span class="stats-label">Agendado:</span> <span class="stats-value" id="dashStatusAgendado">0</span></div>
        <div class="stats-item"><span class="stats-label">Confirmado:</span> <span class="stats-value" id="dashStatusConfirmado">0</span></div>
        <div class="stats-item"><span class="stats-label">Recebido:</span> <span class="stats-value" id="dashStatusRecebido">0</span></div>
        <div class="stats-item"><span class="stats-label">Em servi√ßo:</span> <span class="stats-value" id="dashStatusEmServico">0</span></div>
        <div class="stats-item"><span class="stats-label">Conclu√≠do:</span> <span class="stats-value" id="dashStatusConcluido">0</span></div>
        <div class="stats-item"><span class="stats-label">Entregue:</span> <span class="stats-value" id="dashStatusEntregue">0</span></div>
        <div class="stats-item"><span class="stats-label">Cancelado:</span> <span class="stats-value" id="dashStatusCancelado">0</span></div>
      </div>

      <div class="section-title" style="margin-top:12px;">Mimos da Roleta no per√≠odo</div>
      <div class="stats">
        <div class="stats-item"><span class="stats-label">Tosa Higi√™nica:</span> <span class="stats-value" id="dashPrizeTosa">0</span></div>
        <div class="stats-item"><span class="stats-label">Hidrata√ß√£o:</span> <span class="stats-value" id="dashPrizeHidratacao">0</span></div>
        <div class="stats-item"><span class="stats-label">Foto/V√≠deo Profissional:</span> <span class="stats-value" id="dashPrizeFotoVideo">0</span></div>
        <div class="stats-item"><span class="stats-label">Patinhas impec√°veis:</span> <span class="stats-value" id="dashPrizePatinhas">0</span></div>
      </div>

      <!-- NOVO: M√âTRICAS FINANCEIRAS POR SERVI√áO -->
      <div class="section-title" style="margin-top:16px;">Servi√ßos no per√≠odo (quantidade e faturamento estimado)</div>

      <div class="stats">
        <div class="stats-item"><span class="stats-label">Faturamento estimado no per√≠odo:</span> <span class="stats-value" id="dashRevenue">R$ 0,00</span></div>
        <div class="stats-item"><span class="stats-label">Ticket m√©dio estimado:</span> <span class="stats-value" id="dashAvgTicket">R$ 0,00</span></div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Servi√ßo</th>
              <th>Qtd.</th>
              <th>Pre√ßo (cadastro)</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="tbodyDashServices"></tbody>
        </table>
        <div id="dashServicesEmpty" class="empty" style="display:none;">Sem dados suficientes para compor o financeiro por servi√ßo.</div>
      </div>

      <div class="section-title" style="margin-top:20px;">Vis√£o Gr√°fica</div>
      <div style="display:flex;flex-wrap:wrap;gap:20px;justify-content:center;margin-top:10px;">
        <div style="background:#fff;border-radius:16px;padding:12px;box-shadow:0 4px 14px rgba(0,0,0,0.06);">
          <canvas id="chartStatus" style="max-width:460px;"></canvas>
        </div>
        <div style="background:#fff;border-radius:16px;padding:12px;box-shadow:0 4px 14px rgba(0,0,0,0.06);">
          <canvas id="chartPrizes" style="max-width:380px;"></canvas>
        </div>
      </div>
    </section>

    <div class="footer">
      <div>Dados via API (<code>/api/customers</code>, <code>/api/pets</code>, <code>/api/bookings</code>, <code>/api/services</code>). Exporta√ß√£o CSV feita no navegador.</div>
      <div>Pet Funny ‚Ä¢ Admin CRUD &amp; Status</div>
    </div>
  </div>
</div>

<footer class="site-footer">
  <div class="footer-inner">
    <div class="footer-top">
      <img src="pet-funny-logo.svg" alt="Pet Funny" class="footer-logo" />
      <div class="footer-info">
        <strong>Pet Funny ‚Ä¢ Banho &amp; Tosa</strong>
        <span>Rua Virg√≠lio de Carvalho Neves Neto, 794 ‚Äì Ribeir√£o Preto / SP</span>
        <span>Hor√°rio: Seg‚ÄìSex: 07:30 √†s 17:30 ‚Ä¢ S√°bado: 07:30 √†s 13:00</span>
        <span>WhatsApp: (16) 98153-5338</span>
      </div>
    </div>
    <div class="footer-bottom">¬© 2024 Pet Funny ‚Ä¢ Roleta de Mimos. Todos os direitos reservados.</div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const API_BASE_URL = '';

  /* ===== Helpers de normaliza√ß√£o (corrige acentos/varia√ß√µes) ===== */
  function normStr(s) {
    return String(s || '')
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .trim();
  }

  /* ========= CONTROLE DE SESS√ÉO (30 MIN) ========= */
  const SESSION_KEY = 'pf_admin_session';
  const SESSION_DURATION_MS = 30 * 60 * 1000;
  let sessionTimerId = null;
  let appInitialized = false;

  function setSession() {
    const expiresAt = Date.now() + SESSION_DURATION_MS;
    const session = { user: 'adminpetfunny', expiresAt };
    try { localStorage.setItem(SESSION_KEY, JSON.stringify(session)); } catch (_) {}
  }
  function clearSession() { try { localStorage.removeItem(SESSION_KEY); } catch (_) {} }
  function getSession() {
    try {
      const raw = localStorage.getItem(SESSION_KEY);
      if (!raw) return null;
      const data = JSON.parse(raw);
      if (!data.expiresAt || Date.now() > data.expiresAt) { clearSession(); return null; }
      return data;
    } catch (_) { clearSession(); return null; }
  }

  function handleSessionExpired() {
    if (sessionTimerId) { clearInterval(sessionTimerId); sessionTimerId = null; }
    clearSession();
    adminApp.style.display = 'none';
    loginScreen.classList.remove('hidden');
    alert('Sua sess√£o expirou. Fa√ßa login novamente.');
  }

  function startSessionTimer() {
    if (sessionTimerId) clearInterval(sessionTimerId);
    sessionTimerId = setInterval(() => {
      const s = getSession();
      if (!s) handleSessionExpired();
    }, 30000);
  }

  async function initApp() {
    if (appInitialized) {
      try { await loadServices(); await renderTabela(); await loadDashboard(); } catch (_) {}
      return;
    }
    appInitialized = true;
    try {
      await loadServices();      // garante servicesCache e dropdown de servi√ßos
      await renderTabela();
      await loadClientes();
      await loadDashboard();
      initAgendaViewToggle();    // NOVO: inicia toggle (lista/cards)
    } catch (e) { console.error(e); }
  }

  function enterAdminMode() {
    loginError.classList.add('hidden');
    loginScreen.classList.add('hidden');
    adminApp.style.display = 'block';
    setSession();
    startSessionTimer();
    initApp();
  }

  function doLogout() {
    clearSession();
    if (sessionTimerId) { clearInterval(sessionTimerId); sessionTimerId = null; }
    limparForm();
    limparClienteForm();
    clearServiceForm();
    adminApp.style.display = 'none';
    loginScreen.classList.remove('hidden');
  }

  function tryAutoLogin() {
    const s = getSession();
    if (s) {
      adminApp.style.display = 'block';
      loginScreen.classList.add('hidden');
      startSessionTimer();
      initApp();
    } else {
      loginScreen.classList.remove('hidden');
      adminApp.style.display = 'none';
    }
  }

  // ===== LOGIN =====
  const loginScreen = document.getElementById('loginScreen');
  const adminApp = document.getElementById('adminApp');
  const loginUser = document.getElementById('loginUser');
  const loginPass = document.getElementById('loginPass');
  const btnLogin = document.getElementById('btnLogin');
  const loginError = document.getElementById('loginError');
  const btnLogout = document.getElementById('btnLogout');

  btnLogin.addEventListener('click', () => {
    const u = loginUser.value.trim();
    const p = loginPass.value.trim();
    if (u === 'adminpetfunny' && p === 'admin2605') enterAdminMode();
    else loginError.classList.remove('hidden');
  });

  [loginUser, loginPass].forEach(el => {
    el.addEventListener('keydown', (e) => { if (e.key === 'Enter') btnLogin.click(); });
  });

  btnLogout.addEventListener('click', () => {
    if (confirm('Deseja sair do painel?')) doLogout();
  });

  // ===== API HELPERS =====
  async function apiGet(path, params) {
    const url = new URL(API_BASE_URL + path, window.location.origin);
    if (params) {
      Object.keys(params).forEach(k => {
        const v = params[k];
        if (v !== undefined && v !== null && v !== '') url.searchParams.append(k, v);
      });
    }
    const resp = await fetch(url.toString());
    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) throw new Error(data.error || 'Erro ao buscar dados.');
    return data;
  }

  async function apiPost(path, body) {
    const resp = await fetch(API_BASE_URL + path, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) throw new Error(data.error || 'Erro ao salvar.');
    return data;
  }

  async function apiPut(path, body) {
    const resp = await fetch(API_BASE_URL + path, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) throw new Error(data.error || 'Erro ao atualizar.');
    return data;
  }

  async function apiDelete(path) {
    const resp = await fetch(API_BASE_URL + path, { method: 'DELETE' });
    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) throw new Error(data.error || 'Erro ao apagar.');
    return data;
  }

  function sanitizePhone(phone) { return (phone || '').replace(/\D/g, ''); }

  function formatTelefone(phone) {
    const digits = (phone || '').replace(/\D/g, '');
    if (digits.length === 11) return digits.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
    if (digits.length === 10) return digits.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
    return phone || '-';
  }

  function applyPhoneMask(input) {
    if (!input) return;
    let value = input.value.replace(/\D/g, '');
    if (value.length > 11) value = value.slice(0, 11);
    let formatted = value;
    if (value.length > 0) formatted = `(${value.slice(0, 2)}`;
    if (value.length >= 3) formatted = `(${value.slice(0, 2)}) ${value.slice(2, 3)}`;
    if (value.length >= 4) formatted = `(${value.slice(0, 2)}) ${value.slice(2, 3)} ${value.slice(3, 7)}`;
    if (value.length >= 8) formatted = `(${value.slice(0, 2)}) ${value.slice(2, 3)} ${value.slice(3, 7)}-${value.slice(7, 11)}`;
    input.value = formatted;
  }

  function formatDataBr(dataIso) {
    const parts = (dataIso || '').split('-');
    if (parts.length === 3) return parts[2] + '/' + parts[1] + '/' + parts[0];
    return dataIso || '-';
  }

  function formatDateTimeBr(iso) {
    if (!iso) return '-';
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return '-';
    const dia = String(d.getDate()).padStart(2, '0');
    const mes = String(d.getMonth() + 1).padStart(2, '0');
    const ano = d.getFullYear();
    const hora = String(d.getHours()).padStart(2, '0');
    const min = String(d.getMinutes()).padStart(2, '0');
    return `${dia}/${mes}/${ano} ${hora}:${min}`;
  }

  function toISODateOnly(date) {
    const ano = date.getFullYear();
    const mes = String(date.getMonth() + 1).padStart(2, '0');
    const dia = String(date.getDate()).padStart(2, '0');
    return `${ano}-${mes}-${dia}`;
  }

  function getPeriodRange(periodValue) {
    const hoje = new Date();
    let start = null, end = null;

    if (periodValue === 'today') {
      start = toISODateOnly(hoje);
      end = toISODateOnly(hoje);
    } else if (periodValue === '7') {
      const d = new Date(); d.setDate(d.getDate() - 6);
      start = toISODateOnly(d); end = toISODateOnly(hoje);
    } else if (periodValue === '30') {
      const d = new Date(); d.setDate(d.getDate() - 29);
      start = toISODateOnly(d); end = toISODateOnly(hoje);
    } else if (periodValue === 'month') {
      const dStart = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
      start = toISODateOnly(dStart); end = toISODateOnly(hoje);
    }
    return { start, end };
  }

  function classStatus(status) {
    const s = normStr(status);
    if (s === 'agendado') return 'status-agendado';
    if (s === 'confirmado') return 'status-confirmado';
    if (s === 'recebido') return 'status-recebido';
    if (s === 'em servico' || s === 'em servi√ßo') return 'status-em-servico';
    if (s === 'concluido' || s === 'conclu√≠do') return 'status-concluido';
    if (s === 'entregue') return 'status-entregue';
    if (s === 'cancelado') return 'status-cancelado';
    return 'status-agendado';
  }

  function buildStatusMessage(status, nome, petLabel, service, dataBR, time, prize) {
    const s = normStr(status);
    const cabecalho = `Oi ${nome}! Aqui √© do Pet Funny!\n\n`;
    let corpo = '';

    switch (s) {
      case 'agendado':
        corpo = `Acabamos de registrar o agendamento de *${petLabel}* para *${service}* em *${dataBR} √†s ${time}*.\n\nMimo da campanha Roleta de Mimos: *${prize}*.\n\nQuando estiver pr√≥ximo do dia, te avisamos por aqui.`;
        break;
      case 'confirmado':
        corpo = `Seu agendamento de *${petLabel}* para *${service}* em *${dataBR} √†s ${time}* foi *CONFIRMADO* \n\nMimo garantido: *${prize}*.\n\nQualquer altera√ß√£o √© s√≥ avisar a gente aqui no WhatsApp.`;
        break;
      case 'recebido':
        corpo = `*${petLabel}* j√° est√° aqui com a gente para *${service}* \n\nEstamos cuidando com muito carinho.\n\nMimo da vez: *${prize}*.\n\nAssim que estiver tudo pronto, te avisamos por aqui.`;
        break;
      case 'em servico':
        corpo = `Estamos cuidando de *${petLabel}* agora mesmo no *${service}* \n\nMimo aplicado: *${prize}*.\n\nDaqui a pouco estar√° pronto(a) para ser buscado(a).`;
        break;
      case 'concluido':
        corpo = `O servi√ßo de *${petLabel}* (*${service}*) foi *CONCLU√çDO* \n\nMimo aplicado: *${prize}*.\n\nQuando quiser, j√° pode vir buscar.`;
        break;
      case 'entregue':
        corpo = `Tudo entregue, e esperamos que voc√™ tenha gostado do resultado! \n\nRefer√™ncia: *${petLabel}*\nServi√ßo: *${service}*\nMimo da Roleta: *${prize}*.\n\nObrigada por confiar no Pet Funny!`;
        break;
      case 'cancelado':
        corpo = `Seu agendamento de *${petLabel}* para *${service}* em *${dataBR} √†s ${time}* foi *CANCELADO* \n\nSe quiser remarcar, √© s√≥ mandar mensagem por aqui que encontramos um novo hor√°rio.`;
        break;
      default:
        corpo = `O status do agendamento de *${petLabel}* para *${service}* em *${dataBR} √†s ${time}* foi atualizado para: *${String(status || '').toUpperCase()}*.\n\nMimo da campanha Roleta de Mimos: *${prize}*.\n\nQualquer d√∫vida, √© s√≥ chamar aqui no WhatsApp!`;
    }
    return cabecalho + corpo;
  }

  /* ===== MOEDA: m√°scara e convers√µes (value_cents) ===== */
  function formatCentsToBRL(cents) {
    const n = Number(cents || 0) / 100;
    return n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  function applyCurrencyMask(input) {
    if (!input) return;
    let raw = String(input.value || '').replace(/\D/g, '');

    // se usu√°rio apagou tudo, ok
    if (raw === '') {
      input.value = '';
      input.dataset.cents = '';
      return;
    }

    // permite zero
    raw = raw.replace(/^0+/, '');
    if (raw === '') raw = '0';

    input.dataset.cents = raw;
    input.value = formatCentsToBRL(raw);
  }

  function getCentsFromCurrencyInput(input) {
    if (!input) return null;

    // 1) tenta via dataset (m√°scara)
    let raw = String(input.dataset?.cents || '').replace(/\D/g, '');
    if (raw) {
      const cents = parseInt(raw, 10);
      return Number.isFinite(cents) ? cents : null;
    }

    // 2) fallback: tenta parsear pelo texto digitado/colado (ex: "85,00" ou "R$ 85,00" ou "85")
    const txt = String(input.value || '').trim();
    if (!txt) return null;

    const digits = txt.replace(/\s/g, '').replace(/[R$r$]/g, '');
    // se tiver v√≠rgula, assume centavos; se n√£o tiver, assume reais inteiros
    if (digits.includes(',')) {
      const cleaned = digits.replace(/\./g, '').replace(',', '.');
      const n = Number(cleaned);
      if (!Number.isFinite(n)) return null;
      return Math.round(n * 100);
    } else {
      const onlyDigits = digits.replace(/\D/g, '');
      if (!onlyDigits) return null;
      return parseInt(onlyDigits, 10) * 100;
    }
  }

  /* ===== TABS ===== */
  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabViews = document.querySelectorAll('.tab-view');

  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      tabButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const tabId = btn.getAttribute('data-tab');
      tabViews.forEach(view => view.classList.toggle('active', view.id === tabId));

      if (tabId === 'tab-servicos') loadServices().catch(console.error);

      if (tabId === 'tab-hours') {
        loadOpeningHours().catch(console.error);
      }

      if (tabId === 'tab-dashboard') {
        loadDashboard().finally(() => {
          setTimeout(() => {
            try { if (statusChart) statusChart.resize(); } catch (_) {}
            try { if (prizeChart) prizeChart.resize(); } catch (_) {}
          }, 60);
        });
      }

      // NOVO: quando voltar para agenda, renderiza conforme view atual
      if (tabId === 'tab-agenda') {
        try { renderAgendaByView(ultimaLista || []); } catch (_) {}
      }
    });
  });

  // ===== CAMPOS AGENDA =====
  const filtroData = document.getElementById('filtroData');
  const filtroBusca = document.getElementById('filtroBusca');
  const btnHoje = document.getElementById('btnHoje');
  const btnLimparFiltro = document.getElementById('btnLimparFiltro');
  const btnExportarCSV = document.getElementById('btnExportarCSV');
  const btnNovoAgendamento = document.getElementById('btnNovoAgendamento');

  const tbodyAgenda = document.getElementById('tbodyAgenda');
  const estadoVazio = document.getElementById('estadoVazio');

  // NOVO: cards
  const agendaListWrapper = document.getElementById('agendaListWrapper');
  const agendaCardsWrapper = document.getElementById('agendaCardsWrapper');
  const agendaCards = document.getElementById('agendaCards');
  const estadoVazioCards = document.getElementById('estadoVazioCards');
  const btnViewList = document.getElementById('btnViewList');
  const btnViewCards = document.getElementById('btnViewCards');

  const statTotal = document.getElementById('statTotal');
  const statTosa = document.getElementById('statTosa');
  const statHidratacao = document.getElementById('statHidratacao');
  const statFotoVideo = document.getElementById('statFotoVideo');
  const statPatinhas = document.getElementById('statPatinhas');

  const formPanel = document.getElementById('formPanel');

  const bookingId = document.getElementById('bookingId');
  const bookingOriginalStatus = document.getElementById('bookingOriginalStatus');
  const formPhone = document.getElementById('formPhone');
  const formNome = document.getElementById('formNome');
  const formPetSelect = document.getElementById('formPetSelect');
  const formPrize = document.getElementById('formPrize');
  const formService = document.getElementById('formService');
  const formDate = document.getElementById('formDate');
  const formTime = document.getElementById('formTime');
  const formStatus = document.getElementById('formStatus');
  const formNotes = document.getElementById('formNotes');
  const formError = document.getElementById('formError');
  const btnSalvar = document.getElementById('btnSalvar');
  const btnCancelarEdicao = document.getElementById('btnCancelarEdicao');

  // ===== DASHBOARD =====
  const dashPeriod = document.getElementById('dashPeriod');
  const dashCustomRange = document.getElementById('dashCustomRange');
  const dashStart = document.getElementById('dashStart');
  const dashEnd = document.getElementById('dashEnd');
  const dashApply = document.getElementById('dashApply');

  const dashTotalBookings = document.getElementById('dashTotalBookings');
  const dashUniqueCustomers = document.getElementById('dashUniqueCustomers');
  const dashTotalCustomers = document.getElementById('dashTotalCustomers');

  const dashStatusAgendado = document.getElementById('dashStatusAgendado');
  const dashStatusConfirmado = document.getElementById('dashStatusConfirmado');
  const dashStatusRecebido = document.getElementById('dashStatusRecebido');
  const dashStatusEmServico = document.getElementById('dashStatusEmServico');
  const dashStatusConcluido = document.getElementById('dashStatusConcluido');
  const dashStatusEntregue = document.getElementById('dashStatusEntregue');
  const dashStatusCancelado = document.getElementById('dashStatusCancelado');

  const dashPrizeTosa = document.getElementById('dashPrizeTosa');
  const dashPrizeHidratacao = document.getElementById('dashPrizeHidratacao');
  const dashPrizeFotoVideo = document.getElementById('dashPrizeFotoVideo');
  const dashPrizePatinhas = document.getElementById('dashPrizePatinhas');

  const tbodyDashServices = document.getElementById('tbodyDashServices');
  const dashServicesEmpty = document.getElementById('dashServicesEmpty');
  const dashRevenue = document.getElementById('dashRevenue');
  const dashAvgTicket = document.getElementById('dashAvgTicket');

  let ultimaLista = [];
  let clientesCache = [];
  let clienteSelecionadoId = null;
  let petsCache = [];
  let petEditIdLocal = null;

  function setEditMode(isEdit) {
    formPhone.disabled = isEdit;
    formNome.disabled = isEdit;
    formPetSelect.disabled = isEdit;
    formPrize.disabled = isEdit;
  }

  function mostrarFormAgenda() { formPanel.classList.remove('hidden'); }
  function esconderFormAgenda() { formPanel.classList.add('hidden'); }

  async function fetchBookings() {
    const params = {};
    if (filtroData.value) params.date = filtroData.value;
    if (filtroBusca.value.trim()) params.search = filtroBusca.value.trim();
    const data = await apiGet('/api/bookings', params);
    return data.bookings || [];
  }

  function atualizaEstatisticas(lista) {
    const total = lista.length;
    let tosa = 0, hidratacao = 0, fotoVideo = 0, patinhas = 0;

    lista.forEach(a => {
      switch (a.prize) {
        case 'Tosa Higi√™nica': tosa++; break;
        case 'Hidrata√ß√£o': hidratacao++; break;
        case 'Foto e V√≠deo Profissional': fotoVideo++; break;
        case 'Patinhas impec√°veis': patinhas++; break;
      }
    });

    statTotal.textContent = total;
    statTosa.textContent = tosa;
    statHidratacao.textContent = hidratacao;
    statFotoVideo.textContent = fotoVideo;
    statPatinhas.textContent = patinhas;
  }

  // ===== GR√ÅFICOS =====
  let statusChart = null;
  let prizeChart = null;

  function renderCharts(bookings) {
    const statusCounts = { agendado:0, confirmado:0, recebido:0, em_servico:0, concluido:0, entregue:0, cancelado:0 };
    const prizeCounts = { 'Tosa Higi√™nica':0, 'Hidrata√ß√£o':0, 'Foto e V√≠deo Profissional':0, 'Patinhas impec√°veis':0 };

    bookings.forEach(b => {
      const s = normStr(b.status);
      if (s === 'agendado') statusCounts.agendado++;
      else if (s === 'confirmado') statusCounts.confirmado++;
      else if (s === 'recebido') statusCounts.recebido++;
      else if (s === 'em servico') statusCounts.em_servico++;
      else if (s === 'concluido') statusCounts.concluido++;
      else if (s === 'entregue') statusCounts.entregue++;
      else if (s === 'cancelado') statusCounts.cancelado++;

      const p = b.prize || '';
      if (prizeCounts.hasOwnProperty(p)) prizeCounts[p]++;
    });

    const ctxStatusEl = document.getElementById('chartStatus');
    const ctxPrizesEl = document.getElementById('chartPrizes');
    if (!ctxStatusEl || !ctxPrizesEl) return;

    const ctxStatus = ctxStatusEl.getContext('2d');
    const ctxPrizes = ctxPrizesEl.getContext('2d');

    if (statusChart) statusChart.destroy();
    if (prizeChart) prizeChart.destroy();

    statusChart = new Chart(ctxStatus, {
      type: 'bar',
      data: {
        labels: ['Agendado','Confirmado','Recebido','Em servi√ßo','Conclu√≠do','Entregue','Cancelado'],
        datasets: [{
          label: 'Agendamentos',
          data: [
            statusCounts.agendado,
            statusCounts.confirmado,
            statusCounts.recebido,
            statusCounts.em_servico,
            statusCounts.concluido,
            statusCounts.entregue,
            statusCounts.cancelado
          ]
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { font: { size: 10 } } },
          y: { beginAtZero: true, precision: 0 }
        }
      }
    });

    prizeChart = new Chart(ctxPrizes, {
      type: 'doughnut',
      data: {
        labels: Object.keys(prizeCounts),
        datasets: [{ data: Object.values(prizeCounts) }]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'bottom' } }
      }
    });
  }

  /* ===== PETS no SELECT (Agenda) ===== */
  async function loadPetsForCustomer(customerId) {
    const data = await apiGet('/api/pets', { customer_id: customerId });
    const pets = (data.pets || []);
    formPetSelect.innerHTML = '<option value="">(Sem pet informado)</option>';
    pets.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.breed ? `${p.name} (${p.breed})` : p.name;
      formPetSelect.appendChild(opt);
    });
    return pets;
  }

  function preencherFormEdicao(booking) {
    bookingId.value = booking.id;
    bookingOriginalStatus.value = booking.status || 'agendado';

    formPhone.value = booking.phone || '';
    formNome.value = booking.customer_name || '';
    formPrize.value = booking.prize || 'Tosa Higi√™nica';

    // servi√ßo (prefer√™ncia: service_id)
    const sid = booking.service_id ?? booking.serviceId ?? '';
    if (sid && String(sid) !== 'null') formService.value = String(sid);
    else {
      // fallback: tenta casar pelo texto
      const txt = booking.service || booking.service_title || '';
      const match = servicesCache.find(s => normStr(s.title) === normStr(txt));
      formService.value = match ? String(match.id) : '';
    }

    formDate.value = booking.date || '';
    formTime.value = booking.time || '';
    formStatus.value = booking.status || 'agendado';
    formNotes.value = booking.notes || '';
    formError.style.display = 'none';

    setEditMode(true);

    const customerId = booking.customer_id || booking.customerId;
    const bookingPetId = booking.pet_id ?? booking.petId;
    const bookingPetName = booking.pet_name || booking.petName;

    formPetSelect.innerHTML = '<option value="">(Sem pet informado)</option>';

    if (customerId) {
      loadPetsForCustomer(customerId)
        .then(() => {
          if (bookingPetId != null) formPetSelect.value = String(bookingPetId);
          else formPetSelect.value = '';
          if (bookingPetId == null && bookingPetName) {
            // mant√©m sem pet selecionado; mensagem WhatsApp usa fallback "seu pet"
          }
        })
        .catch(() => {});
    }

    mostrarFormAgenda();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  /* ===== Servi√ßos (cache, dropdown e CRUD) ===== */
  const btnNovoServico = document.getElementById('btnNovoServico');
  const serviceFormPanel = document.getElementById('serviceFormPanel');
  const serviceId = document.getElementById('serviceId');
  const serviceDate = document.getElementById('serviceDate');
  const serviceTitle = document.getElementById('serviceTitle');
  const servicePrice = document.getElementById('servicePrice');
  const serviceError = document.getElementById('serviceError');
  const btnServiceCancel = document.getElementById('btnServiceCancel');
  const btnServiceSave = document.getElementById('btnServiceSave');
  const tbodyServices = document.getElementById('tbodyServices');
  const servicesEmpty = document.getElementById('servicesEmpty');

  let servicesCache = []; // [{id,title,value_cents,...}]

  function showServiceForm() { serviceFormPanel.classList.remove('hidden'); }
  function hideServiceForm() { serviceFormPanel.classList.add('hidden'); }

  function clearServiceForm() {
    serviceId.value = '';
    serviceDate.value = toISODateOnly(new Date());
    serviceTitle.value = '';
    servicePrice.value = '';
    servicePrice.dataset.cents = '';
    serviceError.style.display = 'none';
    serviceError.textContent = '';
  }

  function fillServiceForm(svc) {
    serviceId.value = svc.id;
    serviceDate.value = (svc.date || '').slice(0, 10);
    serviceTitle.value = svc.title || '';
    servicePrice.dataset.cents = String(svc.value_cents ?? '');
    servicePrice.value = svc.value_cents != null ? formatCentsToBRL(svc.value_cents) : '';
    serviceError.style.display = 'none';
    serviceError.textContent = '';
  }

  function renderServices() {
    tbodyServices.innerHTML = '';
    servicesEmpty.style.display = servicesCache.length ? 'none' : 'block';

    servicesCache.forEach(svc => {
      const tr = document.createElement('tr');

      const tdId = document.createElement('td'); tdId.textContent = svc.id;
      const tdDate = document.createElement('td'); tdDate.textContent = formatDataBr((svc.date || '').slice(0,10));
      const tdTitle = document.createElement('td'); tdTitle.textContent = svc.title || '-';
      const tdPrice = document.createElement('td'); tdPrice.textContent = formatCentsToBRL(svc.value_cents || 0);

      const tdCreated = document.createElement('td'); tdCreated.textContent = svc.created_at ? formatDateTimeBr(svc.created_at) : '-';
      const tdUpdated = document.createElement('td'); tdUpdated.textContent = svc.updated_at ? formatDateTimeBr(svc.updated_at) : '-';

      const tdAcoes = document.createElement('td');
      const divActions = document.createElement('div'); divActions.className = 'actions';

      const btnEdit = document.createElement('button');
      btnEdit.textContent = 'Editar';
      btnEdit.className = 'btn btn-small btn-secondary';
      btnEdit.type = 'button';
      btnEdit.addEventListener('click', () => {
        fillServiceForm(svc);
        showServiceForm();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });

      const btnDel = document.createElement('button');
      btnDel.textContent = 'Excluir';
      btnDel.className = 'btn btn-small btn-danger';
      btnDel.type = 'button';
      btnDel.addEventListener('click', async () => {
        if (!confirm('Deseja realmente excluir este servi√ßo?')) return;
        try {
          await apiDelete('/api/services/' + svc.id);
          await loadServices();
          await loadDashboard();
        } catch (e) { alert(e.message); }
      });

      divActions.appendChild(btnEdit);
      divActions.appendChild(btnDel);
      tdAcoes.appendChild(divActions);

      tr.appendChild(tdId);
      tr.appendChild(tdDate);
      tr.appendChild(tdTitle);
      tr.appendChild(tdPrice);
      tr.appendChild(tdCreated);
      tr.appendChild(tdUpdated);
      tr.appendChild(tdAcoes);

      tbodyServices.appendChild(tr);
    });
  }

  function refreshServiceOptionsInAgenda() {
    // mant√©m sele√ß√£o atual se poss√≠vel
    const current = formService.value || '';
    formService.innerHTML = '<option value="">Selecione...</option>';
    servicesCache.forEach(s => {
      const opt = document.createElement('option');
      opt.value = String(s.id);
      opt.textContent = s.title;
      formService.appendChild(opt);
    });
    if (current) formService.value = current;
  }

  async function loadServices() {
    try {
      const data = await apiGet('/api/services');
      servicesCache = data.services || [];
      renderServices();
      refreshServiceOptionsInAgenda();
    } catch (e) {
      servicesCache = [];
      renderServices();
      refreshServiceOptionsInAgenda();
      servicesEmpty.style.display = 'block';
      servicesEmpty.textContent = 'Erro ao carregar servi√ßos: ' + e.message;
    }
  }

  async function saveService() {
    serviceError.style.display = 'none';
    serviceError.textContent = '';

    const id = serviceId.value ? parseInt(serviceId.value, 10) : null;
    const date = serviceDate.value;
    const title = serviceTitle.value.trim();

    // garante dataset.cents sempre atualizado antes de validar
    applyCurrencyMask(servicePrice);
    const value_cents = getCentsFromCurrencyInput(servicePrice);

    if (!date || !title) {
      serviceError.textContent = 'Preencha data e t√≠tulo do servi√ßo.';
      serviceError.style.display = 'block';
      return;
    }
    if (value_cents == null || value_cents < 0) {
      serviceError.textContent = 'Valor inv√°lido. Digite no formato moeda (ex: 85,00).';
      serviceError.style.display = 'block';
      return;
    }

    try {
      const body = { date, title, value_cents };
      if (!id) await apiPost('/api/services', body);
      else await apiPut('/api/services/' + id, body);

      clearServiceForm();
      hideServiceForm();
      await loadServices();
      await loadDashboard();
    } catch (e) {
      serviceError.textContent = e.message;
      serviceError.style.display = 'block';
    }
  }

  if (btnNovoServico) {
    btnNovoServico.addEventListener('click', () => {
      clearServiceForm();
      showServiceForm();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  }
  if (btnServiceCancel) btnServiceCancel.addEventListener('click', () => { clearServiceForm(); hideServiceForm(); });
  if (btnServiceSave) btnServiceSave.addEventListener('click', saveService);

  // M√°scara do valor de servi√ßo
  if (servicePrice) {
    servicePrice.addEventListener('input', () => applyCurrencyMask(servicePrice));
  }

  /* ===== NOVO: Agenda - Toggle Lista/Cards ===== */
  const AGENDA_VIEW_KEY = 'pf_admin_agenda_view';
  let agendaView = 'list';

  function initAgendaViewToggle() {
    try {
      const saved = localStorage.getItem(AGENDA_VIEW_KEY);
      if (saved === 'cards' || saved === 'list') agendaView = saved;
    } catch (_) {}

    applyAgendaViewUI(agendaView);

    if (btnViewList) btnViewList.addEventListener('click', () => setAgendaView('list'));
    if (btnViewCards) btnViewCards.addEventListener('click', () => setAgendaView('cards'));
  }

  function setAgendaView(view) {
    agendaView = (view === 'cards') ? 'cards' : 'list';
    try { localStorage.setItem(AGENDA_VIEW_KEY, agendaView); } catch (_) {}
    applyAgendaViewUI(agendaView);
    renderAgendaByView(ultimaLista || []);
  }

  function applyAgendaViewUI(view) {
    if (!agendaListWrapper || !agendaCardsWrapper) return;

    const isCards = (view === 'cards');

    agendaListWrapper.classList.toggle('hidden', isCards);
    agendaCardsWrapper.classList.toggle('hidden', !isCards);

    if (btnViewList) btnViewList.classList.toggle('active', !isCards);
    if (btnViewCards) btnViewCards.classList.toggle('active', isCards);
  }

  function getServiceLabelFromBooking(a) {
    let serviceLabel = a.service || a.service_title || '-';
    const sid = a.service_id ?? a.serviceId ?? null;

    if (sid != null) {
      const svc = servicesCache.find(s => String(s.id) === String(sid));
      if (svc) serviceLabel = svc.title;
    } else {
      const match = servicesCache.find(s => normStr(s.title) === normStr(serviceLabel));
      if (match) serviceLabel = match.title;
    }
    return serviceLabel;
  }

  function renderAgendaByView(lista) {
    // vazio: atualiza ambos estados para evitar inconsist√™ncias
    const isEmpty = !lista || !lista.length;

    if (agendaView === 'cards') {
      renderAgendaCards(lista || []);
      if (estadoVazio) estadoVazio.style.display = 'none';
      if (estadoVazioCards) estadoVazioCards.classList.toggle('hidden', !isEmpty);
    } else {
      renderAgendaList(lista || []);
      if (estadoVazioCards) estadoVazioCards.classList.add('hidden');
      if (estadoVazio) estadoVazio.style.display = isEmpty ? 'block' : 'none';
    }
  }

  function renderAgendaList(lista) {
    tbodyAgenda.innerHTML = '';
    estadoVazio.style.display = lista.length ? 'none' : 'block';

    lista.forEach(a => {
      const tr = document.createElement('tr');

      const tdData = document.createElement('td'); tdData.textContent = formatDataBr(a.date);
      const tdHora = document.createElement('td'); tdHora.textContent = a.time || '-';
      const tdTutor = document.createElement('td'); tdTutor.textContent = a.customer_name || '-';
      const tdPet = document.createElement('td'); tdPet.textContent = a.pet_name || '-';
      const tdTel = document.createElement('td'); tdTel.textContent = formatTelefone(a.phone);

      const tdServ = document.createElement('td'); tdServ.textContent = getServiceLabelFromBooking(a);

      const tdMimo = document.createElement('td');
      tdMimo.textContent = a.prize || '-';
      tdMimo.className = 'td-mimo';

      const tdStatus = document.createElement('td');
      const spanStatus = document.createElement('span');
      const labelStatus = (a.status || 'agendado');
      spanStatus.textContent = labelStatus;
      spanStatus.className = 'td-status ' + classStatus(labelStatus);
      tdStatus.appendChild(spanStatus);

      const tdNotif = document.createElement('td');
      tdNotif.textContent = a.last_notification_at ? formatDateTimeBr(a.last_notification_at) : '-';

      const tdObs = document.createElement('td');
      tdObs.textContent = a.notes || '';
      tdObs.className = 'td-obs';

      const tdAcoes = document.createElement('td');
      const divActions = document.createElement('div');
      divActions.className = 'actions';

      const btnEditar = document.createElement('button');
      btnEditar.textContent = 'Editar';
      btnEditar.className = 'btn btn-small btn-secondary';
      btnEditar.type = 'button';
      btnEditar.addEventListener('click', () => preencherFormEdicao(a));

      const btnExcluir = document.createElement('button');
      btnExcluir.textContent = 'Excluir';
      btnExcluir.className = 'btn btn-small btn-danger';
      btnExcluir.type = 'button';
      btnExcluir.addEventListener('click', async () => {
        if (!confirm('Deseja realmente excluir este agendamento?')) return;
        try {
          await apiDelete('/api/bookings/' + a.id);
          await renderTabela();
          await loadDashboard();
        } catch (e) { alert(e.message); }
      });

      divActions.appendChild(btnEditar);
      divActions.appendChild(btnExcluir);
      tdAcoes.appendChild(divActions);

      tr.appendChild(tdData);
      tr.appendChild(tdHora);
      tr.appendChild(tdTutor);
      tr.appendChild(tdPet);
      tr.appendChild(tdTel);
      tr.appendChild(tdServ);
      tr.appendChild(tdMimo);
      tr.appendChild(tdStatus);
      tr.appendChild(tdNotif);
      tr.appendChild(tdObs);
      tr.appendChild(tdAcoes);

      tbodyAgenda.appendChild(tr);
    });
  }

  function renderAgendaCards(lista) {
    if (!agendaCards) return;

    agendaCards.innerHTML = '';
    const isEmpty = !lista.length;
    if (estadoVazioCards) estadoVazioCards.classList.toggle('hidden', !isEmpty);

    lista.forEach(a => {
      const card = document.createElement('div');
      card.className = 'agenda-card';

      const top = document.createElement('div');
      top.className = 'agenda-card-top';

      const left = document.createElement('div');
      const timeWrap = document.createElement('div');
      timeWrap.className = 'agenda-card-time';
      timeWrap.textContent = `‚è∞ ${a.time || '-'}`;

      const dateWrap = document.createElement('div');
      dateWrap.className = 'agenda-card-date';
      dateWrap.textContent = `üìÖ ${formatDataBr(a.date)}`;

      left.appendChild(timeWrap);
      left.appendChild(dateWrap);

      const statusWrap = document.createElement('div');
      const spanStatus = document.createElement('span');
      const labelStatus = (a.status || 'agendado');
      spanStatus.textContent = labelStatus;
      spanStatus.className = 'td-status ' + classStatus(labelStatus);
      statusWrap.appendChild(spanStatus);

      top.appendChild(left);
      top.appendChild(statusWrap);

      const main = document.createElement('div');
      main.className = 'agenda-card-main';

      const serviceLabel = getServiceLabelFromBooking(a);

      const l1 = document.createElement('div');
      l1.className = 'agenda-line';
      l1.innerHTML = `<span class="agenda-key">Tutor:</span> <span class="agenda-val">${(a.customer_name || '-')}</span>`;

      const l2 = document.createElement('div');
      l2.className = 'agenda-line';
      l2.innerHTML = `<span class="agenda-key">Pet:</span> <span class="agenda-muted">${(a.pet_name || '-')}</span>`;

      const l3 = document.createElement('div');
      l3.className = 'agenda-line';
      l3.innerHTML = `<span class="agenda-key">Tel:</span> <span class="agenda-muted">${formatTelefone(a.phone)}</span>`;

      const l4 = document.createElement('div');
      l4.className = 'agenda-line';
      l4.innerHTML = `<span class="agenda-key">Servi√ßo:</span> <span class="agenda-val">${serviceLabel}</span>`;

      const l5 = document.createElement('div');
      l5.className = 'agenda-line';
      l5.innerHTML = `<span class="agenda-key">Mimo:</span> <span class="agenda-val" style="color:var(--turquesa)">${(a.prize || '-')}</span>`;

      const l6 = document.createElement('div');
      l6.className = 'agenda-line';
      l6.innerHTML = `<span class="agenda-key">Notif:</span> <span class="agenda-muted">${a.last_notification_at ? formatDateTimeBr(a.last_notification_at) : '-'}</span>`;

      main.appendChild(l1);
      main.appendChild(l2);
      main.appendChild(l3);
      main.appendChild(l4);
      main.appendChild(l5);
      main.appendChild(l6);

      const notes = document.createElement('div');
      notes.className = 'agenda-card-notes';
      notes.textContent = (a.notes || '').trim() ? a.notes : 'Sem observa√ß√µes.';

      const bottom = document.createElement('div');
      bottom.className = 'agenda-card-bottom';

      const actions = document.createElement('div');
      actions.className = 'actions';

      const btnEditar = document.createElement('button');
      btnEditar.textContent = 'Editar';
      btnEditar.className = 'btn btn-small btn-secondary';
      btnEditar.type = 'button';
      btnEditar.addEventListener('click', () => preencherFormEdicao(a));

      const btnExcluir = document.createElement('button');
      btnExcluir.textContent = 'Excluir';
      btnExcluir.className = 'btn btn-small btn-danger';
      btnExcluir.type = 'button';
      btnExcluir.addEventListener('click', async () => {
        if (!confirm('Deseja realmente excluir este agendamento?')) return;
        try {
          await apiDelete('/api/bookings/' + a.id);
          await renderTabela();
          await loadDashboard();
        } catch (e) { alert(e.message); }
      });

      actions.appendChild(btnEditar);
      actions.appendChild(btnExcluir);

      bottom.appendChild(actions);

      card.appendChild(top);
      card.appendChild(main);
      card.appendChild(notes);
      card.appendChild(bottom);

      agendaCards.appendChild(card);
    });
  }

  /* ===== Agenda: render e salvar ===== */
  async function renderTabela() {
    try {
      const lista = await fetchBookings();
      ultimaLista = lista;

      // renderiza conforme view selecionada
      renderAgendaByView(lista);
      atualizaEstatisticas(lista);
    } catch (e) {
      // zera listagem e cards
      ultimaLista = [];
      tbodyAgenda.innerHTML = '';
      if (agendaCards) agendaCards.innerHTML = '';

      if (estadoVazio) {
        estadoVazio.style.display = 'block';
        estadoVazio.textContent = 'Erro ao carregar agendamentos: ' + e.message;
      }
      if (estadoVazioCards) {
        estadoVazioCards.classList.remove('hidden');
        estadoVazioCards.textContent = 'Erro ao carregar agendamentos: ' + e.message;
      }

      statTotal.textContent = '0';
      statTosa.textContent = '0';
      statHidratacao.textContent = '0';
      statFotoVideo.textContent = '0';
      statPatinhas.textContent = '0';
    }
  }

  function limparForm() {
    bookingId.value = '';
    bookingOriginalStatus.value = 'agendado';
    formPhone.value = '';
    formNome.value = '';
    formPetSelect.innerHTML = '<option value="">(Sem pet informado)</option>';
    formPrize.value = 'Tosa Higi√™nica';
    formService.value = '';
    formDate.value = '';
    formTime.value = '';
    formStatus.value = 'agendado';
    formNotes.value = '';
    formError.style.display = 'none';
    formError.textContent = '';
    setEditMode(false);
  }

  async function salvarAgendamento() {
    formError.style.display = 'none';
    formError.textContent = '';

    const id = bookingId.value || null;
    const originalStatus = bookingOriginalStatus.value || 'agendado';

    const rawPhone = formPhone.value.trim();
    const phone = sanitizePhone(rawPhone);
    const nome = formNome.value.trim();

    const petIdRaw = formPetSelect.value;
    const petIdNum = petIdRaw ? parseInt(petIdRaw, 10) : null;

    const prize = formPrize.value;

    // servi√ßo selecionado do banco (id)
    const serviceIdSelected = formService.value ? parseInt(formService.value, 10) : null;
    const serviceObj = serviceIdSelected ? servicesCache.find(s => String(s.id) === String(serviceIdSelected)) : null;
    const serviceTitleSelected = serviceObj ? serviceObj.title : '';

    const date = formDate.value;
    const time = formTime.value;
    const status = formStatus.value;
    const notes = formNotes.value.trim();

    if (!date || !time || !prize || !serviceIdSelected) {
      formError.textContent = 'Data, hor√°rio, servi√ßo e mimo s√£o obrigat√≥rios.';
      formError.style.display = 'block';
      return;
    }
    if (!phone || phone.length < 10 || !nome) {
      formError.textContent = 'Preencha telefone (com DDD) e nome do tutor.';
      formError.style.display = 'block';
      return;
    }

    try {
      let customer;
      try {
        const lookup = await apiPost('/api/customers/lookup', { phone });
        if (lookup.exists && lookup.customer) customer = lookup.customer;
      } catch (_) {}

      if (!customer) {
        const cRes = await apiPost('/api/customers', { phone, name: nome });
        customer = cRes.customer;
      }

      const body = {
        customer_id: customer.id,
        pet_id: petIdNum,
        date, time,
        // envia os dois: id (correto) + t√≠tulo (compatibilidade)
        service_id: serviceIdSelected,
        service: serviceTitleSelected,
        prize, notes, status
      };

      let precisaWhats = false;
      let urlWhats = null;

      if (id && normStr(status) !== normStr(originalStatus)) {
        const dataBR = formatDataBr(date);
        const petLabel = petIdNum
          ? (formPetSelect.options[formPetSelect.selectedIndex]?.textContent || 'seu pet')
          : 'seu pet';

        const msg = buildStatusMessage(status, nome, petLabel, serviceTitleSelected, dataBR, time, prize);

        let fullPhone = phone;
        if (!(fullPhone.startsWith('55') && fullPhone.length > 11)) fullPhone = '55' + fullPhone;

        urlWhats = `https://wa.me/${fullPhone}?text=${encodeURIComponent(msg)}`;
        precisaWhats = true;

        body.last_notification_at = new Date().toISOString();
      }

      if (!id) await apiPost('/api/bookings', body);
      else await apiPut('/api/bookings/' + id, body);

      if (precisaWhats && urlWhats) window.open(urlWhats, '_blank');

      limparForm();
      esconderFormAgenda();
      await renderTabela();
      await loadDashboard();
    } catch (e) {
      formError.textContent = e.message;
      formError.style.display = 'block';
    }
  }

  function exportarCSV() {
    if (!ultimaLista.length) {
      alert('N√£o h√° agendamentos para exportar no filtro atual.');
      return;
    }

    const linhas = [];
    linhas.push(['ID','Data','Hora','Tutor','Pet','Telefone','Servi√ßo','Mimo','Status','√öltima Notifica√ß√£o','Observa√ß√µes'].join(';'));

    ultimaLista.forEach(a => {
      const serviceLabel = getServiceLabelFromBooking(a);

      const cols = [
        a.id,
        formatDataBr(a.date),
        a.time || '',
        (a.customer_name || '').replace(/;/g, ','),
        (a.pet_name || '').replace(/;/g, ','),
        formatTelefone(a.phone),
        (serviceLabel || '').replace(/;/g, ','),
        (a.prize || '').replace(/;/g, ','),
        (a.status || 'agendado'),
        a.last_notification_at ? formatDateTimeBr(a.last_notification_at) : '',
        (a.notes || '').replace(/[\r\n]+/g, ' ').replace(/;/g, ',')
      ];
      linhas.push(cols.join(';'));
    });

    const csv = linhas.join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;

    const hoje = new Date();
    const ano = hoje.getFullYear();
    const mes = String(hoje.getMonth() + 1).padStart(2, '0');
    const dia = String(hoje.getDate()).padStart(2, '0');
    a.download = `agenda_petfunny_${ano}-${mes}-${dia}.csv`;

    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  filtroData.addEventListener('change', async () => { await renderTabela(); await loadDashboard(); });

  filtroBusca.addEventListener('input', () => {
    clearTimeout(window.__filtroTimer);
    window.__filtroTimer = setTimeout(async () => {
      await renderTabela();
      await loadDashboard();
    }, 150);
  });

  btnHoje.addEventListener('click', async () => {
    filtroData.value = toISODateOnly(new Date());
    await renderTabela();
    await loadDashboard();
  });

  btnLimparFiltro.addEventListener('click', async () => {
    filtroData.value = '';
    filtroBusca.value = '';
    await renderTabela();
    await loadDashboard();
  });

  btnExportarCSV.addEventListener('click', exportarCSV);
  btnSalvar.addEventListener('click', salvarAgendamento);
  btnCancelarEdicao.addEventListener('click', () => { limparForm(); esconderFormAgenda(); });

  if (dashPeriod) {
    dashPeriod.addEventListener('change', () => {
      const val = dashPeriod.value;
      if (val === 'custom') dashCustomRange.classList.remove('hidden');
      else { dashCustomRange.classList.add('hidden'); loadDashboard(); }
    });
  }
  if (dashApply) dashApply.addEventListener('click', (e) => { e.preventDefault(); loadDashboard(); });

  btnNovoAgendamento.addEventListener('click', () => {
    limparForm();
    formDate.value = toISODateOnly(new Date());
    mostrarFormAgenda();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  formPhone.addEventListener('input', () => applyPhoneMask(formPhone));

  formPhone.addEventListener('blur', async () => {
    const phoneDigits = sanitizePhone(formPhone.value.trim());
    if (!phoneDigits) return;
    try {
      const lookup = await apiPost('/api/customers/lookup', { phone: phoneDigits });
      if (lookup.exists && lookup.customer) {
        formNome.value = lookup.customer.name || '';
        await loadPetsForCustomer(lookup.customer.id);
      }
    } catch (_) {}
  });

  // ===== CLIENTES & PETS =====
  const cliPhone = document.getElementById('cliPhone');
  const cliName = document.getElementById('cliName');
  const cliError = document.getElementById('cliError');
  const btnCliLimpar = document.getElementById('btnCliLimpar');
  const btnCliSalvar = document.getElementById('btnCliSalvar');
  const tbodyClientes = document.getElementById('tbodyClientes');

  const clienteFormBlock = document.getElementById('clienteFormBlock');
  const btnNovoCliente = document.getElementById('btnNovoCliente');

  const petName = document.getElementById('petName');
  const petBreed = document.getElementById('petBreed');
  const petInfo = document.getElementById('petInfo');
  const petError = document.getElementById('petError');
  const btnPetLimpar = document.getElementById('btnPetLimpar');
  const btnPetSalvar = document.getElementById('btnPetSalvar');
  const btnNovoPet = document.getElementById('btnNovoPet');
  const tbodyPets = document.getElementById('tbodyPets');
  const badgeClienteSelecionado = document.getElementById('badgeClienteSelecionado');
  const petsCard = document.getElementById('petsCard');

  const racas = [
    'SRD (Sem Ra√ßa Definida)','Poodle','Shih Tzu','Lhasa Apso','Labrador Retriever','Golden Retriever',
    'Yorkshire Terrier','Bulldog Franc√™s','Bulldog Ingl√™s','Spitz Alem√£o (Lulu da Pomer√¢nia)','Beagle',
    'Border Collie','Boxer','Dachshund (Salsicha)','Malt√™s','Pinscher','Pastor Alem√£o','Rottweiler',
    'Pitbull','Pug','Cocker Spaniel','Schnauzer','Husky Siberiano','Akita','Chihuahua','Outro (informar nas observa√ß√µes)'
  ];

  cliPhone.addEventListener('input', () => applyPhoneMask(cliPhone));

  racas.forEach(r => {
    const opt = document.createElement('option');
    opt.value = r;
    opt.textContent = r;
    petBreed.appendChild(opt);
  });

  async function loadClientes() {
    const data = await apiGet('/api/customers');
    clientesCache = data.customers || [];
    renderClientes();
  }

  function renderClientes() {
    tbodyClientes.innerHTML = '';
    clientesCache.forEach(c => {
      const tr = document.createElement('tr');

      const tdId = document.createElement('td'); tdId.textContent = c.id;
      const tdNome = document.createElement('td'); tdNome.textContent = c.name || '-';
      const tdTel = document.createElement('td'); tdTel.textContent = formatTelefone(c.phone);
      const tdPetsCount = document.createElement('td');
      tdPetsCount.innerHTML = c.pets_count ? `<span class="badge-mini">${c.pets_count} pet(s)</span>` : '-';

      const tdAcoes = document.createElement('td');
      const divActions = document.createElement('div'); divActions.className = 'actions';

      const btnSel = document.createElement('button');
      btnSel.textContent = 'Selecionar';
      btnSel.className = 'btn btn-small btn-secondary';
      btnSel.type = 'button';
      btnSel.addEventListener('click', async () => {
        clienteSelecionadoId = c.id;

        badgeClienteSelecionado.classList.remove('hidden');
        clienteFormBlock.classList.remove('hidden');
        petsCard.classList.remove('hidden');

        cliPhone.value = formatTelefone(c.phone);
        cliName.value = c.name || '';

        limparPetsForm();
        await loadPetsForClienteTab(c.id);
      });

      const btnDel = document.createElement('button');
      btnDel.textContent = 'Excluir';
      btnDel.className = 'btn btn-small btn-danger';
      btnDel.type = 'button';
      btnDel.addEventListener('click', async () => {
        if (!confirm('Excluir este cliente? (Os pets relacionados tamb√©m poder√£o ser afetados)')) return;
        try {
          await apiDelete('/api/customers/' + c.id);
          if (clienteSelecionadoId === c.id) {
            clienteSelecionadoId = null;
            badgeClienteSelecionado.classList.add('hidden');
            petsCard.classList.add('hidden');
            limparClienteForm();
            limparPetsForm();
            tbodyPets.innerHTML = '';
          }
          await loadClientes();
          await loadDashboard();
        } catch (e) { alert(e.message); }
      });

      divActions.appendChild(btnSel);
      divActions.appendChild(btnDel);
      tdAcoes.appendChild(divActions);

      tr.appendChild(tdId);
      tr.appendChild(tdNome);
      tr.appendChild(tdTel);
      tr.appendChild(tdPetsCount);
      tr.appendChild(tdAcoes);

      tbodyClientes.appendChild(tr);
    });
  }

  function limparClienteForm() {
    cliPhone.value = '';
    cliName.value = '';
    cliError.style.display = 'none';

    clienteSelecionadoId = null;
    badgeClienteSelecionado.classList.add('hidden');

    clienteFormBlock.classList.add('hidden');
    petsCard.classList.add('hidden');

    tbodyPets.innerHTML = '';
    limparPetsForm();
  }

  async function salvarCliente() {
    cliError.style.display = 'none';
    const phoneDigits = sanitizePhone(cliPhone.value.trim());
    const name = cliName.value.trim();

    if (!phoneDigits || phoneDigits.length < 10 || !name) {
      cliError.textContent = 'Preencha telefone (com DDD) e nome do tutor.';
      cliError.style.display = 'block';
      return;
    }

    try {
      const data = await apiPost('/api/customers', { phone: phoneDigits, name });
      clienteSelecionadoId = data.customer.id;
      badgeClienteSelecionado.classList.remove('hidden');
      petsCard.classList.remove('hidden');
      await loadClientes();
      await loadPetsForClienteTab(clienteSelecionadoId);
      await loadDashboard();
    } catch (e) {
      cliError.textContent = e.message;
      cliError.style.display = 'block';
    }
  }

  async function loadPetsForClienteTab(customerId) {
    const data = await apiGet('/api/pets', { customer_id: customerId });
    petsCache = data.pets || [];
    renderPets();
  }

  function renderPets() {
    tbodyPets.innerHTML = '';
    petsCache.forEach(p => {
      const tr = document.createElement('tr');

      const tdId = document.createElement('td'); tdId.textContent = p.id;
      const tdNome = document.createElement('td'); tdNome.textContent = p.name;
      const tdRaca = document.createElement('td'); tdRaca.textContent = p.breed || '-';
      const tdInfo = document.createElement('td'); tdInfo.textContent = p.info || '-';

      const tdAcoes = document.createElement('td');
      const divActions = document.createElement('div'); divActions.className = 'actions';

      const btnEdit = document.createElement('button');
      btnEdit.textContent = 'Editar';
      btnEdit.className = 'btn btn-small btn-secondary';
      btnEdit.type = 'button';
      btnEdit.addEventListener('click', () => {
        petEditIdLocal = p.id;
        petName.value = p.name;
        petBreed.value = p.breed || 'SRD (Sem Ra√ßa Definida)';
        petInfo.value = p.info || '';
      });

      const btnDel = document.createElement('button');
      btnDel.textContent = 'Excluir';
      btnDel.className = 'btn btn-small btn-danger';
      btnDel.type = 'button';
      btnDel.addEventListener('click', async () => {
        if (!confirm('Excluir este pet?')) return;
        try {
          await apiDelete('/api/pets/' + p.id);
          await loadPetsForClienteTab(clienteSelecionadoId);
          await loadClientes();
          await loadDashboard();
        } catch (e) { alert(e.message); }
      });

      divActions.appendChild(btnEdit);
      divActions.appendChild(btnDel);
      tdAcoes.appendChild(divActions);

      tr.appendChild(tdId);
      tr.appendChild(tdNome);
      tr.appendChild(tdRaca);
      tr.appendChild(tdInfo);
      tr.appendChild(tdAcoes);

      tbodyPets.appendChild(tr);
    });
  }

  function limparPetsForm() {
    petEditIdLocal = null;
    petName.value = '';
    petBreed.value = 'SRD (Sem Ra√ßa Definida)';
    petInfo.value = '';
    petError.style.display = 'none';
  }

  async function salvarPet() {
    petError.style.display = 'none';
    if (!clienteSelecionadoId) {
      petError.textContent = 'Selecione um cliente na lista ao lado antes de cadastrar o pet.';
      petError.style.display = 'block';
      return;
    }

    const name = petName.value.trim();
    const breed = petBreed.value;
    const info = petInfo.value.trim();

    if (!name || !breed) {
      petError.textContent = 'Informe nome e ra√ßa do pet.';
      petError.style.display = 'block';
      return;
    }

    try {
      if (!petEditIdLocal) {
        await apiPost('/api/pets', { customer_id: clienteSelecionadoId, name, breed, info });
      } else {
        await apiPut('/api/pets/' + petEditIdLocal, { name, breed, info });
      }
      limparPetsForm();
      await loadPetsForClienteTab(clienteSelecionadoId);
      await loadClientes();
      await loadDashboard();
    } catch (e) {
      petError.textContent = e.message;
      petError.style.display = 'block';
    }
  }

  btnCliLimpar.addEventListener('click', limparClienteForm);
  btnCliSalvar.addEventListener('click', salvarCliente);

  btnPetLimpar.addEventListener('click', limparPetsForm);
  btnPetSalvar.addEventListener('click', salvarPet);

  btnNovoPet.addEventListener('click', () => limparPetsForm);

  btnNovoCliente.addEventListener('click', () => {
    clienteSelecionadoId = null;
    badgeClienteSelecionado.classList.add('hidden');

    cliPhone.value = '';
    cliName.value = '';
    cliError.style.display = 'none';
    clienteFormBlock.classList.remove('hidden');

    petsCard.classList.add('hidden');
    tbodyPets.innerHTML = '';
    limparPetsForm();
  });

  if (dashPeriod && dashPeriod.value === 'custom') dashCustomRange.classList.remove('hidden');

  /* ===== DASHBOARD: inclui financeiro por servi√ßo ===== */
  async function loadDashboard() {
    let period = dashPeriod ? dashPeriod.value : 'today';
    let { start, end } = getPeriodRange(period);

    if (period === 'custom') {
      start = dashStart.value || null;
      end = dashEnd.value || null;
      if (!start || !end) return;
    }

    let bookings = [];
    let totalCustomers = 0;

    try {
      const data = await apiGet('/api/bookings');
      bookings = data.bookings || [];
    } catch (e) {
      console.error('Erro ao carregar bookings para dashboard:', e);
      bookings = [];
    }

    // aplica range por date (YYYY-MM-DD)
    if (start || end) {
      bookings = bookings.filter(b => {
        const d = b.date;
        if (!d) return false;
        if (start && d < start) return false;
        if (end && d > end) return false;
        return true;
      });
    }

    try {
      const cData = await apiGet('/api/customers');
      totalCustomers = (cData.customers || []).length;
    } catch (e) {
      console.error('Erro ao carregar customers para dashboard:', e);
      totalCustomers = 0;
    }

    const uniqueCustomersSet = new Set();
    bookings.forEach(b => {
      const cid = b.customer_id || b.customerId;
      if (cid != null) uniqueCustomersSet.add(cid);
    });

    dashTotalBookings.textContent = bookings.length;
    dashUniqueCustomers.textContent = uniqueCustomersSet.size;
    dashTotalCustomers.textContent = totalCustomers;

    const statusCounts = { agendado:0, confirmado:0, recebido:0, em_servico:0, concluido:0, entregue:0, cancelado:0 };
    const prizeCounts = { 'Tosa Higi√™nica':0, 'Hidrata√ß√£o':0, 'Foto e V√≠deo Profissional':0, 'Patinhas impec√°veis':0 };

    bookings.forEach(b => {
      const s = normStr(b.status);
      if (s === 'agendado') statusCounts.agendado++;
      else if (s === 'confirmado') statusCounts.confirmado++;
      else if (s === 'recebido') statusCounts.recebido++;
      else if (s === 'em servico') statusCounts.em_servico++;
      else if (s === 'concluido') statusCounts.concluido++;
      else if (s === 'entregue') statusCounts.entregue++;
      else if (s === 'cancelado') statusCounts.cancelado++;

      const p = b.prize || '';
      if (prizeCounts.hasOwnProperty(p)) prizeCounts[p]++;
    });

    dashStatusAgendado.textContent = statusCounts.agendado;
    dashStatusConfirmado.textContent = statusCounts.confirmado;
    dashStatusRecebido.textContent = statusCounts.recebido;
    dashStatusEmServico.textContent = statusCounts.em_servico;
    dashStatusConcluido.textContent = statusCounts.concluido;
    dashStatusEntregue.textContent = statusCounts.entregue;
    dashStatusCancelado.textContent = statusCounts.cancelado;

    dashPrizeTosa.textContent = prizeCounts['Tosa Higi√™nica'];
    dashPrizeHidratacao.textContent = prizeCounts['Hidrata√ß√£o'];
    dashPrizeFotoVideo.textContent = prizeCounts['Foto e V√≠deo Profissional'];
    dashPrizePatinhas.textContent = prizeCounts['Patinhas impec√°veis'];

    // financeiro por servi√ßo
    const usage = new Map(); // serviceId -> {title, qty, value_cents}
    let revenueCents = 0;

    bookings.forEach(b => {
      // determinar serviceId
      let sid = b.service_id ?? b.serviceId ?? null;
      if (sid == null) {
        const txt = b.service || b.service_title || '';
        const match = servicesCache.find(s => normStr(s.title) === normStr(txt));
        sid = match ? match.id : null;
      }

      if (sid == null) return;

      const svc = servicesCache.find(s => String(s.id) === String(sid));
      if (!svc) return;

      const key = String(svc.id);
      if (!usage.has(key)) usage.set(key, { title: svc.title, qty: 0, value_cents: Number(svc.value_cents || 0) });
      const row = usage.get(key);
      row.qty += 1;
      const add = row.value_cents;
      revenueCents += add;
    });

    dashRevenue.textContent = formatCentsToBRL(revenueCents);
    const avg = bookings.length ? Math.round(revenueCents / bookings.length) : 0;
    dashAvgTicket.textContent = formatCentsToBRL(avg);

    tbodyDashServices.innerHTML = '';
    const rows = Array.from(usage.values())
      .map(r => ({...r, total_cents: r.qty * r.value_cents}))
      .sort((a,b) => b.total_cents - a.total_cents);

    dashServicesEmpty.style.display = rows.length ? 'none' : 'block';

    rows.forEach(r => {
      const tr = document.createElement('tr');
      const tdTitle = document.createElement('td'); tdTitle.textContent = r.title;
      const tdQty = document.createElement('td'); tdQty.textContent = String(r.qty);
      const tdPrice = document.createElement('td'); tdPrice.textContent = formatCentsToBRL(r.value_cents);
      const tdTotal = document.createElement('td'); tdTotal.textContent = formatCentsToBRL(r.total_cents);
      tr.appendChild(tdTitle);
      tr.appendChild(tdQty);
      tr.appendChild(tdPrice);
      tr.appendChild(tdTotal);
      tbodyDashServices.appendChild(tr);
    });

    renderCharts(bookings);
  }

  
  /* ===== HOR√ÅRIO DE FUNCIONAMENTO ===== */
  const btnHoursReload = document.getElementById('btnHoursReload');
  const btnHoursSave = document.getElementById('btnHoursSave');
  const tbodyHours = document.getElementById('tbodyHours');
  const hoursError = document.getElementById('hoursError');

  const DOW_LABELS = ['Domingo','Segunda','Ter√ßa','Quarta','Quinta','Sexta','S√°bado'];

  let openingHoursCache = []; // [{day_of_week,is_closed,open_time,close_time,capacity_per_slot}]

  function showHoursError(msg) {
    if (!hoursError) return;
    hoursError.textContent = msg || '';
    hoursError.style.display = msg ? 'block' : 'none';
  }

  function renderOpeningHours() {
    if (!tbodyHours) return;
    tbodyHours.innerHTML = '';

    // garante 0..6
    const map = new Map();
    (openingHoursCache || []).forEach(r => map.set(Number(r.day_of_week), r));

    for (let d=0; d<=6; d++) {
      const r = map.get(d) || { day_of_week:d, is_closed:(d===0), open_time:null, close_time:null, capacity_per_slot:1 };

      const tr = document.createElement('tr');

      const tdDay = document.createElement('td');
      tdDay.textContent = DOW_LABELS[d];

      const tdClosed = document.createElement('td');
      const chk = document.createElement('input');
      chk.type = 'checkbox';
      chk.checked = !!r.is_closed;
      chk.dataset.dow = String(d);
      chk.addEventListener('change', () => {
        const row = map.get(d) || r;
        row.is_closed = chk.checked;
        map.set(d, row);
        // re-render linha para habilitar/desabilitar campos
        openingHoursCache = Array.from(map.values());
        renderOpeningHours();
      });
      tdClosed.appendChild(chk);

      const tdOpen = document.createElement('td');
      const inpOpen = document.createElement('input');
      inpOpen.type = 'time';
      inpOpen.step = 1800; // 30 min
      inpOpen.value = r.open_time ? String(r.open_time).slice(0,5) : '07:30';
      inpOpen.disabled = !!r.is_closed;
      inpOpen.dataset.dow = String(d);
      tdOpen.appendChild(inpOpen);

      const tdClose = document.createElement('td');
      const inpClose = document.createElement('input');
      inpClose.type = 'time';
      inpClose.step = 1800; // 30 min
      inpClose.value = r.close_time ? String(r.close_time).slice(0,5) : (d===6 ? '13:00' : '17:30');
      inpClose.disabled = !!r.is_closed;
      inpClose.dataset.dow = String(d);
      tdClose.appendChild(inpClose);

      const tdCap = document.createElement('td');
      const inpCap = document.createElement('input');
      inpCap.type = 'number';
      inpCap.min = '1';
      inpCap.step = '1';
      inpCap.value = String(r.capacity_per_slot ?? 1);
      inpCap.style.maxWidth = '140px';
      inpCap.disabled = !!r.is_closed;
      inpCap.dataset.dow = String(d);
      tdCap.appendChild(inpCap);

      tr.appendChild(tdDay);
      tr.appendChild(tdClosed);
      tr.appendChild(tdOpen);
      tr.appendChild(tdClose);
      tr.appendChild(tdCap);

      tbodyHours.appendChild(tr);

      // atualiza cache com valores default caso faltassem
      map.set(d, { ...r, open_time: inpOpen.value, close_time: inpClose.value, capacity_per_slot: Number(inpCap.value||1) });
    }

    openingHoursCache = Array.from(map.values()).sort((a,b) => a.day_of_week - b.day_of_week);
  }

  async function loadOpeningHours() {
    showHoursError('');
    try {
      const data = await apiGet('/api/opening-hours');
      openingHoursCache = data.opening_hours || [];
      renderOpeningHours();
    } catch (e) {
      openingHoursCache = [];
      renderOpeningHours();
      showHoursError('Erro ao carregar hor√°rio de funcionamento: ' + e.message);
    }
  }

  async function saveOpeningHours() {
    showHoursError('');
    try {
      // ler valores diretamente do DOM (garante estado atual)
      const rows = [];
      for (let d=0; d<=6; d++) {
        const tr = tbodyHours.children[d];
        const chk = tr.querySelector('input[type="checkbox"]');
        const times = tr.querySelectorAll('input[type="time"]');
        const cap = tr.querySelector('input[type="number"]');

        const is_closed = !!chk.checked;
        const open_time = times[0].value;
        const close_time = times[1].value;
        const capacity_per_slot = Number(cap.value || 1);

        if (!is_closed) {
          if (!open_time || !close_time || open_time >= close_time) {
            showHoursError('Verifique abertura/fechamento em ' + DOW_LABELS[d] + '.');
            return;
          }
          // garante slots de 30 min (00 ou 30)
          const ok = (t) => { const m = t.split(':')[1]; return m === '00' || m === '30'; };
          if (!ok(open_time) || !ok(close_time)) {
            showHoursError('Hor√°rios devem ser de 30 em 30 minutos (00 ou 30) em ' + DOW_LABELS[d] + '.');
            return;
          }
          if (!Number.isFinite(capacity_per_slot) || capacity_per_slot < 1) {
            showHoursError('Capacidade deve ser >= 1 em ' + DOW_LABELS[d] + '.');
            return;
          }
        }

        rows.push({ day_of_week:d, is_closed, open_time: is_closed ? null : open_time, close_time: is_closed ? null : close_time, capacity_per_slot: is_closed ? 1 : capacity_per_slot });
      }

      const data = await apiPut('/api/opening-hours', { opening_hours: rows });
      openingHoursCache = data.opening_hours || [];
      renderOpeningHours();
      alert('Hor√°rio de funcionamento salvo com sucesso.');
    } catch (e) {
      showHoursError(e.message);
    }
  }

  if (btnHoursReload) btnHoursReload.addEventListener('click', loadOpeningHours);
  if (btnHoursSave) btnHoursSave.addEventListener('click', saveOpeningHours);


  // ===== In√≠cio =====
  tryAutoLogin();
</script>
</body>
</html>
