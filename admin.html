<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Admin ‚Äì Pet Funny</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --turquesa: #01ADB7;
      --coral: #F9A197;
      --escuro: #222222;
      --cinza-claro: #f4f4f4;
      --branco: #ffffff;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: radial-gradient(circle at top, #ffffff 0, #f4f7f8 40%, #e9f5f6 100%);
      color: var(--escuro);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .hidden { display: none !important; }

    /* HEADER GLOBAL (LOGO) */
    .top-brand {
      width: 100%;
      display: flex;
      justify-content: center;
      padding: 12px 16px 6px;
    }
    .top-brand img { max-width: 220px; height: auto; display: block; }

    /* LOGIN */
    #loginScreen {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px 16px 16px;
    }
    .login-card {
      width: 100%;
      max-width: 400px;
      background: var(--branco);
      border-radius: 20px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.12);
      padding: 22px 20px 18px;
    }
    .login-title { font-size: 20px; font-weight: 700; margin-bottom: 4px; color: #16363c; }
    .login-subtitle { font-size: 13px; color: #607d8b; margin-bottom: 16px; }
    .login-field { margin-bottom: 10px; }
    .login-label { font-size: 12px; font-weight: 500; margin-bottom: 4px; color: #455a64; }
    .login-input {
      width: 100%;
      border-radius: 12px;
      border: 1px solid #d4dde0;
      padding: 8px 10px;
      font-size: 13px;
      transition: border-color 0.12s ease, box-shadow 0.12s ease;
      font-family: inherit;
    }
    .login-input:focus {
      outline: none;
      border-color: var(--turquesa);
      box-shadow: 0 0 0 2px rgba(1, 173, 183, 0.16);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--turquesa), var(--coral));
      color: white;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      box-shadow: 0 8px 16px rgba(0,0,0,0.12);
      transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s;
      white-space: nowrap;
    }
    .btn:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 5px 12px rgba(0,0,0,0.18);
    }
    .btn-light {
      background: #edf3f4;
      color: #333;
      box-shadow: none;
      text-transform: none;
      letter-spacing: 0.04em;
    }
    .btn-danger {
      background: #c62828;
      box-shadow: 0 8px 16px rgba(198, 40, 40, 0.25);
    }
    .btn-secondary {
      background: #eceff1;
      color: #333;
      box-shadow: none;
      text-transform: none;
      letter-spacing: 0.04em;
    }
    .btn-small { font-size: 10px; padding: 4px 8px; box-shadow: none; }

    .login-footer-hint { font-size: 11px; color: #90a4ae; margin-top: 10px; }
    .login-error { font-size: 12px; color: #c62828; margin-top: 6px; }

    /* ADMIN APP */
    #adminApp { flex: 1; display: none; padding: 12px 16px 16px; }

    .container {
      max-width: 1120px;
      width: 100%;
      margin: 0 auto;
      background: var(--branco);
      border-radius: 24px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.08);
      padding: 20px 20px 24px;
    }

    .header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .logo-block { display: flex; flex-direction: column; gap: 2px; }
    .logo-title {
      font-family: "GoodDog Cool", "Comic Sans MS", system-ui, sans-serif;
      font-size: 28px;
      letter-spacing: 0.03em;
      color: var(--turquesa);
    }
    .logo-sub {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: #777;
    }

    .filters { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .filters-group { display: flex; align-items: center; gap: 6px; font-size: 13px; }

    /* Toolbars por aba */
    .agenda-filters {
   background: #f7fbfc;
  border: 1px solid #e0edf0;
  border-radius: 14px;
  padding: 10px 12px;
    }
    .tab-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin: 8px 0 6px;
    }
    .tab-toolbar-inline {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
      flex: 1;
    }


    input[type="date"], input[type="text"], input[type="time"], select, textarea {
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid #d7dde0;
      font-size: 13px;
      min-width: 120px;
      font-family: inherit;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--turquesa);
      box-shadow: 0 0 0 2px rgba(1, 173, 183, 0.18);
    }

    .section-title { font-size: 14px; font-weight: 600; margin: 8px 0 4px; color: #444; }
    .section-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin: 8px 0 4px;
      flex-wrap: wrap;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      border-bottom: 1px solid #e1e7ea;
      padding-bottom: 4px;
    }
    .tab-btn {
      border: none;
      background: transparent;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
      color: #607d8b;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .tab-btn.active {
      background: rgba(1,173,183,0.1);
      color: #015d63;
      font-weight: 600;
    }
    .tab-view { display: none; }
    .tab-view.active { display: block; }

    .form-panel {
      margin-top: 8px;
      margin-bottom: 12px;
      background: #f7fbfc;
      border-radius: 16px;
      padding: 10px 12px;
      border: 1px solid #e0edf0;
    }
    .form-row { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 8px; margin-bottom: 8px; }
    .form-row-2 { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 8px; margin-bottom: 8px; }
    .form-group { display: flex; flex-direction: column; gap: 3px; }
    label { font-size: 12px; font-weight: 500; color: #555; }
    textarea { min-height: 48px; resize: vertical; }

    .form-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 4px; flex-wrap: wrap; }
    .error-msg { font-size: 12px; color: #c62828; margin-top: 4px; }

    .stats { display: flex; flex-wrap: wrap; gap: 10px; margin: 12px 0 8px; font-size: 12px; }
    .stats-item {
      background: #f7fbfc;
      border-radius: 14px;
      padding: 8px 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .stats-label { color: #555; }
    .stats-value { font-weight: 700; color: var(--turquesa); }

    .table-wrapper {
      margin-top: 10px;
      border-radius: 16px;
      border: 1px solid #e3eaec;
      overflow: hidden;
      background: #fdfefe;
    }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    thead { background: #f2f7f8; }
    th, td { padding: 7px 8px; text-align: left; border-bottom: 1px solid #ecf1f3; }
    th { font-weight: 600; color: #555; white-space: nowrap; }

    tbody tr:nth-child(even) { background: #fafdfd; }
    tbody tr:hover { background: #eef7f8; }

    .td-mimo { font-weight: 600; color: var(--turquesa); }
    .td-obs { max-width: 220px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .td-status {
      font-weight: 600;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      display: inline-block;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .status-agendado { background: #fff3cd; color: #856404; }
    .status-confirmado { background: #e3f2fd; color: #1565c0; }
    .status-recebido { background: #ede7f6; color: #4527a0; }
    .status-em-servico { background: #fff8e1; color: #ef6c00; }
    .status-concluido { background: #e8f5e9; color: #2e7d32; }
    .status-entregue { background: #e0f7fa; color: #006064; }
    .status-cancelado { background: #ffebee; color: #c62828; }

    .actions { display: flex; gap: 6px; flex-wrap: wrap; }
    .empty { padding: 18px; text-align: center; font-size: 13px; color: #777; }

    .footer {
      margin-top: 12px;
      font-size: 11px;
      color: #888;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
    }

    .two-cols { display: grid; grid-template-columns: 1.2fr 1fr; gap: 12px; margin-top: 8px; }
    .subcard {
      background: #f7fbfc;
      border-radius: 16px;
      padding: 10px 10px 12px;
      border: 1px solid #e1e8eb;
    }
    .subcard-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #37474f;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .subtable-wrapper {
      margin-top: 6px;
      border-radius: 10px;
      border: 1px solid #dde5e8;
      background: #ffffff;
      overflow: hidden;
      max-height: 260px;
      overflow-y: auto;
    }
    .subtable-wrapper table { font-size: 11px; }

    .badge-mini {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(1,173,183,0.1);
      color: #015d63;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .badge-selected { background: rgba(249,161,151,0.15); color: #c04a36; }

    /* ===== NOVO: Toggle de visualiza√ß√£o (Lista / Cards) ===== */
    .view-toggle {
      display: inline-flex;
      align-items: center;
      border: 1px solid #dde5e8;
      background: #ffffff;
      border-radius: 999px;
      overflow: hidden;
      box-shadow: 0 6px 18px rgba(0,0,0,0.05);
    }
    .toggle-btn {
      border: none;
      background: transparent;
      padding: 8px 12px;
      font-size: 12px;
      cursor: pointer;
      color: #607d8b;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .toggle-btn.active {
      background: rgba(1,173,183,0.12);
      color: #015d63;
      font-weight: 700;
    }
    .agenda-actions-right {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* ===== NOVO: Cards da Agenda ===== */
    .cards-wrapper {
      margin-top: 10px;
    }
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }
    .agenda-card {
      background: #ffffff;
      border: 1px solid #e3eaec;
      border-radius: 16px;
      padding: 10px 10px 12px;
      box-shadow: 0 10px 22px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .agenda-card-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
    }
    .agenda-card-time {
      font-weight: 800;
      font-size: 14px;
      color: #16363c;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .agenda-card-date {
      font-size: 11px;
      color: #78909c;
      margin-top: 2px;
    }
    .agenda-card-main {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
      font-size: 12px;
      color: #37474f;
    }
    .agenda-line {
      display: flex;
      gap: 6px;
      align-items: baseline;
      flex-wrap: wrap;
    }
    .agenda-key {
      font-size: 11px;
      color: #78909c;
      min-width: 72px;
    }
    .agenda-val {
      font-weight: 600;
      color: #263238;
    }
    .agenda-muted {
      font-weight: 500;
      color: #546e7a;
    }
    .agenda-card-notes {
      background: #f7fbfc;
      border: 1px dashed #d7e9ec;
      border-radius: 12px;
      padding: 8px;
      font-size: 12px;
      color: #455a64;
      min-height: 38px;
    }
    .agenda-card-bottom {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 2px;
    }

    @media (max-width: 900px) {
      .form-row { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .form-row-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .two-cols { grid-template-columns: 1fr; }
      .cards-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 640px) {
      .header { align-items: flex-start; }
      .filters { width: 100%; }
      .form-row, .form-row-2 { grid-template-columns: 1fr; }
      .table-wrapper { overflow-x: auto; }
      .container { padding: 16px 14px 18px; }
      .cards-grid { grid-template-columns: 1fr; }
    }

    /* RODAP√â GLOBAL */
    .site-footer {
      border-top: 1px solid #dde5e8;
      padding: 12px 16px 16px;
      background: transparent;
    }
    .footer-inner {
      max-width: 1120px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .footer-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .footer-logo { max-width: 140px; height: auto; }
    .footer-info {
      font-size: 12px;
      color: #455a64;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .footer-info strong { font-size: 13px; color: #263238; }
    .footer-bottom { font-size: 11px; color: #78909c; text-align: center; margin-top: 4px; }

    /* Inputs datetime no mesmo padr√£o visual */
  .dt-input {
    width: 100%;
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.20);
    color: inherit;
    outline: none;
  }
  .dt-input:focus {
    border-color: rgba(255,255,255,.25);
  }

  /* =========================
   MENU HAMBURGUER + SIDEBAR
========================= */

.hamburger{
  width: 44px;
  height: 44px;
  border-radius: 12px;
  border: 1px solid #d0dde0;
  background: #f3f7f8;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
  margin-right: 10px;
}
.hamburger:hover{
  border-color: rgba(1, 173, 183, 0.6);
  box-shadow: 0 8px 18px rgba(0, 0, 0, 0.10);
  transform: translateY(-1px);
}
.hamburger-lines{
  width: 18px;
  height: 12px;
  position: relative;
  display: block;
}
.hamburger-lines::before,
.hamburger-lines::after,
.hamburger-lines{
  background: transparent;
}
.hamburger-lines::before,
.hamburger-lines::after{
  content: "";
  position: absolute;
  left: 0;
  width: 18px;
  height: 2px;
  background: #37474f;
  border-radius: 99px;
}
.hamburger-lines::before{ top: 1px; }
.hamburger-lines::after{ bottom: 1px; }
.hamburger-lines{
  border-top: 2px solid #37474f;
  border-bottom: 2px solid transparent;
  height: 2px;
}

/* Backdrop por cima do conte√∫do */
.sidebar-backdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.35);
  z-index: 9998;
}

/* Sidebar overlay */
.sidebar{
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: 320px;
  max-width: 86vw;
  background: #ffffff;
  border-right: 1px solid #dde5e8;
  box-shadow: 18px 0 40px rgba(0,0,0,0.18);
  z-index: 9999;
  display: flex;
  flex-direction: column;
  transform: translateX(-105%);
  transition: transform 0.18s ease;
}

.sidebar.open{
  transform: translateX(0);
}

.sidebar-header{
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 14px 10px;
  border-bottom: 1px solid #dde5e8;
}

.sidebar-title{
  font-weight: 800;
  color: #263238;
  letter-spacing: -0.02em;
}

.sidebar-close{
  width: 36px;
  height: 36px;
  border-radius: 10px;
  border: 1px solid #d0dde0;
  background: #f3f7f8;
  cursor: pointer;
}

.sidebar-links{
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  overflow: auto;
}

/* Reaproveita .tab-btn, mas em formato vertical */
.sidebar .tab-btn{
  width: 100%;
  justify-content: flex-start;
  border-radius: 14px;
  padding: 12px 12px;
}

/* Oculta o layout antigo de abas (se ainda existir em algum lugar) */
.tabs{ display: none !important; }

/* utilit√°rio */
.hidden{ display: none !important; }


  </style>
</head>
<body>

<header class="top-brand">
  <img src="pet-funny-logo.svg" alt="Pet Funny" />
</header>

<section id="loginScreen">
  <div class="login-card">
    <div class="login-title">√Årea Administrativa ‚Äì Pet Funny</div>
    <div class="login-subtitle">
      Acesse com o usu√°rio e senha da equipe para ver agenda, clientes e pets.
    </div>

    <div class="login-field">
      <div class="login-label">Usu√°rio</div>
      <input type="text" id="loginUser" class="login-input" placeholder="adminpetfunny" />
    </div>

    <div class="login-field">
      <div class="login-label">Senha</div>
      <input type="password" id="loginPass" class="login-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
    </div>

    <button id="btnLogin" class="btn" style="margin-top: 8px;">
      Entrar no painel
    </button>

    <div id="loginError" class="login-error hidden">
      Usu√°rio ou senha incorretos. Tente novamente.
    </div>

    <div class="login-footer-hint">
      √Årea exclusiva para a equipe Pet Funny.
    </div>
  </div>
</section>

<div id="adminApp">
  <div class="container">
<div class="header header-admin">
  <!-- Menu + texto + logo-sub (lado esquerdo) -->
  <div class="header-left">
    <button
      id="btnMenu"
      class="menu-trigger"
      type="button"
      aria-label="Abrir menu"
      aria-expanded="false"
    >
      <span class="menu-icon" aria-hidden="true">‚ò∞</span>
      <span class="menu-text">Menu</span>
    </button>

    <div class="logo-sub logo-inline">
      √Årea Administrativa ‚Äì Pet Funny
    </div>
  </div>

  <!-- A√ß√µes (lado direito) -->
  <div class="filters header-right">
    <button class="btn btn-danger btn-small" id="btnLogout" type="button">
      Sair
    </button>
  </div>
</div>



<!-- MENU LATERAL (HAMBURGUER) -->
<div id="sidebarBackdrop" class="sidebar-backdrop hidden"></div>

<nav id="sidebar" class="sidebar hidden" aria-label="Menu do painel">
  <div class="sidebar-header">
    <div class="sidebar-title">Menu</div>
    <button id="btnMenuClose" class="sidebar-close" type="button" aria-label="Fechar menu">‚úï</button>
  </div>

  <div class="sidebar-links">
    <!-- Reaproveita os MESMOS bot√µes/tab-btn e data-tab -->
    <button class="tab-btn active" data-tab="tab-agenda" type="button"><span>üìÖ</span> Agenda &amp; Mimos</button>
    <button class="tab-btn" data-tab="tab-clientes" type="button"><span>üë§</span> Clientes &amp; Pets</button>
    <button class="tab-btn" data-tab="tab-servicos" type="button"><span>üßº</span> Servi√ßos</button>
    <button class="tab-btn" data-tab="tab-racas" type="button"><span>üê∂</span> Ra√ßas de C√£es</button>
    <button class="tab-btn" data-tab="tab-mimos" type="button"><span>üéÅ</span> Mimos</button>
    <button class="tab-btn" data-tab="tab-horarios" type="button"><span>‚è±Ô∏è</span> Hor√°rio de Funcionamento</button>
    <button class="tab-btn" data-tab="tab-dashboard" type="button"><span>üìä</span> Dashboard</button>
  </div>
</nav>


    <!-- TAB: AGENDA -->
    <section id="tab-agenda" class="tab-view active">
      <div class="section-title-row">
         <div class="section-title">Agendamentos & Mimos</div>

           <div class="agenda-actions-right">
          <!-- NOVO: Toggle Lista/Cards -->
          <div class="view-toggle" aria-label="Alternar visualiza√ß√£o">
            <button class="toggle-btn active" id="btnViewList" type="button">üìã Lista</button>
            <button class="toggle-btn" id="btnViewCards" type="button">üóÇÔ∏è Cards</button>
          </div>

          <button class="btn btn-light" id="btnNovoAgendamento" type="button">+ Novo agendamento</button>
        </div>
      </div>

 

        <!-- FILTROS (APENAS DA AGENDA) -->
  <div class="agenda-filters" style="margin: 8px 0 14px; display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
    <div class="filters-group">
      <label style="font-size:12px;">Data</label>
      <input type="date" id="filtroData" />
    </div>

    <button class="btn btn-light" id="btnHoje" type="button">Hoje</button>
    <button class="btn btn-light" id="btnLimparFiltro" type="button">Limpar</button>

    <div class="filters-group" style="flex:1; min-width:200px;">
      <label style="font-size:12px;">Buscar</label>
      <input
        type="text"
        id="filtroBusca"
        placeholder="Nome do tutor, pet ou telefone"
        style="width:100%;"
      />
    </div>

    <button class="btn btn-light" id="btnExportarCSV" type="button">
      Exportar CSV
    </button>
  </div>

      

      <div class="form-panel hidden" id="formPanel">
        <input type="hidden" id="bookingId" />
        <input type="hidden" id="bookingOriginalStatus" />

        <div class="form-row">
          <div class="form-group">
            <label for="formPhone">Telefone (WhatsApp)</label>
            <input type="text" id="formPhone" placeholder="(16) 9 9999-9999" />
          </div>
          <div class="form-group">
            <label for="formNome">Tutor(a)</label>
            <input type="text" id="formNome" placeholder="Nome do tutor" />
          </div>
          <div class="form-group">
            <label for="formPetSelect">Pet (opcional)</label>
            <select id="formPetSelect">
              <option value="">(Sem pet informado)</option>
            </select>
          </div>
          <div class="form-group">
            <label for="formPrize">Mimo (Roleta)</label>
            <select id="formPrize">
              <option value="Tosa Higi√™nica">Tosa Higi√™nica</option>
              <option value="Hidrata√ß√£o">Hidrata√ß√£o</option>
              <option value="Foto e V√≠deo Profissional">Foto e V√≠deo Profissional</option>
              <option value="Patinhas impec√°veis">Patinhas impec√°veis</option>
            </select>
          </div>
        </div>

        <div class="form-row-2">
          <div class="form-group">
            <label for="formService">Servi√ßo (do banco)</label>
            <select id="formService">
              <option value="">Carregando servi√ßos...</option>
            </select>
          </div>
          <div class="form-group">
            <label for="formDate">Data</label>
            <input type="date" id="formDate" />
          </div>
          <div class="form-group">
            <label for="formTime">Hor√°rio</label>
            <input type="time" id="formTime" />
          </div>
        </div>

        <div class="form-row-2">
          <div class="form-group">
            <label for="formStatus">Status</label>
            <select id="formStatus">
              <option value="agendado">Agendado</option>
              <option value="confirmado">Confirmado</option>
              <option value="recebido">Recebido</option>
              <option value="em servi√ßo">Em servi√ßo</option>
              <option value="conclu√≠do">Conclu√≠do</option>
              <option value="entregue">Entregue</option>
              <option value="cancelado">Cancelado</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="formNotes">Observa√ß√µes</label>
          <textarea id="formNotes" placeholder="Ex: porte, comportamento, cuidados especiais..."></textarea>
        </div>

        <div id="formError" class="error-msg" style="display:none;"></div>

        <div class="form-actions">
          <button class="btn btn-secondary" id="btnCancelarEdicao" type="button">Limpar / cancelar</button>
          <button class="btn" id="btnSalvar" type="button">Salvar</button>
        </div>
      </div>

      <div class="stats">
        <div class="stats-item"><span class="stats-label">Total de agendamentos:</span> <span class="stats-value" id="statTotal">0</span></div>
        <div class="stats-item"><span class="stats-label">Tosa Higi√™nica:</span> <span class="stats-value" id="statTosa">0</span></div>
        <div class="stats-item"><span class="stats-label">Hidrata√ß√£o:</span> <span class="stats-value" id="statHidratacao">0</span></div>
        <div class="stats-item"><span class="stats-label">Foto/V√≠deo:</span> <span class="stats-value" id="statFotoVideo">0</span></div>
        <div class="stats-item"><span class="stats-label">Patinhas impec√°veis:</span> <span class="stats-value" id="statPatinhas">0</span></div>
      </div>

      <!-- NOVO: Wrapper Lista -->
      <div id="agendaListWrapper" class="table-wrapper">
        <table>
          <thead>
          <tr>
            <th>Data</th>
            <th>Hora</th>
            <th>Tutor(a)</th>
            <th>Pet</th>
            <th>Telefone</th>
            <th>Servi√ßo</th>
            <th>Mimo</th>
            <th>Status</th>
            <th>√öltima notifica√ß√£o</th>
            <th>Obs.</th>
            <th>A√ß√µes</th>
          </tr>
          </thead>
          <tbody id="tbodyAgenda"></tbody>
        </table>
        <div id="estadoVazio" class="empty" style="display:none;">Nenhum agendamento encontrado para o filtro atual.</div>
      </div>

      <!-- NOVO: Wrapper Cards -->
      <div id="agendaCardsWrapper" class="cards-wrapper hidden">
        <div id="agendaCards" class="cards-grid"></div>
        <div id="estadoVazioCards" class="empty hidden">Nenhum agendamento encontrado para o filtro atual.</div>
      </div>
    </section>

    <!-- TAB: CLIENTES & PETS -->
    <section id="tab-clientes" class="tab-view">
      <div class="section-title">Clientes &amp; Pets</div>
      <div class="tab-toolbar">
        <div class="filters-group">
          <span style="font-size:13px;">Buscar:</span>
          <input type="text" id="filtroClientes" placeholder="Nome do tutor ou telefone" />
          <button class="btn btn-light" id="btnLimparClientes" type="button">Limpar</button>
        </div>
      </div>
      <div class="two-cols">
        <!-- CLIENTES -->
        <div class="subcard">
          <div class="subcard-title">
            <span>Clientes</span>
            <span id="badgeClienteSelecionado" class="badge-mini badge-selected hidden">Cliente selecionado</span>
            <button class="btn btn-secondary btn-small" id="btnNovoCliente" type="button">+ Novo cliente</button>
          </div>

          <div id="clienteFormBlock" class="hidden">
            <div class="form-group">
              <label for="cliPhone">Telefone (WhatsApp)</label>
              <input type="text" id="cliPhone" placeholder="(16) 9 9999-9999" />
            </div>
            <div class="form-group">
              <label for="cliName">Nome do tutor</label>
              <input type="text" id="cliName" placeholder="Nome completo" />
            </div>
            <div id="cliError" class="error-msg" style="display:none;"></div>
            <div class="form-actions">
              <button class="btn btn-secondary btn-small" id="btnCliLimpar" type="button">Limpar</button>
              <button class="btn btn-small" id="btnCliSalvar" type="button">Salvar / Atualizar</button>
            </div>
          </div>

          <div class="subtable-wrapper" style="margin-top:10px;">
            <table>
              <thead>
              <tr>
                <th>ID</th>
                <th>Tutor</th>
                <th>Telefone</th>
                <th>Pets</th>
                <th>A√ß√µes</th>
              </tr>
              </thead>
              <tbody id="tbodyClientes"></tbody>
            </table>
          </div>
        </div>

        <!-- PETS DO CLIENTE SELECIONADO -->
        <div class="subcard hidden" id="petsCard">
          <div class="subcard-title">
            <span>Pets do cliente selecionado</span>
            <button class="btn btn-secondary btn-small" id="btnNovoPet" type="button">+ Novo pet</button>
          </div>
          <div class="form-group">
            <label for="petName">Nome do pet</label>
            <input type="text" id="petName" placeholder="Nome do pet" />
          </div>
          <div class="form-group">
            <label for="petBreed">Ra√ßa</label>
            <select id="petBreed"></select>
          </div>
          <div class="form-group">
            <label for="petInfo">Mais informa√ß√µes</label>
            <textarea id="petInfo" placeholder="Porte, comportamento, medica√ß√£o, etc."></textarea>
          </div>
          <div id="petError" class="error-msg" style="display:none;"></div>
          <div class="form-actions">
            <button class="btn btn-secondary btn-small" id="btnPetLimpar" type="button">Limpar</button>
            <button class="btn btn-small" id="btnPetSalvar" type="button">Salvar pet</button>
          </div>

          <div class="subtable-wrapper" style="margin-top:10px;">
            <table>
              <thead>
              <tr>
                <th>ID</th>
                <th>Nome</th>
                <th>Ra√ßa</th>
                <th>Info</th>
                <th>A√ß√µes</th>
              </tr>
              </thead>
              <tbody id="tbodyPets"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB: SERVI√áOS -->
    <section id="tab-servicos" class="tab-view">
      <div class="section-title-row">
        <div class="section-title">Servi√ßos</div>
        <div class="tab-toolbar-inline">
          <div class="filters-group">
            <span style="font-size:13px;">Buscar:</span>
            <input type="text" id="filtroServicos" placeholder="T√≠tulo do servi√ßo" />
            <button class="btn btn-light" id="btnLimparServicos" type="button">Limpar</button>
          </div>
        </div>
        <button class="btn btn-light" id="btnNovoServico" type="button">+ Novo servi√ßo</button>
      </div>

      <div class="form-panel hidden" id="serviceFormPanel">
        <input type="hidden" id="serviceId" />
        <div class="form-row-2">
          <div class="form-group">
            <label for="serviceDate">Data</label>
            <input type="date" id="serviceDate" />
          </div>
          <div class="form-group">
            <label for="serviceTitle">T√≠tulo do servi√ßo</label>
            <input type="text" id="serviceTitle" placeholder="Ex: Banho + Tosa (Porte M)" />
          </div>
          <div class="form-group">
            <label for="servicePrice">Valor (R$)</label>
            <input type="text" id="servicePrice" placeholder="R$ 0,00" inputmode="numeric" />
          </div>
        </div>

        <div id="serviceError" class="error-msg" style="display:none;"></div>

        <div class="form-actions">
          <button class="btn btn-secondary" id="btnServiceCancel" type="button">Limpar / cancelar</button>
          <button class="btn" id="btnServiceSave" type="button">Salvar</button>
        </div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Data</th>
              <th>T√≠tulo</th>
              <th>Valor</th>
              <th>Criado em</th>
              <th>Atualizado em</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tbodyServices"></tbody>
        </table>
        <div id="servicesEmpty" class="empty" style="display:none;">Nenhum servi√ßo cadastrado ainda.</div>
      </div>
    </section>

    
    <!-- TAB: RA√áAS DE C√ÉES -->
    <section id="tab-racas" class="tab-view">
      <div class="section-title-row">
        <div class="section-title">Ra√ßas de C√£es (Cat√°logo)</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
          <input type="text" id="breedSearch" placeholder="Buscar ra√ßa..." style="min-width:220px;" />
          <button class="btn btn-light" id="btnNovoBreed" type="button">+ Nova ra√ßa</button>
        </div>
      </div>

      <div class="form-panel hidden" id="breedFormPanel">
        <input type="hidden" id="breedId" />
        <div class="form-row-2">
          <div class="form-group">
            <label for="breedName">Ra√ßa (nome)</label>
            <input type="text" id="breedName" placeholder="Ex: Shih Tzu" />
          </div>
          <div class="form-group">
            <label for="breedSize">Porte</label>
            <select id="breedSize">
              <option value="pequeno">Pequeno</option>
              <option value="medio">M√©dio</option>
              <option value="grande">Grande</option>
            </select>
          </div>
          <div class="form-group">
            <label for="breedCoat">Pelagem</label>
            <select id="breedCoat">
              <option value="curta">Curta</option>
              <option value="media">M√©dia</option>
              <option value="longa">Longa</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="breedHistory">Hist√≥ria (breve)</label>
          <textarea id="breedHistory" placeholder="Resumo hist√≥rico e especificidades relevantes (temperamento, origem, cuidados)."></textarea>
        </div>

        <div id="breedError" class="error-msg" style="display:none;"></div>

        <div class="form-actions">
          <button class="btn btn-secondary" id="btnBreedCancel" type="button">Limpar / cancelar</button>
          <button class="btn" id="btnBreedSave" type="button">Salvar</button>
        </div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Ra√ßa</th>
              <th>Porte</th>
              <th>Pelagem</th>
              <th>Hist√≥ria</th>
              <th>Criado em</th>
              <th>Atualizado em</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tbodyBreeds"></tbody>
        </table>
        <div id="breedsEmpty" class="empty" style="display:none;">Nenhuma ra√ßa cadastrada ainda.</div>
      </div>
    </section>

<!-- TAB: MIMOS -->
<section id="tab-mimos" class="tab-view">
  <div class="section-title-row">
    <div class="section-title">Mimos</div>

    <div class="section-actions" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="mimosSearch" type="text" placeholder="Buscar mimos..." class="input" style="min-width:260px;" />
      </div>

      <button class="btn" id="btnNovoMimo" type="button">Novo Mimo</button>
      <button class="btn btn-secondary btn-small" id="btnMimosReload" type="button">Recarregar</button>
    </div>
  </div>

  <div class="card">

    <!-- Form colaps√°vel (fechado por padr√£o) -->
    <div id="mimoFormWrap" class="card" style="margin:0 0 16px 0; display:none;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <h3 style="margin:0;">Cadastrar / Editar Mimo</h3>
        <button class="btn btn-secondary btn-small" id="btnFecharMimoForm" type="button">Fechar</button>
      </div>

      <div class="grid-2" style="margin-top:12px;">
        <div>
          <div class="form-row">
            <label for="mimoTitle">T√≠tulo</label>
            <input id="mimoTitle" type="text" placeholder="Ex.: üéÅ Banho Gr√°tis" maxlength="80" />
          </div>

          <div class="form-row">
            <label for="mimoDesc">Descri√ß√£o (com emojis)</label>
            <textarea id="mimoDesc" rows="3" placeholder="Ex.: üéâ Voc√™ ganhou 1 banho gr√°tis!"></textarea>

            <div id="emojiPanel" style="margin-top:10px; display:flex; flex-wrap:wrap; gap:6px; user-select:none;"></div>
            <small style="opacity:.75">Dica r√°pida: no Windows, use <b>Win + .</b> para abrir o seletor de emojis.</small>
          </div>
        </div>

        <div>
          <div class="grid-2">
            <div class="form-row">
              <label for="mimoValue">Valor (R$)</label>
              <input id="mimoValue" type="text" inputmode="numeric" placeholder="0,00" />
            </div>

            <div class="form-row" style="display:flex; align-items:flex-end;">
              <label style="display:flex; gap:8px; align-items:center; margin:0;">
                <input id="mimoActive" type="checkbox" checked />
                Ativo
              </label>
            </div>
          </div>

          <div class="grid-2">
            <div class="form-row">
              <label for="mimoStart">In√≠cio</label>
              <input id="mimoStart" type="datetime-local" class="dt-input" />
            </div>

            <div class="form-row">
              <label for="mimoEnd">T√©rmino</label>
              <input id="mimoEnd" type="datetime-local" class="dt-input" />
            </div>
          </div>

          <div style="display:flex; gap:8px; margin-top:10px; align-items:center;">
            <button class="btn" id="btnMimoSave" type="button">Salvar</button>
            <button class="btn btn-secondary" id="btnMimoClear" type="button">Limpar</button>
            <div id="mimoMsg" style="margin-left:auto; opacity:.85;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Lista -->
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin:18px 0 14px 0;">
      <h3 style="margin:0;">Lista de Mimos</h3>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>T√≠tulo</th>
            <th>Valor</th>
            <th>Per√≠odo</th>
            <th>Ativo</th>
            <th style="width:160px;">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tbodyMimos"></tbody>
      </table>
      <div id="mimosEmpty" class="empty" style="display:none;">Nenhum mimo cadastrado.</div>
    </div>

  </div>
</section>



    <!-- TAB: HOR√ÅRIO DE FUNCIONAMENTO -->
    <section id="tab-horarios" class="tab-view">
      <div class="section-title-row">
        <div class="section-title">Hor√°rio de Funcionamento</div>
        <button class="btn btn-light" id="btnHoursReload" type="button">Recarregar</button>
      </div>

      <div class="form-panel" style="margin-top:6px;">
        <div style="font-size:12px;color:#546e7a;line-height:1.35;">
          Configure por dia: abertura, fechamento, dia fechado e a capacidade m√°xima de agendamentos por <strong>slot de 30 minutos</strong>.
        </div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Dia</th>
              <th>Fechado</th>
              <th>Abertura</th>
              <th>Fechamento</th>
              <th>Max. por 30 min</th>
              <th>Atualizado em</th>
            </tr>
          </thead>
          <tbody id="tbodyHours"></tbody>
        </table>
        <div id="hoursEmpty" class="empty" style="display:none;">N√£o foi poss√≠vel carregar o hor√°rio de funcionamento.</div>
      </div>

      <div class="form-actions" style="margin-top:10px;">
        <button class="btn btn-secondary" id="btnHoursResetDefault" type="button">Restaurar padr√£o</button>
        <button class="btn" id="btnHoursSave" type="button">Salvar Hor√°rios</button>
      </div>

      <div id="hoursMsg" class="login-footer-hint" style="margin-top:8px;"></div>
    </section>

<!-- TAB: DASHBOARD -->
    <section id="tab-dashboard" class="tab-view">
      <div class="section-title-row">
        <div class="section-title">Dashboard de Indicadores</div>
      </div>

      <div class="form-panel" id="dashboardFilters">
        <div class="form-row-2">
          <div class="form-group">
            <label for="dashPeriod">Per√≠odo</label>
            <select id="dashPeriod">
              <option value="today">Hoje</option>
              <option value="7">√öltimos 7 dias</option>
              <option value="30">√öltimos 30 dias</option>
              <option value="month">M√™s atual</option>
              <option value="custom">Personalizado</option>
            </select>
          </div>
          <div class="form-group dash-custom-range hidden" id="dashCustomRange">
            <label>Per√≠odo personalizado</label>
            <div style="display:flex;gap:6px;flex-wrap:wrap;">
              <input type="date" id="dashStart" />
              <input type="date" id="dashEnd" />
              <button class="btn btn-small" id="dashApply" type="button">Aplicar</button>
            </div>
          </div>
        </div>
      </div>

      <div class="stats">
        <div class="stats-item"><span class="stats-label">Agendamentos no per√≠odo:</span> <span class="stats-value" id="dashTotalBookings">0</span></div>
        <div class="stats-item"><span class="stats-label">Clientes √∫nicos no per√≠odo:</span> <span class="stats-value" id="dashUniqueCustomers">0</span></div>
        <div class="stats-item"><span class="stats-label">Total de clientes cadastrados:</span> <span class="stats-value" id="dashTotalCustomers">0</span></div>
      </div>

      <div class="section-title" style="margin-top:12px;">Status dos agendamentos</div>
      <div class="stats">
        <div class="stats-item"><span class="stats-label">Agendado:</span> <span class="stats-value" id="dashStatusAgendado">0</span></div>
        <div class="stats-item"><span class="stats-label">Confirmado:</span> <span class="stats-value" id="dashStatusConfirmado">0</span></div>
        <div class="stats-item"><span class="stats-label">Recebido:</span> <span class="stats-value" id="dashStatusRecebido">0</span></div>
        <div class="stats-item"><span class="stats-label">Em servi√ßo:</span> <span class="stats-value" id="dashStatusEmServico">0</span></div>
        <div class="stats-item"><span class="stats-label">Conclu√≠do:</span> <span class="stats-value" id="dashStatusConcluido">0</span></div>
        <div class="stats-item"><span class="stats-label">Entregue:</span> <span class="stats-value" id="dashStatusEntregue">0</span></div>
        <div class="stats-item"><span class="stats-label">Cancelado:</span> <span class="stats-value" id="dashStatusCancelado">0</span></div>
      </div>

      <div class="section-title" style="margin-top:12px;">Mimos da Roleta no per√≠odo</div>
      <div class="stats">
        <div class="stats-item"><span class="stats-label">Tosa Higi√™nica:</span> <span class="stats-value" id="dashPrizeTosa">0</span></div>
        <div class="stats-item"><span class="stats-label">Hidrata√ß√£o:</span> <span class="stats-value" id="dashPrizeHidratacao">0</span></div>
        <div class="stats-item"><span class="stats-label">Foto/V√≠deo Profissional:</span> <span class="stats-value" id="dashPrizeFotoVideo">0</span></div>
        <div class="stats-item"><span class="stats-label">Patinhas impec√°veis:</span> <span class="stats-value" id="dashPrizePatinhas">0</span></div>
      </div>

      <!-- NOVO: M√âTRICAS FINANCEIRAS POR SERVI√áO -->
      <div class="section-title" style="margin-top:16px;">Servi√ßos no per√≠odo (quantidade e faturamento estimado)</div>

      <div class="stats">
        <div class="stats-item"><span class="stats-label">Faturamento estimado no per√≠odo:</span> <span class="stats-value" id="dashRevenue">R$ 0,00</span></div>
        <div class="stats-item"><span class="stats-label">Ticket m√©dio estimado:</span> <span class="stats-value" id="dashAvgTicket">R$ 0,00</span></div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Servi√ßo</th>
              <th>Qtd.</th>
              <th>Pre√ßo (cadastro)</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="tbodyDashServices"></tbody>
        </table>
        <div id="dashServicesEmpty" class="empty" style="display:none;">Sem dados suficientes para compor o financeiro por servi√ßo.</div>
      </div>

      <div class="section-title" style="margin-top:20px;">Vis√£o Gr√°fica</div>
      <div style="display:flex;flex-wrap:wrap;gap:20px;justify-content:center;margin-top:10px;">
        <div style="background:#fff;border-radius:16px;padding:12px;box-shadow:0 4px 14px rgba(0,0,0,0.06);">
          <canvas id="chartStatus" style="max-width:460px;"></canvas>
        </div>
        <div style="background:#fff;border-radius:16px;padding:12px;box-shadow:0 4px 14px rgba(0,0,0,0.06);">
          <canvas id="chartPrizes" style="max-width:380px;"></canvas>
        </div>
      </div>
    </section>

    <div class="footer">
      <div>Dados via API (<code>/api/customers</code>, <code>/api/pets</code>, <code>/api/bookings</code>, <code>/api/services</code>). Exporta√ß√£o CSV feita no navegador.</div>
      <div>Pet Funny ‚Ä¢ Admin CRUD &amp; Status</div>
    </div>
  </div>
</div>

<footer class="site-footer">
  <div class="footer-inner">
    <div class="footer-top">
      <img src="pet-funny-logo.svg" alt="Pet Funny" class="footer-logo" />
      <div class="footer-info">
        <strong>Pet Funny ‚Ä¢ Banho &amp; Tosa</strong>
        <span>Rua Virg√≠lio de Carvalho Neves Neto, 794 ‚Äì Ribeir√£o Preto / SP</span>
        <span>Hor√°rio: Seg‚ÄìSex: 07:30 √†s 17:30 ‚Ä¢ S√°bado: 07:30 √†s 13:00</span>
        <span>WhatsApp: (16) 98153-5338</span>
      </div>
    </div>
    <div class="footer-bottom">¬© 2024 Pet Funny ‚Ä¢ Roleta de Mimos. Todos os direitos reservados.</div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const API_BASE_URL = '';

  /* ===== Helpers de normaliza√ß√£o (corrige acentos/varia√ß√µes) ===== */
  function normStr(s) {
    return String(s || '')
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .trim();
  }

  /* =========================================================
   MIMOS (Admin) - CRUD + Emojis + Valor (cents) + Per√≠odo
   Requisitos:
   - HTML ids: tab-mimos, tbodyMimos, mimosEmpty,
              mimoTitle, mimoDesc, emojiPanel,
              mimoValue, mimoStart, mimoEnd, mimoActive,
              btnMimoSave, btnMimoClear, btnMimosReload, mimoMsg
   - API no server:
     GET    /api/mimos
     POST   /api/mimos
     PUT    /api/mimos/:id
     DELETE /api/mimos/:id
   - Opcional: select existente #formPrize (para roleta/pr√™mio no agendamento)
========================================================= */
(function () {
  'use strict';

  const $ = (id) => document.getElementById(id);
  const elTab = $('tab-mimos');
  if (!elTab) return;

  const els = {
    title: $('mimoTitle'),
    desc: $('mimoDesc'),
    emojiPanel: $('emojiPanel'),
    value: $('mimoValue'),
    start: $('mimoStart'),
    end: $('mimoEnd'),
    active: $('mimoActive'),
    save: $('btnMimoSave'),
    clear: $('btnMimoClear'),
    reload: $('btnMimosReload'),
    msg: $('mimoMsg'),
    tbody: $('tbodyMimos'),
    empty: $('mimosEmpty'),
    prizeSelect: document.getElementById('formPrize') || null,

    // novos do layout
    search: $('mimosSearch'),
    btnNovo: $('btnNovoMimo'),
    formWrap: $('mimoFormWrap'),
    btnCloseForm: $('btnFecharMimoForm'),
  };

  let currentEditId = null;
  let cacheMimos = [];

  function setMsg(text, isError) {
    if (!els.msg) return;
    els.msg.textContent = text || '';
    els.msg.style.color = isError ? '#c0392b' : '';
  }

  function pad2(n) { return String(n).padStart(2, '0'); }

  function toDatetimeLocalValue(isoOrTs) {
    if (!isoOrTs) return '';
    const d = new Date(isoOrTs);
    if (isNaN(d.getTime())) return '';
    return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }

  function fromDatetimeLocalValue(v) {
    if (!v) return null;
    const d = new Date(v);
    if (isNaN(d.getTime())) return null;
    return d.toISOString();
  }

  function parseBRLToCents(input) {
    if (input == null) return 0;
    const s = String(input).replace(/[^\d,.-]/g, '').trim();
    if (!s) return 0;
    const normalized = s.replace(/\./g, '').replace(',', '.');
    const n = Number(normalized);
    if (!Number.isFinite(n)) return 0;
    return Math.max(0, Math.round(n * 100));
  }

  function formatCentsToBRL(cents) {
    const v = Number(cents || 0) / 100;
    return v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function moneyMaskAttach(inputEl) {
    if (!inputEl) return;
    inputEl.addEventListener('blur', () => {
      const cents = parseBRLToCents(inputEl.value);
      inputEl.value = formatCentsToBRL(cents);
    });
  }

  const EMOJI_LIST = [
    'üéÅ','üéâ','‚ú®','‚≠ê','üíé','üèÜ','ü•á','üéØ','üî•','‚úÖ','üß°','üíõ','üíö','üíô','üíú',
    'üê∂','üêæ','üõÅ','‚úÇÔ∏è','üß¥','üßº','ü´ß','ü¶¥','üçñ','üí∏','üéüÔ∏è','üì£','üìÖ','üîî','üé°','üé≤'
  ];

  function insertAtCursor(textarea, text) {
    if (!textarea) return;
    const start = textarea.selectionStart ?? textarea.value.length;
    const end = textarea.selectionEnd ?? textarea.value.length;
    const before = textarea.value.slice(0, start);
    const after = textarea.value.slice(end);
    textarea.value = before + text + after;
    const newPos = start + text.length;
    textarea.selectionStart = textarea.selectionEnd = newPos;
  }

  function buildEmojiPanel() {
    if (!els.emojiPanel || !els.desc) return;
    els.emojiPanel.innerHTML = '';
    EMOJI_LIST.forEach((e) => {
      const b = document.createElement('button');
      b.type = 'button';
      b.textContent = e;
      b.className = 'btn btn-small';
      b.style.padding = '6px 8px';
      b.style.lineHeight = '1';
      b.addEventListener('click', () => {
        insertAtCursor(els.desc, e);
        els.desc.focus();
      });
      els.emojiPanel.appendChild(b);
    });
  }

  function openForm() {
    if (els.formWrap) els.formWrap.style.display = '';
  }
  function closeForm() {
    if (els.formWrap) els.formWrap.style.display = 'none';
  }

  function clearForm() {
    currentEditId = null;
    if (els.title) els.title.value = '';
    if (els.desc) els.desc.value = '';
    if (els.value) els.value.value = formatCentsToBRL(0);
    if (els.start) els.start.value = '';
    if (els.end) els.end.value = '';
    if (els.active) els.active.checked = true;
    setMsg('', false);
  }

  /* ---------- API ---------- */
  async function apiGetMimos() {
    const r = await fetch('/api/mimos', { method: 'GET' });
    const data = await r.json().catch(() => ({}));
    if (!r.ok) throw new Error(data.error || 'Erro ao buscar mimos.');
    return data.mimos || [];
  }

  async function apiCreateMimo(payload) {
    const r = await fetch('/api/mimos', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    const data = await r.json().catch(() => ({}));
    if (!r.ok) throw new Error(data.error || 'Erro ao criar mimo.');
    return data.mimo;
  }

  async function apiUpdateMimo(id, payload) {
    const r = await fetch(`/api/mimos/${encodeURIComponent(id)}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    const data = await r.json().catch(() => ({}));
    if (!r.ok) throw new Error(data.error || 'Erro ao atualizar mimo.');
    return data.mimo;
  }

  async function apiDeleteMimo(id) {
    const r = await fetch(`/api/mimos/${encodeURIComponent(id)}`, { method: 'DELETE' });
    const data = await r.json().catch(() => ({}));
    if (!r.ok) throw new Error(data.error || 'Erro ao excluir mimo.');
    return true;
  }

  /* ---------- Render ---------- */
  function syncPrizeSelect(mimos) {
    if (!els.prizeSelect) return;

    const now = new Date();
    const isInPeriod = (m) => {
      if (!m.is_active) return false;
      const s = m.starts_at ? new Date(m.starts_at) : null;
      const e = m.ends_at ? new Date(m.ends_at) : null;
      if (s && !isNaN(s.getTime()) && now < s) return false;
      if (e && !isNaN(e.getTime()) && now > e) return false;
      return true;
    };

    const active = (mimos || []).filter(isInPeriod);
    const current = els.prizeSelect.value;

    els.prizeSelect.innerHTML = '';
    const opt0 = document.createElement('option');
    opt0.value = '';
    opt0.textContent = '‚Äî Sem mimo ‚Äî';
    els.prizeSelect.appendChild(opt0);

    active.forEach((m) => {
      const opt = document.createElement('option');
      opt.value = m.title; // compat: booking.prize √© texto
      opt.textContent = `${m.title} (R$ ${formatCentsToBRL(m.value_cents)})`;
      opt.setAttribute('data-mimo-id', String(m.id));
      els.prizeSelect.appendChild(opt);
    });

    if (current) els.prizeSelect.value = current;
  }

  function renderMimosTable(mimos) {
    if (!els.tbody) return;
    els.tbody.innerHTML = '';

    const q = (els.search?.value || '').trim().toLowerCase();
    const filtered = !q ? (mimos || []) : (mimos || []).filter(m =>
      String(m.title || '').toLowerCase().includes(q) ||
      String(m.description || '').toLowerCase().includes(q)
    );

    if (!filtered || filtered.length === 0) {
      if (els.empty) els.empty.style.display = '';
      return;
    }
    if (els.empty) els.empty.style.display = 'none';

    const fmt = (d) => {
      if (!d || isNaN(d.getTime())) return '‚Äî';
      return d.toLocaleString('pt-BR', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
    };

    filtered.forEach((m) => {
      const tr = document.createElement('tr');

      const tdTitle = document.createElement('td');
      tdTitle.textContent = m.title || '';
      tr.appendChild(tdTitle);

      const tdValue = document.createElement('td');
      tdValue.textContent = `R$ ${formatCentsToBRL(m.value_cents)}`;
      tr.appendChild(tdValue);

      const tdPeriod = document.createElement('td');
      const s = m.starts_at ? new Date(m.starts_at) : null;
      const e = m.ends_at ? new Date(m.ends_at) : null;
      tdPeriod.textContent = `${fmt(s)} ‚Üí ${fmt(e)}`;
      tr.appendChild(tdPeriod);

      const tdActive = document.createElement('td');
      tdActive.textContent = m.is_active ? 'Sim' : 'N√£o';
      tr.appendChild(tdActive);

      const tdActions = document.createElement('td');
      tdActions.style.whiteSpace = 'nowrap';

      const btnEdit = document.createElement('button');
      btnEdit.type = 'button';
      btnEdit.className = 'btn btn-small';
      btnEdit.textContent = 'Editar';
      btnEdit.addEventListener('click', () => {
        currentEditId = m.id;
        if (els.title) els.title.value = m.title || '';
        if (els.desc) els.desc.value = m.description || '';
        if (els.value) els.value.value = formatCentsToBRL(m.value_cents);
        if (els.start) els.start.value = toDatetimeLocalValue(m.starts_at);
        if (els.end) els.end.value = toDatetimeLocalValue(m.ends_at);
        if (els.active) els.active.checked = !!m.is_active;
        setMsg(`Editando ID ${m.id}`, false);
        openForm();
      });

      const btnDel = document.createElement('button');
      btnDel.type = 'button';
      btnDel.className = 'btn btn-small btn-danger';
      btnDel.textContent = 'Excluir';
      btnDel.style.marginLeft = '6px';
      btnDel.addEventListener('click', async () => {
        const ok = confirm(`Excluir o mimo "${m.title}"?`);
        if (!ok) return;
        try {
          setMsg('Excluindo...', false);
          await apiDeleteMimo(m.id);
          await reloadMimos();
          setMsg('Mimo exclu√≠do.', false);
        } catch (err) {
          setMsg(err.message || 'Erro ao excluir.', true);
        }
      });

      tdActions.appendChild(btnEdit);
      tdActions.appendChild(btnDel);
      tr.appendChild(tdActions);

      els.tbody.appendChild(tr);
    });
  }

  async function reloadMimos() {
    setMsg('Carregando...', false);
    const mimos = await apiGetMimos();
    cacheMimos = mimos;
    renderMimosTable(mimos);
    syncPrizeSelect(mimos);
    setMsg('', false);
  }

  async function handleSave() {
    try {
      setMsg('Salvando...', false);

      const title = (els.title?.value || '').trim();
      const description = (els.desc?.value || '').trim();
      const value_cents = parseBRLToCents(els.value?.value || '0');
      const starts_at = fromDatetimeLocalValue(els.start?.value || '');
      const ends_at = fromDatetimeLocalValue(els.end?.value || '');
      const is_active = !!els.active?.checked;

      if (!title) {
        setMsg('Informe o t√≠tulo.', true);
        els.title?.focus();
        return;
      }

      if (ends_at && starts_at && new Date(ends_at) < new Date(starts_at)) {
        setMsg('A data de t√©rmino n√£o pode ser menor que a data de in√≠cio.', true);
        return;
      }

      const payload = { title, description, value_cents, starts_at, ends_at, is_active };

      if (currentEditId) {
        await apiUpdateMimo(currentEditId, payload);
        setMsg('Mimo atualizado.', false);
      } else {
        await apiCreateMimo(payload);
        setMsg('Mimo criado.', false);
      }

      await reloadMimos();
      clearForm();
      closeForm();
    } catch (err) {
      setMsg(err.message || 'Erro ao salvar.', true);
    }
  }

  function attachEvents() {
    moneyMaskAttach(els.value);

    if (els.save) els.save.addEventListener('click', handleSave);
    if (els.clear) els.clear.addEventListener('click', clearForm);
    if (els.reload) els.reload.addEventListener('click', () => reloadMimos().catch(e => setMsg(e.message || 'Erro.', true)));

    if (els.btnNovo) els.btnNovo.addEventListener('click', () => {
      clearForm();
      openForm();
      els.title?.focus();
    });

    if (els.btnCloseForm) els.btnCloseForm.addEventListener('click', () => {
      closeForm();
      setMsg('', false);
    });

    if (els.search) els.search.addEventListener('input', () => {
      renderMimosTable(cacheMimos);
    });

    document.addEventListener('click', (e) => {
      const btn = e.target?.closest?.('.tab-btn[data-tab="tab-mimos"]');
      if (!btn) return;
      reloadMimos().catch(err => setMsg(err.message || 'Erro ao carregar mimos.', true));
    });
  }

  buildEmojiPanel();
  attachEvents();
})();

  /* ========= CONTROLE DE SESS√ÉO (30 MIN) ========= */
  const SESSION_KEY = 'pf_admin_session';
  const SESSION_DURATION_MS = 30 * 60 * 1000;
  let sessionTimerId = null;
  let appInitialized = false;

  function setSession() {
    const expiresAt = Date.now() + SESSION_DURATION_MS;
    const session = { user: 'adminpetfunny', expiresAt };
    try { localStorage.setItem(SESSION_KEY, JSON.stringify(session)); } catch (_) {}
  }
  function clearSession() { try { localStorage.removeItem(SESSION_KEY); } catch (_) {} }
  function getSession() {
    try {
      const raw = localStorage.getItem(SESSION_KEY);
      if (!raw) return null;
      const data = JSON.parse(raw);
      if (!data.expiresAt || Date.now() > data.expiresAt) { clearSession(); return null; }
      return data;
    } catch (_) { clearSession(); return null; }
  }

  function handleSessionExpired() {
    if (sessionTimerId) { clearInterval(sessionTimerId); sessionTimerId = null; }
    clearSession();
    adminApp.style.display = 'none';
    loginScreen.classList.remove('hidden');
    alert('Sua sess√£o expirou. Fa√ßa login novamente.');
  }

  function startSessionTimer() {
    if (sessionTimerId) clearInterval(sessionTimerId);
    sessionTimerId = setInterval(() => {
      const s = getSession();
      if (!s) handleSessionExpired();
    }, 30000);
  }

  async function initApp() {
    if (appInitialized) {
      try { await loadServices(); await renderTabela(); await loadDashboard(); } catch (_) {}
      return;
    }
    appInitialized = true;
    try {
      await loadServices();      // garante servicesCache e dropdown de servi√ßos
      await renderTabela();
      await loadClientes();
      await loadBreeds();
      await loadOpeningHours();
      await loadDashboard();
      initAgendaViewToggle();    // NOVO: inicia toggle (lista/cards)
    } catch (e) { console.error(e); }
  }

  function enterAdminMode() {
    loginError.classList.add('hidden');
    loginScreen.classList.add('hidden');
    adminApp.style.display = 'block';
    setSession();
    startSessionTimer();
    initApp();
  }

  function doLogout() {
    clearSession();
    if (sessionTimerId) { clearInterval(sessionTimerId); sessionTimerId = null; }
    limparForm();
    limparClienteForm();
    clearServiceForm();
    adminApp.style.display = 'none';
    loginScreen.classList.remove('hidden');
  }

  function tryAutoLogin() {
    const s = getSession();
    if (s) {
      adminApp.style.display = 'block';
      loginScreen.classList.add('hidden');
      startSessionTimer();
      initApp();
    } else {
      loginScreen.classList.remove('hidden');
      adminApp.style.display = 'none';
    }
  }

  // ===== LOGIN =====
  const loginScreen = document.getElementById('loginScreen');
  const adminApp = document.getElementById('adminApp');
  const loginUser = document.getElementById('loginUser');
  const loginPass = document.getElementById('loginPass');
  const btnLogin = document.getElementById('btnLogin');
  const loginError = document.getElementById('loginError');
  const btnLogout = document.getElementById('btnLogout');

  btnLogin.addEventListener('click', () => {
    const u = loginUser.value.trim();
    const p = loginPass.value.trim();
    if (u === 'adminpetfunny' && p === 'admin2605') enterAdminMode();
    else loginError.classList.remove('hidden');
  });

  [loginUser, loginPass].forEach(el => {
    el.addEventListener('keydown', (e) => { if (e.key === 'Enter') btnLogin.click(); });
  });

  btnLogout.addEventListener('click', () => {
    if (confirm('Deseja sair do painel?')) doLogout();
  });

  // ===== API HELPERS =====
  async function apiGet(path, params) {
    const url = new URL(API_BASE_URL + path, window.location.origin);
    if (params) {
      Object.keys(params).forEach(k => {
        const v = params[k];
        if (v !== undefined && v !== null && v !== '') url.searchParams.append(k, v);
      });
    }
    const resp = await fetch(url.toString());
    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) throw new Error(data.error || 'Erro ao buscar dados.');
    return data;
  }

  async function apiPost(path, body) {
    const resp = await fetch(API_BASE_URL + path, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) throw new Error(data.error || 'Erro ao salvar.');
    return data;
  }

  async function apiPut(path, body) {
    const resp = await fetch(API_BASE_URL + path, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) throw new Error(data.error || 'Erro ao atualizar.');
    return data;
  }

  async function apiDelete(path) {
    const resp = await fetch(API_BASE_URL + path, { method: 'DELETE' });
    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) throw new Error(data.error || 'Erro ao apagar.');
    return data;
  }

  function sanitizePhone(phone) { return (phone || '').replace(/\D/g, ''); }

  function formatTelefone(phone) {
    const digits = (phone || '').replace(/\D/g, '');
    if (digits.length === 11) return digits.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
    if (digits.length === 10) return digits.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
    return phone || '-';
  }

  function applyPhoneMask(input) {
    if (!input) return;
    let value = input.value.replace(/\D/g, '');
    if (value.length > 11) value = value.slice(0, 11);
    let formatted = value;
    if (value.length > 0) formatted = `(${value.slice(0, 2)}`;
    if (value.length >= 3) formatted = `(${value.slice(0, 2)}) ${value.slice(2, 3)}`;
    if (value.length >= 4) formatted = `(${value.slice(0, 2)}) ${value.slice(2, 3)} ${value.slice(3, 7)}`;
    if (value.length >= 8) formatted = `(${value.slice(0, 2)}) ${value.slice(2, 3)} ${value.slice(3, 7)}-${value.slice(7, 11)}`;
    input.value = formatted;
  }

  function formatDataBr(dataIso) {
    const parts = (dataIso || '').split('-');
    if (parts.length === 3) return parts[2] + '/' + parts[1] + '/' + parts[0];
    return dataIso || '-';
  }

  function formatDateTimeBr(iso) {
    if (!iso) return '-';
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return '-';
    const dia = String(d.getDate()).padStart(2, '0');
    const mes = String(d.getMonth() + 1).padStart(2, '0');
    const ano = d.getFullYear();
    const hora = String(d.getHours()).padStart(2, '0');
    const min = String(d.getMinutes()).padStart(2, '0');
    return `${dia}/${mes}/${ano} ${hora}:${min}`;
  }

  function toISODateOnly(date) {
    const ano = date.getFullYear();
    const mes = String(date.getMonth() + 1).padStart(2, '0');
    const dia = String(date.getDate()).padStart(2, '0');
    return `${ano}-${mes}-${dia}`;
  }

  function getPeriodRange(periodValue) {
    const hoje = new Date();
    let start = null, end = null;

    if (periodValue === 'today') {
      start = toISODateOnly(hoje);
      end = toISODateOnly(hoje);
    } else if (periodValue === '7') {
      const d = new Date(); d.setDate(d.getDate() - 6);
      start = toISODateOnly(d); end = toISODateOnly(hoje);
    } else if (periodValue === '30') {
      const d = new Date(); d.setDate(d.getDate() - 29);
      start = toISODateOnly(d); end = toISODateOnly(hoje);
    } else if (periodValue === 'month') {
      const dStart = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
      start = toISODateOnly(dStart); end = toISODateOnly(hoje);
    }
    return { start, end };
  }

  
  /* ===== Valida√ß√£o de Data/Hor√°rio (mesmas regras do index.html) ===== */
  const todayISO = new Date().toISOString().split('T')[0];

  function validarDiaHora(dateStr, timeStr) {
    if (!dateStr || !timeStr) return 'Informe a data e o hor√°rio.';

    const date = new Date(dateStr + 'T' + timeStr + ':00');
    if (Number.isNaN(date.getTime())) return 'Data ou hor√°rio inv√°lidos.';

    const diaSemana = date.getDay();
    const parts = String(timeStr).split(':');
    const hh = parseInt(parts[0], 10);
    const mm = parseInt(parts[1] || '0', 10);

    if (!Number.isFinite(hh) || !Number.isFinite(mm)) return 'Hor√°rio inv√°lido.';

    // Admin tamb√©m deve seguir a regra do cliente: somente 00 ou 30
    if (!(mm === 0 || mm === 30)) return 'Escolha um hor√°rio fechado (minutos 00 ou 30).';

    const minutos = hh * 60 + mm;
    const inicio = 7 * 60 + 30;

    if (diaSemana === 0) return 'Atendemos apenas de segunda a s√°bado.';
    if (diaSemana >= 1 && diaSemana <= 5) {
      const fim = 17 * 60 + 30;
      if (minutos < inicio || minutos > fim) return 'Segunda a sexta: hor√°rios entre 07:30 e 17:30.';
    }
    if (diaSemana === 6) {
      const fim = 13 * 60;
      if (minutos < inicio || minutos > fim) return 'S√°bado: hor√°rios entre 07:30 e 13:00.';
    }

    // N√£o permite agendar no passado (comparando data/hora local)
    const now = new Date();
    if (date.getTime() < now.getTime() - (60 * 1000)) return 'N√£o √© poss√≠vel agendar no passado.';

    return null;
  }

  function pad2(n) { return String(n).padStart(2, '0'); }

  function buildRangeForDate(dateStr) {
    if (!dateStr) return null;
    const d = new Date(dateStr + 'T00:00:00');
    if (Number.isNaN(d.getTime())) return null;
    const day = d.getDay();
    if (day === 0) return { closed: true };
    const startMin = 7 * 60 + 30;
    const endMin = (day === 6) ? (13 * 60) : (17 * 60 + 30);
    return { closed: false, startMin, endMin };
  }

  function normalizeHHMM(t) {
    const s = String(t || '').trim();
    const m = s.match(/^(\d{1,2}):(\d{1,2})/);
    if (!m) return null;
    const hh = pad2(parseInt(m[1], 10));
    const mm = pad2(parseInt(m[2], 10));
    return `${hh}:${mm}`;
  }

  function isActiveBookingStatus(status) {
    const s = normStr(status);
    // status "cancelado" n√£o ocupa slot
    return s !== 'cancelado';
  }

  async function loadOccupiedTimesForDate(dateStr, excludeBookingId) {
    const data = await apiGet('/api/bookings', { date: dateStr });
    const list = data.bookings || [];
    const set = new Set();

    list.forEach(b => {
      if (excludeBookingId != null && String(b.id) === String(excludeBookingId)) return;
      if (!isActiveBookingStatus(b.status)) return;
      const t = normalizeHHMM(b.time);
      if (t) set.add(t);
    });

    return set;
  }

  function minutesToHHMM(totalMin) {
    const hh = Math.floor(totalMin / 60);
    const mm = totalMin % 60;
    return `${pad2(hh)}:${pad2(mm)}`;
  }

  function clampToRange(timeStr, range) {
    const t = normalizeHHMM(timeStr);
    if (!t || !range || range.closed) return null;
    const [hh, mm] = t.split(':').map(n => parseInt(n, 10));
    let total = hh * 60 + mm;

    // arredonda para o slot mais pr√≥ximo (00/30)
    total = Math.round(total / 30) * 30;

    if (total < range.startMin) total = range.startMin;
    if (total > range.endMin) total = range.endMin;

    // garante que n√£o sai do padr√£o 00/30 depois do clamp
    total = Math.round(total / 30) * 30;

    return minutesToHHMM(total);
  }


  function classStatus(status) {
    const s = normStr(status);
    if (s === 'agendado') return 'status-agendado';
    if (s === 'confirmado') return 'status-confirmado';
    if (s === 'recebido') return 'status-recebido';
    if (s === 'em servico' || s === 'em servi√ßo') return 'status-em-servico';
    if (s === 'concluido' || s === 'conclu√≠do') return 'status-concluido';
    if (s === 'entregue') return 'status-entregue';
    if (s === 'cancelado') return 'status-cancelado';
    return 'status-agendado';
  }

  function buildStatusMessage(status, nome, petLabel, service, dataBR, time, prize) {
    const s = normStr(status);
    const cabecalho = `Oi ${nome}! Aqui √© do Pet Funny!\n\n`;
    let corpo = '';

    switch (s) {
      case 'agendado':
        corpo = `Acabamos de registrar o agendamento de *${petLabel}* para *${service}* em *${dataBR} √†s ${time}*.\n\nMimo da campanha Roleta de Mimos: *${prize}*.\n\nQuando estiver pr√≥ximo do dia, te avisamos por aqui.`;
        break;
      case 'confirmado':
        corpo = `Seu agendamento de *${petLabel}* para *${service}* em *${dataBR} √†s ${time}* foi *CONFIRMADO* \n\nMimo garantido: *${prize}*.\n\nQualquer altera√ß√£o √© s√≥ avisar a gente aqui no WhatsApp.`;
        break;
      case 'recebido':
        corpo = `*${petLabel}* j√° est√° aqui com a gente para *${service}* \n\nEstamos cuidando com muito carinho.\n\nMimo da vez: *${prize}*.\n\nAssim que estiver tudo pronto, te avisamos por aqui.`;
        break;
      case 'em servico':
        corpo = `Estamos cuidando de *${petLabel}* agora mesmo no *${service}* \n\nMimo aplicado: *${prize}*.\n\nDaqui a pouco estar√° pronto(a) para ser buscado(a).`;
        break;
      case 'concluido':
        corpo = `O servi√ßo de *${petLabel}* (*${service}*) foi *CONCLU√çDO* \n\nMimo aplicado: *${prize}*.\n\nQuando quiser, j√° pode vir buscar.`;
        break;
      case 'entregue':
        corpo = `Tudo entregue, e esperamos que voc√™ tenha gostado do resultado! \n\nRefer√™ncia: *${petLabel}*\nServi√ßo: *${service}*\nMimo da Roleta: *${prize}*.\n\nObrigada por confiar no Pet Funny!`;
        break;
      case 'cancelado':
        corpo = `Seu agendamento de *${petLabel}* para *${service}* em *${dataBR} √†s ${time}* foi *CANCELADO* \n\nSe quiser remarcar, √© s√≥ mandar mensagem por aqui que encontramos um novo hor√°rio.`;
        break;
      default:
        corpo = `O status do agendamento de *${petLabel}* para *${service}* em *${dataBR} √†s ${time}* foi atualizado para: *${String(status || '').toUpperCase()}*.\n\nMimo da campanha Roleta de Mimos: *${prize}*.\n\nQualquer d√∫vida, √© s√≥ chamar aqui no WhatsApp!`;
    }
    return cabecalho + corpo;
  }

  /* ===== MOEDA: m√°scara e convers√µes (value_cents) ===== */
  function formatCentsToBRL(cents) {
    const n = Number(cents || 0) / 100;
    return n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  function applyCurrencyMask(input) {
    if (!input) return;
    let raw = String(input.value || '').replace(/\D/g, '');

    // se usu√°rio apagou tudo, ok
    if (raw === '') {
      input.value = '';
      input.dataset.cents = '';
      return;
    }

    // permite zero
    raw = raw.replace(/^0+/, '');
    if (raw === '') raw = '0';

    input.dataset.cents = raw;
    input.value = formatCentsToBRL(raw);
  }

  function getCentsFromCurrencyInput(input) {
    if (!input) return null;

    // 1) tenta via dataset (m√°scara)
    let raw = String(input.dataset?.cents || '').replace(/\D/g, '');
    if (raw) {
      const cents = parseInt(raw, 10);
      return Number.isFinite(cents) ? cents : null;
    }

    // 2) fallback: tenta parsear pelo texto digitado/colado (ex: "85,00" ou "R$ 85,00" ou "85")
    const txt = String(input.value || '').trim();
    if (!txt) return null;

    const digits = txt.replace(/\s/g, '').replace(/[R$r$]/g, '');
    // se tiver v√≠rgula, assume centavos; se n√£o tiver, assume reais inteiros
    if (digits.includes(',')) {
      const cleaned = digits.replace(/\./g, '').replace(',', '.');
      const n = Number(cleaned);
      if (!Number.isFinite(n)) return null;
      return Math.round(n * 100);
    } else {
      const onlyDigits = digits.replace(/\D/g, '');
      if (!onlyDigits) return null;
      return parseInt(onlyDigits, 10) * 100;
    }
  }

  /* ===== TABS ===== */
  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabViews = document.querySelectorAll('.tab-view');

  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      tabButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const tabId = btn.getAttribute('data-tab');
      tabViews.forEach(view => view.classList.toggle('active', view.id === tabId));

      if (tabId === 'tab-servicos') loadServices().catch(console.error);
      if (tabId === 'tab-racas') loadBreeds().catch(console.error);

      if (tabId === 'tab-horarios') loadOpeningHours().catch(console.error);

      if (tabId === 'tab-dashboard') {
        loadDashboard().finally(() => {
          setTimeout(() => {
            try { if (statusChart) statusChart.resize(); } catch (_) {}
            try { if (prizeChart) prizeChart.resize(); } catch (_) {}
          }, 60);
        });
      }

      // NOVO: quando voltar para agenda, renderiza conforme view atual
      if (tabId === 'tab-agenda') {
        try { renderAgendaByView(ultimaLista || []); } catch (_) {}
      }
    });
  });

  // ===== CAMPOS AGENDA =====
  const filtroData = document.getElementById('filtroData');
  const filtroBusca = document.getElementById('filtroBusca');
  const btnHoje = document.getElementById('btnHoje');
  const btnLimparFiltro = document.getElementById('btnLimparFiltro');
  const btnExportarCSV = document.getElementById('btnExportarCSV');
  const btnNovoAgendamento = document.getElementById('btnNovoAgendamento');

  const tbodyAgenda = document.getElementById('tbodyAgenda');
  const estadoVazio = document.getElementById('estadoVazio');

  // NOVO: cards
  const agendaListWrapper = document.getElementById('agendaListWrapper');
  const agendaCardsWrapper = document.getElementById('agendaCardsWrapper');
  const agendaCards = document.getElementById('agendaCards');
  const estadoVazioCards = document.getElementById('estadoVazioCards');
  const btnViewList = document.getElementById('btnViewList');
  const btnViewCards = document.getElementById('btnViewCards');

  const statTotal = document.getElementById('statTotal');
  const statTosa = document.getElementById('statTosa');
  const statHidratacao = document.getElementById('statHidratacao');
  const statFotoVideo = document.getElementById('statFotoVideo');
  const statPatinhas = document.getElementById('statPatinhas');

  const formPanel = document.getElementById('formPanel');

  const bookingId = document.getElementById('bookingId');
  const bookingOriginalStatus = document.getElementById('bookingOriginalStatus');
  const formPhone = document.getElementById('formPhone');
  const formNome = document.getElementById('formNome');
  const formPetSelect = document.getElementById('formPetSelect');
  const formPrize = document.getElementById('formPrize');
  const formService = document.getElementById('formService');
  const formDate = document.getElementById('formDate');
  const formTime = document.getElementById('formTime');

  // Regras padr√£o (mesmas do cliente)
  if (formDate) formDate.min = todayISO;
  if (formTime) formTime.step = 1800; // 30 minutos


  // Revalida e aplica limites quando a data/hor√°rio mudam
  if (formDate) {
    formDate.addEventListener('change', async () => {
      const excludeId = bookingId && bookingId.value ? Number(bookingId.value) : null;
      await refreshBookingDateTimeState(excludeId);
    });
  }

  if (formTime) {
    // arredonda para 00/30 e aplica faixa do dia
    formTime.addEventListener('blur', () => {
      const range = buildRangeForDate(formDate ? formDate.value : '');
      const clamped = clampToRange(formTime.value, range);
      if (clamped) formTime.value = clamped;
    });
  }
  const formStatus = document.getElementById('formStatus');
  const formNotes = document.getElementById('formNotes');
  const formError = document.getElementById('formError');
  const btnSalvar = document.getElementById('btnSalvar');
  const btnCancelarEdicao = document.getElementById('btnCancelarEdicao');

  // ===== DASHBOARD =====
  const dashPeriod = document.getElementById('dashPeriod');
  const dashCustomRange = document.getElementById('dashCustomRange');
  const dashStart = document.getElementById('dashStart');
  const dashEnd = document.getElementById('dashEnd');
  const dashApply = document.getElementById('dashApply');

  const dashTotalBookings = document.getElementById('dashTotalBookings');
  const dashUniqueCustomers = document.getElementById('dashUniqueCustomers');
  const dashTotalCustomers = document.getElementById('dashTotalCustomers');

  const dashStatusAgendado = document.getElementById('dashStatusAgendado');
  const dashStatusConfirmado = document.getElementById('dashStatusConfirmado');
  const dashStatusRecebido = document.getElementById('dashStatusRecebido');
  const dashStatusEmServico = document.getElementById('dashStatusEmServico');
  const dashStatusConcluido = document.getElementById('dashStatusConcluido');
  const dashStatusEntregue = document.getElementById('dashStatusEntregue');
  const dashStatusCancelado = document.getElementById('dashStatusCancelado');

  const dashPrizeTosa = document.getElementById('dashPrizeTosa');
  const dashPrizeHidratacao = document.getElementById('dashPrizeHidratacao');
  const dashPrizeFotoVideo = document.getElementById('dashPrizeFotoVideo');
  const dashPrizePatinhas = document.getElementById('dashPrizePatinhas');

  const tbodyDashServices = document.getElementById('tbodyDashServices');
  const dashServicesEmpty = document.getElementById('dashServicesEmpty');
  const dashRevenue = document.getElementById('dashRevenue');
  const dashAvgTicket = document.getElementById('dashAvgTicket');

  let ultimaLista = [];
  let clientesCache = [];
  let clienteSelecionadoId = null;
  let petsCache = [];
  let petEditIdLocal = null;

  function setEditMode(isEdit) {
    // Em edi√ß√£o: mant√©m Tutor/Telefone travados, mas permite editar Pet e Mimo
    formPhone.disabled = isEdit;
    formNome.disabled = isEdit;
    formPetSelect.disabled = false;
    formPrize.disabled = false;
  }

  /* ===== Estado de disponibilidade (Admin) ===== */
  let occupiedTimesSet = new Set();

  async function refreshBookingDateTimeState(excludeBookingId) {
    if (!formDate || !formTime) return;

    const dateStr = formDate.value;
    if (!dateStr) return;

    const range = buildRangeForDate(dateStr);
    if (!range || range.closed) {
      formTime.disabled = true;
      formTime.value = '';
      occupiedTimesSet = new Set();
      return;
    }

    formTime.disabled = false;
    formTime.step = 1800; // 30 min

    formTime.min = minutesToHHMM(range.startMin);
    formTime.max = minutesToHHMM(range.endMin);

    // carrega hor√°rios ocupados do dia (exclui o pr√≥prio agendamento em edi√ß√£o)
    try {
      occupiedTimesSet = await loadOccupiedTimesForDate(dateStr, excludeBookingId);
    } catch (e) {
      console.warn('Falha ao carregar hor√°rios ocupados:', e);
      occupiedTimesSet = new Set();
    }

    // ajusta (clamp) se estiver fora da faixa / minutos diferentes de 00/30
    if (formTime.value) {
      const clamped = clampToRange(formTime.value, range);
      if (clamped) formTime.value = clamped;
    }
  }

  function isTimeOccupied(timeStr) {
    const t = normalizeHHMM(timeStr);
    return !!t && occupiedTimesSet.has(t);
  }

  function mostrarFormAgenda() { formPanel.classList.remove('hidden'); }
  function esconderFormAgenda() { formPanel.classList.add('hidden'); }

  async function fetchBookings() {
    const params = {};
    if (filtroData.value) params.date = filtroData.value;
    if (filtroBusca.value.trim()) params.search = filtroBusca.value.trim();
    const data = await apiGet('/api/bookings', params);
    return data.bookings || [];
  }

  function atualizaEstatisticas(lista) {
    const total = lista.length;
    let tosa = 0, hidratacao = 0, fotoVideo = 0, patinhas = 0;

    lista.forEach(a => {
      switch (a.prize) {
        case 'Tosa Higi√™nica': tosa++; break;
        case 'Hidrata√ß√£o': hidratacao++; break;
        case 'Foto e V√≠deo Profissional': fotoVideo++; break;
        case 'Patinhas impec√°veis': patinhas++; break;
      }
    });

    statTotal.textContent = total;
    statTosa.textContent = tosa;
    statHidratacao.textContent = hidratacao;
    statFotoVideo.textContent = fotoVideo;
    statPatinhas.textContent = patinhas;
  }

  // ===== GR√ÅFICOS =====
  let statusChart = null;
  let prizeChart = null;

  function renderCharts(bookings) {
    const statusCounts = { agendado:0, confirmado:0, recebido:0, em_servico:0, concluido:0, entregue:0, cancelado:0 };
    const prizeCounts = { 'Tosa Higi√™nica':0, 'Hidrata√ß√£o':0, 'Foto e V√≠deo Profissional':0, 'Patinhas impec√°veis':0 };

    bookings.forEach(b => {
      const s = normStr(b.status);
      if (s === 'agendado') statusCounts.agendado++;
      else if (s === 'confirmado') statusCounts.confirmado++;
      else if (s === 'recebido') statusCounts.recebido++;
      else if (s === 'em servico') statusCounts.em_servico++;
      else if (s === 'concluido') statusCounts.concluido++;
      else if (s === 'entregue') statusCounts.entregue++;
      else if (s === 'cancelado') statusCounts.cancelado++;

      const p = b.prize || '';
      if (prizeCounts.hasOwnProperty(p)) prizeCounts[p]++;
    });

    const ctxStatusEl = document.getElementById('chartStatus');
    const ctxPrizesEl = document.getElementById('chartPrizes');
    if (!ctxStatusEl || !ctxPrizesEl) return;

    const ctxStatus = ctxStatusEl.getContext('2d');
    const ctxPrizes = ctxPrizesEl.getContext('2d');

    if (statusChart) statusChart.destroy();
    if (prizeChart) prizeChart.destroy();

    statusChart = new Chart(ctxStatus, {
      type: 'bar',
      data: {
        labels: ['Agendado','Confirmado','Recebido','Em servi√ßo','Conclu√≠do','Entregue','Cancelado'],
        datasets: [{
          label: 'Agendamentos',
          data: [
            statusCounts.agendado,
            statusCounts.confirmado,
            statusCounts.recebido,
            statusCounts.em_servico,
            statusCounts.concluido,
            statusCounts.entregue,
            statusCounts.cancelado
          ]
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { font: { size: 10 } } },
          y: { beginAtZero: true, precision: 0 }
        }
      }
    });

    prizeChart = new Chart(ctxPrizes, {
      type: 'doughnut',
      data: {
        labels: Object.keys(prizeCounts),
        datasets: [{ data: Object.values(prizeCounts) }]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'bottom' } }
      }
    });
  }

  /* ===== PETS no SELECT (Agenda) ===== */
  async function loadPetsForCustomer(customerId) {
    const data = await apiGet('/api/pets', { customer_id: customerId });
    const pets = (data.pets || []);
    formPetSelect.innerHTML = '<option value="">(Sem pet informado)</option>';
    pets.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.breed ? `${p.name} (${p.breed})` : p.name;
      formPetSelect.appendChild(opt);
    });
    return pets;
  }

  function preencherFormEdicao(booking) {
    bookingId.value = booking.id;
    bookingOriginalStatus.value = booking.status || 'agendado';

    formPhone.value = booking.phone || '';
    formNome.value = booking.customer_name || '';
    formPrize.value = booking.prize || 'Tosa Higi√™nica';

    // servi√ßo (prefer√™ncia: service_id)
    const sid = booking.service_id ?? booking.serviceId ?? '';
    if (sid && String(sid) !== 'null') formService.value = String(sid);
    else {
      // fallback: tenta casar pelo texto
      const txt = booking.service || booking.service_title || '';
      const match = servicesCache.find(s => normStr(s.title) === normStr(txt));
      formService.value = match ? String(match.id) : '';
      
    // Atualiza limites e disponibilidade para a data (exclui o pr√≥prio agendamento)
    refreshBookingDateTimeState(booking.id);
  }

    formDate.value = booking.date || '';
    formTime.value = booking.time || '';
    formStatus.value = booking.status || 'agendado';
    formNotes.value = booking.notes || '';
    formError.style.display = 'none';

    setEditMode(true);

    const customerId = booking.customer_id || booking.customerId;
    const bookingPetId = booking.pet_id ?? booking.petId;
    const bookingPetName = booking.pet_name || booking.petName;

    formPetSelect.innerHTML = '<option value="">(Sem pet informado)</option>';

    if (customerId) {
      loadPetsForCustomer(customerId)
        .then(() => {
          if (bookingPetId != null) formPetSelect.value = String(bookingPetId);
          else formPetSelect.value = '';
          if (bookingPetId == null && bookingPetName) {
            // mant√©m sem pet selecionado; mensagem WhatsApp usa fallback "seu pet"
          }
        })
        .catch(() => {});
    }

    mostrarFormAgenda();
    refreshBookingDateTimeState(null);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  /* ===== Servi√ßos (cache, dropdown e CRUD) ===== */
  const btnNovoServico = document.getElementById('btnNovoServico');
  const serviceFormPanel = document.getElementById('serviceFormPanel');
  const serviceId = document.getElementById('serviceId');
  const serviceDate = document.getElementById('serviceDate');
  const serviceTitle = document.getElementById('serviceTitle');
  const servicePrice = document.getElementById('servicePrice');
  const serviceError = document.getElementById('serviceError');
  const btnServiceCancel = document.getElementById('btnServiceCancel');
  const btnServiceSave = document.getElementById('btnServiceSave');
  const tbodyServices = document.getElementById('tbodyServices');
  const servicesEmpty = document.getElementById('servicesEmpty');

  // Filtro de busca (Servi√ßos)
  const filtroServicos = document.getElementById('filtroServicos');
  const btnLimparServicos = document.getElementById('btnLimparServicos');
  let filtroServicosTxt = '';


  let servicesCache = []; // [{id,title,value_cents,...}]

  function showServiceForm() { serviceFormPanel.classList.remove('hidden'); }
  function hideServiceForm() { serviceFormPanel.classList.add('hidden'); }

  function clearServiceForm() {
    serviceId.value = '';
    serviceDate.value = toISODateOnly(new Date());
    serviceTitle.value = '';
    servicePrice.value = '';
    servicePrice.dataset.cents = '';
    serviceError.style.display = 'none';
    serviceError.textContent = '';
  }

  function fillServiceForm(svc) {
    serviceId.value = svc.id;
    serviceDate.value = (svc.date || '').slice(0, 10);
    serviceTitle.value = svc.title || '';
    servicePrice.dataset.cents = String(svc.value_cents ?? '');
    servicePrice.value = svc.value_cents != null ? formatCentsToBRL(svc.value_cents) : '';
    serviceError.style.display = 'none';
    serviceError.textContent = '';
  }

  function renderServices() {
    tbodyServices.innerHTML = '';

    const list = (servicesCache || []).filter(s => {
      if (!filtroServicosTxt) return true;
      const hay = normStr((s.title || ''));
      return hay.includes(filtroServicosTxt);
    });

    servicesEmpty.style.display = list.length ? 'none' : 'block';

    list.forEach(svc => {
      const tr = document.createElement('tr');

      const tdId = document.createElement('td'); tdId.textContent = svc.id;
      const tdDate = document.createElement('td'); tdDate.textContent = formatDataBr((svc.date || '').slice(0,10));
      const tdTitle = document.createElement('td'); tdTitle.textContent = svc.title || '-';
      const tdPrice = document.createElement('td'); tdPrice.textContent = formatCentsToBRL(svc.value_cents || 0);

      const tdCreated = document.createElement('td'); tdCreated.textContent = svc.created_at ? formatDateTimeBr(svc.created_at) : '-';
      const tdUpdated = document.createElement('td'); tdUpdated.textContent = svc.updated_at ? formatDateTimeBr(svc.updated_at) : '-';

      const tdAcoes = document.createElement('td');
      const divActions = document.createElement('div'); divActions.className = 'actions';

      const btnEdit = document.createElement('button');
      btnEdit.textContent = 'Editar';
      btnEdit.className = 'btn btn-small btn-secondary';
      btnEdit.type = 'button';
      btnEdit.addEventListener('click', () => {
        fillServiceForm(svc);
        showServiceForm();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });

      const btnDel = document.createElement('button');
      btnDel.textContent = 'Excluir';
      btnDel.className = 'btn btn-small btn-danger';
      btnDel.type = 'button';
      btnDel.addEventListener('click', async () => {
        if (!confirm('Deseja realmente excluir este servi√ßo?')) return;
        try {
          await apiDelete('/api/services/' + svc.id);
          await loadServices();
          await loadDashboard();
        } catch (e) { alert(e.message); }
      });

      divActions.appendChild(btnEdit);
      divActions.appendChild(btnDel);
      tdAcoes.appendChild(divActions);

      tr.appendChild(tdId);
      tr.appendChild(tdDate);
      tr.appendChild(tdTitle);
      tr.appendChild(tdPrice);
      tr.appendChild(tdCreated);
      tr.appendChild(tdUpdated);
      tr.appendChild(tdAcoes);

      tbodyServices.appendChild(tr);
    });
  }

  function refreshServiceOptionsInAgenda() {
    // mant√©m sele√ß√£o atual se poss√≠vel
    const current = formService.value || '';
    formService.innerHTML = '<option value="">Selecione...</option>';
    servicesCache.forEach(s => {
      const opt = document.createElement('option');
      opt.value = String(s.id);
      opt.textContent = s.title;
      formService.appendChild(opt);
    });
    if (current) formService.value = current;
  }

  async function loadServices() {
    try {
      const data = await apiGet('/api/services');
      servicesCache = data.services || [];
      renderServices();
      refreshServiceOptionsInAgenda();
    } catch (e) {
      servicesCache = [];
      renderServices();
      refreshServiceOptionsInAgenda();
      servicesEmpty.style.display = 'block';
      servicesEmpty.textContent = 'Erro ao carregar servi√ßos: ' + e.message;
    }
  }

  async function saveService() {
    serviceError.style.display = 'none';
    serviceError.textContent = '';

    const id = serviceId.value ? parseInt(serviceId.value, 10) : null;
    const date = serviceDate.value;
    const title = serviceTitle.value.trim();

    // garante dataset.cents sempre atualizado antes de validar
    applyCurrencyMask(servicePrice);
    const value_cents = getCentsFromCurrencyInput(servicePrice);

    if (!date || !title) {
      serviceError.textContent = 'Preencha data e t√≠tulo do servi√ßo.';
      serviceError.style.display = 'block';
      return;
    }
    if (value_cents == null || value_cents < 0) {
      serviceError.textContent = 'Valor inv√°lido. Digite no formato moeda (ex: 85,00).';
      serviceError.style.display = 'block';
      return;
    }

    try {
      const body = { date, title, value_cents };
      if (!id) await apiPost('/api/services', body);
      else await apiPut('/api/services/' + id, body);

      clearServiceForm();
      hideServiceForm();
      await loadServices();
      await loadDashboard();
    } catch (e) {
      serviceError.textContent = e.message;
      serviceError.style.display = 'block';
    }
  }

  if (btnNovoServico) {
    btnNovoServico.addEventListener('click', () => {
      clearServiceForm();
      showServiceForm();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  }
  if (btnServiceCancel) btnServiceCancel.addEventListener('click', () => { clearServiceForm(); hideServiceForm(); });
  if (btnServiceSave) btnServiceSave.addEventListener('click', saveService);

  // M√°scara do valor de servi√ßo
  if (servicePrice) {
    servicePrice.addEventListener('input', () => applyCurrencyMask(servicePrice));
  }


  if (filtroServicos) {
    filtroServicos.addEventListener('input', () => {
      filtroServicosTxt = normStr(filtroServicos.value);
      renderServices();
    });
  }
  if (btnLimparServicos) {
    btnLimparServicos.addEventListener('click', () => {
      if (filtroServicos) filtroServicos.value = '';
      filtroServicosTxt = '';
      renderServices();
    });
  }


  /* ===== Ra√ßas de C√£es (CRUD) ===== */
  const btnNovoBreed = document.getElementById('btnNovoBreed');
  const breedSearch = document.getElementById('breedSearch');
  const breedFormPanel = document.getElementById('breedFormPanel');
  const breedId = document.getElementById('breedId');
  const breedName = document.getElementById('breedName');
  const breedSize = document.getElementById('breedSize');
  const breedCoat = document.getElementById('breedCoat');
  const breedHistory = document.getElementById('breedHistory');
  const breedError = document.getElementById('breedError');
  const btnBreedCancel = document.getElementById('btnBreedCancel');
  const btnBreedSave = document.getElementById('btnBreedSave');
  const tbodyBreeds = document.getElementById('tbodyBreeds');
  const breedsEmpty = document.getElementById('breedsEmpty');

  let breedsCache = []; // [{id,name,size,coat,history,created_at,updated_at}]

  function showBreedForm() { breedFormPanel.classList.remove('hidden'); }
  function hideBreedForm() { breedFormPanel.classList.add('hidden'); }

  function clearBreedForm() {
    breedId.value = '';
    breedName.value = '';
    breedSize.value = 'pequeno';
    breedCoat.value = 'curta';
    breedHistory.value = '';
    if (breedError) { breedError.style.display = 'none'; breedError.textContent = ''; }
  }

  function fillBreedForm(b) {
    breedId.value = b.id;
    breedName.value = b.name || '';
    breedSize.value = (b.size || 'pequeno');
    breedCoat.value = (b.coat || 'curta');
    breedHistory.value = b.history || '';
    if (breedError) { breedError.style.display = 'none'; breedError.textContent = ''; }
  }

  function humanSize(v) {
    const s = normStr(v);
    if (s === 'pequeno') return 'Pequeno';
    if (s === 'medio' || s === 'm√©dio') return 'M√©dio';
    if (s === 'grande') return 'Grande';
    return v || '-';
  }

  function humanCoat(v) {
    const s = normStr(v);
    if (s === 'curta') return 'Curta';
    if (s === 'media' || s === 'm√©dia') return 'M√©dia';
    if (s === 'longa') return 'Longa';
    return v || '-';
  }

  function renderBreeds() {
    if (!tbodyBreeds) return;
    tbodyBreeds.innerHTML = '';

    const q = normStr(breedSearch?.value || '');
    const list = !q ? breedsCache : breedsCache.filter(b =>
      normStr(b.name).includes(q) ||
      normStr(b.size).includes(q) ||
      normStr(b.coat).includes(q) ||
      normStr(b.history).includes(q)
    );

    if (breedsEmpty) breedsEmpty.style.display = list.length ? 'none' : 'block';

    list.forEach(b => {
      const tr = document.createElement('tr');

      const tdId = document.createElement('td'); tdId.textContent = b.id;
      const tdName = document.createElement('td'); tdName.textContent = b.name || '-';
      const tdSize = document.createElement('td'); tdSize.textContent = humanSize(b.size);
      const tdCoat = document.createElement('td'); tdCoat.textContent = humanCoat(b.coat);

      const tdHist = document.createElement('td');
      const full = (b.history || '').trim();
      tdHist.textContent = full.length > 140 ? (full.slice(0, 140) + '‚Ä¶') : (full || '-');
      tdHist.className = 'td-obs';
      tdHist.title = full;

      const tdCreated = document.createElement('td'); tdCreated.textContent = b.created_at ? formatDateTimeBr(b.created_at) : '-';
      const tdUpdated = document.createElement('td'); tdUpdated.textContent = b.updated_at ? formatDateTimeBr(b.updated_at) : '-';

      const tdAcoes = document.createElement('td');
      const divActions = document.createElement('div'); divActions.className = 'actions';

      const btnEdit = document.createElement('button');
      btnEdit.textContent = 'Editar';
      btnEdit.className = 'btn btn-small btn-secondary';
      btnEdit.type = 'button';
      btnEdit.addEventListener('click', () => {
        fillBreedForm(b);
        showBreedForm();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });

      const btnDel = document.createElement('button');
      btnDel.textContent = 'Excluir';
      btnDel.className = 'btn btn-small btn-danger';
      btnDel.type = 'button';
      btnDel.addEventListener('click', async () => {
        if (!confirm('Deseja realmente excluir esta ra√ßa?')) return;
        try {
          await apiDelete('/api/breeds/' + b.id);
          await loadBreeds();
        } catch (e) { alert(e.message); }
      });

      divActions.appendChild(btnEdit);
      divActions.appendChild(btnDel);
      tdAcoes.appendChild(divActions);

      tr.appendChild(tdId);
      tr.appendChild(tdName);
      tr.appendChild(tdSize);
      tr.appendChild(tdCoat);
      tr.appendChild(tdHist);
      tr.appendChild(tdCreated);
      tr.appendChild(tdUpdated);
      tr.appendChild(tdAcoes);

      tbodyBreeds.appendChild(tr);
    });
  }

  async function loadBreeds() {
    try {
      const data = await apiGet('/api/breeds');
      breedsCache = data.breeds || [];
      renderBreeds();
    } catch (e) {
      breedsCache = [];
      renderBreeds();
      if (breedsEmpty) {
        breedsEmpty.style.display = 'block';
        breedsEmpty.textContent = 'Erro ao carregar ra√ßas: ' + e.message;
      }
    }
  }

  async function saveBreed() {
    if (breedError) { breedError.style.display = 'none'; breedError.textContent = ''; }

    const id = breedId.value ? parseInt(breedId.value, 10) : null;
    const name = (breedName.value || '').trim();
    const size = breedSize.value;
    const coat = breedCoat.value;
    const history = (breedHistory.value || '').trim();

    if (!name) {
      if (breedError) { breedError.textContent = 'Informe o nome da ra√ßa.'; breedError.style.display = 'block'; }
      return;
    }
    if (!size || !coat) {
      if (breedError) { breedError.textContent = 'Informe porte e pelagem.'; breedError.style.display = 'block'; }
      return;
    }

    try {
      const body = { name, size, coat, history };
      if (!id) await apiPost('/api/breeds', body);
      else await apiPut('/api/breeds/' + id, body);

      clearBreedForm();
      hideBreedForm();
      await loadBreeds();
    } catch (e) {
      if (breedError) { breedError.textContent = e.message; breedError.style.display = 'block'; }
    }
  }

  if (btnNovoBreed) {
    btnNovoBreed.addEventListener('click', () => {
      clearBreedForm();
      showBreedForm();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  }
  if (btnBreedCancel) btnBreedCancel.addEventListener('click', () => { clearBreedForm(); hideBreedForm(); });
  if (btnBreedSave) btnBreedSave.addEventListener('click', saveBreed);

  if (breedSearch) {
    breedSearch.addEventListener('input', () => {
      clearTimeout(window.__breedTimer);
      window.__breedTimer = setTimeout(() => renderBreeds(), 120);
    });
  }


  /* ===== NOVO: Agenda - Toggle Lista/Cards ===== */
  const AGENDA_VIEW_KEY = 'pf_admin_agenda_view';
  let agendaView = 'list';

  function initAgendaViewToggle() {
    try {
      const saved = localStorage.getItem(AGENDA_VIEW_KEY);
      if (saved === 'cards' || saved === 'list') agendaView = saved;
    } catch (_) {}

    applyAgendaViewUI(agendaView);

    if (btnViewList) btnViewList.addEventListener('click', () => setAgendaView('list'));
    if (btnViewCards) btnViewCards.addEventListener('click', () => setAgendaView('cards'));
  }

  function setAgendaView(view) {
    agendaView = (view === 'cards') ? 'cards' : 'list';
    try { localStorage.setItem(AGENDA_VIEW_KEY, agendaView); } catch (_) {}
    applyAgendaViewUI(agendaView);
    renderAgendaByView(ultimaLista || []);
  }

  function applyAgendaViewUI(view) {
    if (!agendaListWrapper || !agendaCardsWrapper) return;

    const isCards = (view === 'cards');

    agendaListWrapper.classList.toggle('hidden', isCards);
    agendaCardsWrapper.classList.toggle('hidden', !isCards);

    if (btnViewList) btnViewList.classList.toggle('active', !isCards);
    if (btnViewCards) btnViewCards.classList.toggle('active', isCards);
  }

  function getServiceLabelFromBooking(a) {
    let serviceLabel = a.service || a.service_title || '-';
    const sid = a.service_id ?? a.serviceId ?? null;

    if (sid != null) {
      const svc = servicesCache.find(s => String(s.id) === String(sid));
      if (svc) serviceLabel = svc.title;
    } else {
      const match = servicesCache.find(s => normStr(s.title) === normStr(serviceLabel));
      if (match) serviceLabel = match.title;
    }
    return serviceLabel;
  }

  function renderAgendaByView(lista) {
    // vazio: atualiza ambos estados para evitar inconsist√™ncias
    const isEmpty = !lista || !lista.length;

    if (agendaView === 'cards') {
      renderAgendaCards(lista || []);
      if (estadoVazio) estadoVazio.style.display = 'none';
      if (estadoVazioCards) estadoVazioCards.classList.toggle('hidden', !isEmpty);
    } else {
      renderAgendaList(lista || []);
      if (estadoVazioCards) estadoVazioCards.classList.add('hidden');
      if (estadoVazio) estadoVazio.style.display = isEmpty ? 'block' : 'none';
    }
  }

  function renderAgendaList(lista) {
    tbodyAgenda.innerHTML = '';
    estadoVazio.style.display = lista.length ? 'none' : 'block';

    lista.forEach(a => {
      const tr = document.createElement('tr');

      const tdData = document.createElement('td'); tdData.textContent = formatDataBr(a.date);
      const tdHora = document.createElement('td'); tdHora.textContent = a.time || '-';
      const tdTutor = document.createElement('td'); tdTutor.textContent = a.customer_name || '-';
      const tdPet = document.createElement('td'); tdPet.textContent = a.pet_name || '-';
      const tdTel = document.createElement('td'); tdTel.textContent = formatTelefone(a.phone);

      const tdServ = document.createElement('td'); tdServ.textContent = getServiceLabelFromBooking(a);

      const tdMimo = document.createElement('td');
      tdMimo.textContent = a.prize || '-';
      tdMimo.className = 'td-mimo';

      const tdStatus = document.createElement('td');
      const spanStatus = document.createElement('span');
      const labelStatus = (a.status || 'agendado');
      spanStatus.textContent = labelStatus;
      spanStatus.className = 'td-status ' + classStatus(labelStatus);
      tdStatus.appendChild(spanStatus);

      const tdNotif = document.createElement('td');
      tdNotif.textContent = a.last_notification_at ? formatDateTimeBr(a.last_notification_at) : '-';

      const tdObs = document.createElement('td');
      tdObs.textContent = a.notes || '';
      tdObs.className = 'td-obs';

      const tdAcoes = document.createElement('td');
      const divActions = document.createElement('div');
      divActions.className = 'actions';

      const btnEditar = document.createElement('button');
      btnEditar.textContent = 'Editar';
      btnEditar.className = 'btn btn-small btn-secondary';
      btnEditar.type = 'button';
      btnEditar.addEventListener('click', () => preencherFormEdicao(a));

      const btnExcluir = document.createElement('button');
      btnExcluir.textContent = 'Excluir';
      btnExcluir.className = 'btn btn-small btn-danger';
      btnExcluir.type = 'button';
      btnExcluir.addEventListener('click', async () => {
        if (!confirm('Deseja realmente excluir este agendamento?')) return;
        try {
          await apiDelete('/api/bookings/' + a.id);
          await renderTabela();
          await loadDashboard();
        } catch (e) { alert(e.message); }
      });

      divActions.appendChild(btnEditar);
      divActions.appendChild(btnExcluir);
      tdAcoes.appendChild(divActions);

      tr.appendChild(tdData);
      tr.appendChild(tdHora);
      tr.appendChild(tdTutor);
      tr.appendChild(tdPet);
      tr.appendChild(tdTel);
      tr.appendChild(tdServ);
      tr.appendChild(tdMimo);
      tr.appendChild(tdStatus);
      tr.appendChild(tdNotif);
      tr.appendChild(tdObs);
      tr.appendChild(tdAcoes);

      tbodyAgenda.appendChild(tr);
    });
  }

  function renderAgendaCards(lista) {
    if (!agendaCards) return;

    agendaCards.innerHTML = '';
    const isEmpty = !lista.length;
    if (estadoVazioCards) estadoVazioCards.classList.toggle('hidden', !isEmpty);

    lista.forEach(a => {
      const card = document.createElement('div');
      card.className = 'agenda-card';

      const top = document.createElement('div');
      top.className = 'agenda-card-top';

      const left = document.createElement('div');
      const timeWrap = document.createElement('div');
      timeWrap.className = 'agenda-card-time';
      timeWrap.textContent = `‚è∞ ${a.time || '-'}`;

      const dateWrap = document.createElement('div');
      dateWrap.className = 'agenda-card-date';
      dateWrap.textContent = `üìÖ ${formatDataBr(a.date)}`;

      left.appendChild(timeWrap);
      left.appendChild(dateWrap);

      const statusWrap = document.createElement('div');
      const spanStatus = document.createElement('span');
      const labelStatus = (a.status || 'agendado');
      spanStatus.textContent = labelStatus;
      spanStatus.className = 'td-status ' + classStatus(labelStatus);
      statusWrap.appendChild(spanStatus);

      top.appendChild(left);
      top.appendChild(statusWrap);

      const main = document.createElement('div');
      main.className = 'agenda-card-main';

      const serviceLabel = getServiceLabelFromBooking(a);

      const l1 = document.createElement('div');
      l1.className = 'agenda-line';
      l1.innerHTML = `<span class="agenda-key">Tutor:</span> <span class="agenda-val">${(a.customer_name || '-')}</span>`;

      const l2 = document.createElement('div');
      l2.className = 'agenda-line';
      l2.innerHTML = `<span class="agenda-key">Pet:</span> <span class="agenda-muted">${(a.pet_name || '-')}</span>`;

      const l3 = document.createElement('div');
      l3.className = 'agenda-line';
      l3.innerHTML = `<span class="agenda-key">Tel:</span> <span class="agenda-muted">${formatTelefone(a.phone)}</span>`;

      const l4 = document.createElement('div');
      l4.className = 'agenda-line';
      l4.innerHTML = `<span class="agenda-key">Servi√ßo:</span> <span class="agenda-val">${serviceLabel}</span>`;

      const l5 = document.createElement('div');
      l5.className = 'agenda-line';
      l5.innerHTML = `<span class="agenda-key">Mimo:</span> <span class="agenda-val" style="color:var(--turquesa)">${(a.prize || '-')}</span>`;

      const l6 = document.createElement('div');
      l6.className = 'agenda-line';
      l6.innerHTML = `<span class="agenda-key">Notif:</span> <span class="agenda-muted">${a.last_notification_at ? formatDateTimeBr(a.last_notification_at) : '-'}</span>`;

      main.appendChild(l1);
      main.appendChild(l2);
      main.appendChild(l3);
      main.appendChild(l4);
      main.appendChild(l5);
      main.appendChild(l6);

      const notes = document.createElement('div');
      notes.className = 'agenda-card-notes';
      notes.textContent = (a.notes || '').trim() ? a.notes : 'Sem observa√ß√µes.';

      const bottom = document.createElement('div');
      bottom.className = 'agenda-card-bottom';

      const actions = document.createElement('div');
      actions.className = 'actions';

      const btnEditar = document.createElement('button');
      btnEditar.textContent = 'Editar';
      btnEditar.className = 'btn btn-small btn-secondary';
      btnEditar.type = 'button';
      btnEditar.addEventListener('click', () => preencherFormEdicao(a));

      const btnExcluir = document.createElement('button');
      btnExcluir.textContent = 'Excluir';
      btnExcluir.className = 'btn btn-small btn-danger';
      btnExcluir.type = 'button';
      btnExcluir.addEventListener('click', async () => {
        if (!confirm('Deseja realmente excluir este agendamento?')) return;
        try {
          await apiDelete('/api/bookings/' + a.id);
          await renderTabela();
          await loadDashboard();
        } catch (e) { alert(e.message); }
      });

      actions.appendChild(btnEditar);
      actions.appendChild(btnExcluir);

      bottom.appendChild(actions);

      card.appendChild(top);
      card.appendChild(main);
      card.appendChild(notes);
      card.appendChild(bottom);

      agendaCards.appendChild(card);
    });
  }

  /* ===== Agenda: render e salvar ===== */
  async function renderTabela() {
    try {
      const lista = await fetchBookings();
      ultimaLista = lista;

      // renderiza conforme view selecionada
      renderAgendaByView(lista);
      atualizaEstatisticas(lista);
    } catch (e) {
      // zera listagem e cards
      ultimaLista = [];
      tbodyAgenda.innerHTML = '';
      if (agendaCards) agendaCards.innerHTML = '';

      if (estadoVazio) {
        estadoVazio.style.display = 'block';
        estadoVazio.textContent = 'Erro ao carregar agendamentos: ' + e.message;
      }
      if (estadoVazioCards) {
        estadoVazioCards.classList.remove('hidden');
        estadoVazioCards.textContent = 'Erro ao carregar agendamentos: ' + e.message;
      }

      statTotal.textContent = '0';
      statTosa.textContent = '0';
      statHidratacao.textContent = '0';
      statFotoVideo.textContent = '0';
      statPatinhas.textContent = '0';
    }
  }

  function limparForm() {
    bookingId.value = '';
    bookingOriginalStatus.value = 'agendado';
    formPhone.value = '';
    formNome.value = '';
    formPetSelect.innerHTML = '<option value="">(Sem pet informado)</option>';
    formPrize.value = '';
    formService.value = '';
    formDate.value = '';
    formTime.value = '';
    formStatus.value = 'agendado';
    formNotes.value = '';
    formError.style.display = 'none';
    formError.textContent = '';
    setEditMode(false);
  }

  async function salvarAgendamento() {
    formError.style.display = 'none';
    formError.textContent = '';

    const id = bookingId.value || null;
    const originalStatus = bookingOriginalStatus.value || 'agendado';

    const rawPhone = formPhone.value.trim();
    const phone = sanitizePhone(rawPhone);
    const nome = formNome.value.trim();

    const petIdRaw = formPetSelect.value;
    const petIdNum = petIdRaw ? parseInt(petIdRaw, 10) : null;

    const prize = formPrize.value;

    // servi√ßo selecionado do banco (id)
    const serviceIdSelected = formService.value ? parseInt(formService.value, 10) : null;
    const serviceObj = serviceIdSelected ? servicesCache.find(s => String(s.id) === String(serviceIdSelected)) : null;
    const serviceTitleSelected = serviceObj ? serviceObj.title : '';

    const date = formDate.value;
    const time = formTime.value;

    // Valida√ß√£o de data/hor√°rio (mesmas regras do cliente)
    const dtMsg = validarDiaHora(date, time);
    if (dtMsg) {
      formError.textContent = dtMsg;
      formError.style.display = 'block';
      return;
    }

    // Carrega hor√°rios ocupados do dia e bloqueia conflito
    await refreshBookingDateTimeState(id);
    if (isTimeOccupied(time)) {
      formError.textContent = 'Hor√°rio indispon√≠vel para esta data. Selecione outro hor√°rio.';
      formError.style.display = 'block';
      return;
    }

    const status = formStatus.value;
    const notes = formNotes.value.trim();

    if (!date || !time || !serviceIdSelected) {
      formError.textContent = 'Data, hor√°rio e servi√ßo s√£o obrigat√≥rios.';
      formError.style.display = 'block';
      return;
    }
    if (!prize) {
      formError.textContent = 'Selecione um mimo (Roleta).';
      formError.style.display = 'block';
      return;
    }
    // Novo agendamento: Pet obrigat√≥rio
    if (!id && !petIdNum) {
      formError.textContent = 'Para NOVO agendamento, selecione um pet.';
      formError.style.display = 'block';
      return;
    }
    if (!phone || phone.length < 10 || !nome) {
      formError.textContent = 'Preencha telefone (com DDD) e nome do tutor.';
      formError.style.display = 'block';
      return;
    }

    try {
      let customer = null;
      try {
        const lookup = await apiPost('/api/customers/lookup', { phone });
        if (lookup.exists && lookup.customer) customer = lookup.customer;
      } catch (_) {}

      if (!customer) {
        formError.textContent = 'Cliente n√£o cadastrado. Cadastre o tutor e os pets na aba "Clientes & Pets" antes de criar o agendamento.';
        formError.style.display = 'block';
        return;
      }

      const body = {
        customer_id: customer.id,
        pet_id: petIdNum,
        date, time,
        // envia os dois: id (correto) + t√≠tulo (compatibilidade)
        service_id: serviceIdSelected,
        service: serviceTitleSelected,
        prize, notes, status
      };

      let precisaWhats = false;
      let urlWhats = null;

      if (id && normStr(status) !== normStr(originalStatus)) {
        const dataBR = formatDataBr(date);
        const petLabel = petIdNum
          ? (formPetSelect.options[formPetSelect.selectedIndex]?.textContent || 'seu pet')
          : 'seu pet';

        const msg = buildStatusMessage(status, nome, petLabel, serviceTitleSelected, dataBR, time, prize);

        let fullPhone = phone;
        if (!(fullPhone.startsWith('55') && fullPhone.length > 11)) fullPhone = '55' + fullPhone;

        urlWhats = `https://wa.me/${fullPhone}?text=${encodeURIComponent(msg)}`;
        precisaWhats = true;

        body.last_notification_at = new Date().toISOString();
      }

      if (!id) await apiPost('/api/bookings', body);
      else await apiPut('/api/bookings/' + id, body);

      if (precisaWhats && urlWhats) window.open(urlWhats, '_blank');

      limparForm();
      esconderFormAgenda();
      await renderTabela();
      await loadDashboard();
    } catch (e) {
      formError.textContent = e.message;
      formError.style.display = 'block';
    }
  }

  function exportarCSV() {
    if (!ultimaLista.length) {
      alert('N√£o h√° agendamentos para exportar no filtro atual.');
      return;
    }

    const linhas = [];
    linhas.push(['ID','Data','Hora','Tutor','Pet','Telefone','Servi√ßo','Mimo','Status','√öltima Notifica√ß√£o','Observa√ß√µes'].join(';'));

    ultimaLista.forEach(a => {
      const serviceLabel = getServiceLabelFromBooking(a);

      const cols = [
        a.id,
        formatDataBr(a.date),
        a.time || '',
        (a.customer_name || '').replace(/;/g, ','),
        (a.pet_name || '').replace(/;/g, ','),
        formatTelefone(a.phone),
        (serviceLabel || '').replace(/;/g, ','),
        (a.prize || '').replace(/;/g, ','),
        (a.status || 'agendado'),
        a.last_notification_at ? formatDateTimeBr(a.last_notification_at) : '',
        (a.notes || '').replace(/[\r\n]+/g, ' ').replace(/;/g, ',')
      ];
      linhas.push(cols.join(';'));
    });

    const csv = linhas.join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;

    const hoje = new Date();
    const ano = hoje.getFullYear();
    const mes = String(hoje.getMonth() + 1).padStart(2, '0');
    const dia = String(hoje.getDate()).padStart(2, '0');
    a.download = `agenda_petfunny_${ano}-${mes}-${dia}.csv`;

    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  filtroData.addEventListener('change', async () => { await renderTabela(); await loadDashboard(); });

  filtroBusca.addEventListener('input', () => {
    clearTimeout(window.__filtroTimer);
    window.__filtroTimer = setTimeout(async () => {
      await renderTabela();
      await loadDashboard();
    }, 150);
  });

  btnHoje.addEventListener('click', async () => {
    filtroData.value = toISODateOnly(new Date());
    await renderTabela();
    await loadDashboard();
  });

  btnLimparFiltro.addEventListener('click', async () => {
    filtroData.value = '';
    filtroBusca.value = '';
    await renderTabela();
    await loadDashboard();
  });

  btnExportarCSV.addEventListener('click', exportarCSV);
  btnSalvar.addEventListener('click', salvarAgendamento);
  btnCancelarEdicao.addEventListener('click', () => { limparForm(); esconderFormAgenda(); });

  if (dashPeriod) {
    dashPeriod.addEventListener('change', () => {
      const val = dashPeriod.value;
      if (val === 'custom') dashCustomRange.classList.remove('hidden');
      else { dashCustomRange.classList.add('hidden'); loadDashboard(); }
    });
  }
  if (dashApply) dashApply.addEventListener('click', (e) => { e.preventDefault(); loadDashboard(); });

  btnNovoAgendamento.addEventListener('click', () => {
    limparForm();
    formDate.value = toISODateOnly(new Date());
    // Para novo agendamento, o pet √© obrigat√≥rio e s√≥ pode ser escolhido ap√≥s carregar os pets do cliente
    formPetSelect.disabled = true;
    formPetSelect.innerHTML = '<option value="">(Digite o telefone para carregar os pets)</option>';
    mostrarFormAgenda();
    refreshBookingDateTimeState(null);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  formPhone.addEventListener('input', () => applyPhoneMask(formPhone));

  formPhone.addEventListener('blur', async () => {
    const phoneDigits = sanitizePhone(formPhone.value.trim());
    if (!phoneDigits) return;

    try {
      const lookup = await apiPost('/api/customers/lookup', { phone: phoneDigits });

      if (lookup.exists && lookup.customer) {
        // Cliente existe: preenche nome e carrega pets para sele√ß√£o
        formNome.value = lookup.customer.name || '';
        formPetSelect.disabled = false;
        await loadPetsForCustomer(lookup.customer.id);

        // Se o cliente n√£o tem pets, for√ßa cadastro antes de agendar
        if (formPetSelect.options.length <= 1) {
          formPetSelect.disabled = true;
          formPetSelect.innerHTML = '<option value="">(Cadastre ao menos 1 pet para este cliente)</option>';
          formError.textContent = 'Cliente encontrado, mas sem pets cadastrados. Cadastre os pets na aba "Clientes & Pets" antes de agendar.';
          formError.style.display = 'block';
        } else {
          formError.style.display = 'none';
          formError.textContent = '';
        }
      } else {
        // Cliente n√£o existe: avisa e orienta cadastro
        formNome.value = '';
        formPetSelect.disabled = true;
        formPetSelect.innerHTML = '<option value="">(Cadastre o cliente e os pets primeiro)</option>';

        formError.textContent = 'Cliente n√£o cadastrado. V√° na aba "Clientes & Pets" para cadastrar o tutor e os pets antes de criar o agendamento.';
        formError.style.display = 'block';
      }
    } catch (e) {
      // Em caso de erro na API, mant√©m o fluxo mas informa
      formPetSelect.disabled = true;
      formPetSelect.innerHTML = '<option value="">(Erro ao buscar cliente)</option>';
      formError.textContent = 'Erro ao buscar cliente pelo telefone. Tente novamente. Detalhe: ' + (e.message || e);
      formError.style.display = 'block';
    }
  });

  // ===== CLIENTES & PETS =====
  const cliPhone = document.getElementById('cliPhone');
  const cliName = document.getElementById('cliName');
  const cliError = document.getElementById('cliError');
  const btnCliLimpar = document.getElementById('btnCliLimpar');
  const btnCliSalvar = document.getElementById('btnCliSalvar');
  const tbodyClientes = document.getElementById('tbodyClientes');

  // Filtro de busca (Clientes & Pets)
  const filtroClientes = document.getElementById('filtroClientes');
  const btnLimparClientes = document.getElementById('btnLimparClientes');
  let filtroClientesTxt = '';


  const clienteFormBlock = document.getElementById('clienteFormBlock');
  const btnNovoCliente = document.getElementById('btnNovoCliente');

  const petName = document.getElementById('petName');
  const petBreed = document.getElementById('petBreed');
  const petInfo = document.getElementById('petInfo');
  const petError = document.getElementById('petError');
  const btnPetLimpar = document.getElementById('btnPetLimpar');
  const btnPetSalvar = document.getElementById('btnPetSalvar');
  const btnNovoPet = document.getElementById('btnNovoPet');
  const tbodyPets = document.getElementById('tbodyPets');
  const badgeClienteSelecionado = document.getElementById('badgeClienteSelecionado');
  const petsCard = document.getElementById('petsCard');

  const racas = [
    'SRD (Sem Ra√ßa Definida)','Poodle','Shih Tzu','Lhasa Apso','Labrador Retriever','Golden Retriever',
    'Yorkshire Terrier','Bulldog Franc√™s','Bulldog Ingl√™s','Spitz Alem√£o (Lulu da Pomer√¢nia)','Beagle',
    'Border Collie','Boxer','Dachshund (Salsicha)','Malt√™s','Pinscher','Pastor Alem√£o','Rottweiler',
    'Pitbull','Pug','Cocker Spaniel','Schnauzer','Husky Siberiano','Akita','Chihuahua','Outro (informar nas observa√ß√µes)'
  ];

  cliPhone.addEventListener('input', () => applyPhoneMask(cliPhone));

  if (filtroClientes) {
    filtroClientes.addEventListener('input', () => {
      filtroClientesTxt = normStr(filtroClientes.value);
      renderClientes();
    });
  }
  if (btnLimparClientes) {
    btnLimparClientes.addEventListener('click', () => {
      if (filtroClientes) filtroClientes.value = '';
      filtroClientesTxt = '';
      renderClientes();
    });
  }

  racas.forEach(r => {
    const opt = document.createElement('option');
    opt.value = r;
    opt.textContent = r;
    petBreed.appendChild(opt);
  });

  async function loadClientes() {
    const data = await apiGet('/api/customers');
    clientesCache = data.customers || [];
    renderClientes();
  }

  function renderClientes() {
    tbodyClientes.innerHTML = '';

    const list = (clientesCache || []).filter(c => {
      if (!filtroClientesTxt) return true;
      const hay = normStr((c.name || '') + ' ' + (c.phone || ''));
      return hay.includes(filtroClientesTxt);
    });

    list.forEach(c => {
      const tr = document.createElement('tr');

      const tdId = document.createElement('td'); tdId.textContent = c.id;
      const tdNome = document.createElement('td'); tdNome.textContent = c.name || '-';
      const tdTel = document.createElement('td'); tdTel.textContent = formatTelefone(c.phone);
      const tdPetsCount = document.createElement('td');
      tdPetsCount.innerHTML = c.pets_count ? `<span class="badge-mini">${c.pets_count} pet(s)</span>` : '-';

      const tdAcoes = document.createElement('td');
      const divActions = document.createElement('div'); divActions.className = 'actions';

      const btnSel = document.createElement('button');
      btnSel.textContent = 'Selecionar';
      btnSel.className = 'btn btn-small btn-secondary';
      btnSel.type = 'button';
      btnSel.addEventListener('click', async () => {
        clienteSelecionadoId = c.id;

        badgeClienteSelecionado.classList.remove('hidden');
        clienteFormBlock.classList.remove('hidden');
        petsCard.classList.remove('hidden');

        cliPhone.value = formatTelefone(c.phone);
        cliName.value = c.name || '';

        limparPetsForm();
        await loadPetsForClienteTab(c.id);
      });

      const btnDel = document.createElement('button');
      btnDel.textContent = 'Excluir';
      btnDel.className = 'btn btn-small btn-danger';
      btnDel.type = 'button';
      btnDel.addEventListener('click', async () => {
        if (!confirm('Excluir este cliente? (Os pets relacionados tamb√©m poder√£o ser afetados)')) return;
        try {
          await apiDelete('/api/customers/' + c.id);
          if (clienteSelecionadoId === c.id) {
            clienteSelecionadoId = null;
            badgeClienteSelecionado.classList.add('hidden');
            petsCard.classList.add('hidden');
            limparClienteForm();
            limparPetsForm();
            tbodyPets.innerHTML = '';
          }
          await loadClientes();
          await loadDashboard();
          await renderTabela();
        } catch (e) { alert(e.message); }
      });

      divActions.appendChild(btnSel);
      divActions.appendChild(btnDel);
      tdAcoes.appendChild(divActions);

      tr.appendChild(tdId);
      tr.appendChild(tdNome);
      tr.appendChild(tdTel);
      tr.appendChild(tdPetsCount);
      tr.appendChild(tdAcoes);

      tbodyClientes.appendChild(tr);
    });
  }

  function limparClienteForm() {
    cliPhone.value = '';
    cliName.value = '';
    cliError.style.display = 'none';

    clienteSelecionadoId = null;
    badgeClienteSelecionado.classList.add('hidden');

    clienteFormBlock.classList.add('hidden');
    petsCard.classList.add('hidden');

    tbodyPets.innerHTML = '';
    limparPetsForm();
  }

  async function salvarCliente() {
    cliError.style.display = 'none';
    const phoneDigits = sanitizePhone(cliPhone.value.trim());
    const name = cliName.value.trim();

    if (!phoneDigits || phoneDigits.length < 10 || !name) {
      cliError.textContent = 'Preencha telefone (com DDD) e nome do tutor.';
      cliError.style.display = 'block';
      return;
    }

    try {
      const data = await apiPost('/api/customers', { phone: phoneDigits, name });
      clienteSelecionadoId = data.customer.id;
      badgeClienteSelecionado.classList.remove('hidden');
      petsCard.classList.remove('hidden');
      await loadClientes();
      await loadPetsForClienteTab(clienteSelecionadoId);
      await loadDashboard();
      await renderTabela();

    } catch (e) {
      cliError.textContent = e.message;
      cliError.style.display = 'block';
    }
  }

  async function loadPetsForClienteTab(customerId) {
    const data = await apiGet('/api/pets', { customer_id: customerId });
    petsCache = data.pets || [];
    renderPets();
  }

  function renderPets() {
    tbodyPets.innerHTML = '';
    petsCache.forEach(p => {
      const tr = document.createElement('tr');

      const tdId = document.createElement('td'); tdId.textContent = p.id;
      const tdNome = document.createElement('td'); tdNome.textContent = p.name;
      const tdRaca = document.createElement('td'); tdRaca.textContent = p.breed || '-';
      const tdInfo = document.createElement('td'); tdInfo.textContent = p.info || '-';

      const tdAcoes = document.createElement('td');
      const divActions = document.createElement('div'); divActions.className = 'actions';

      const btnEdit = document.createElement('button');
      btnEdit.textContent = 'Editar';
      btnEdit.className = 'btn btn-small btn-secondary';
      btnEdit.type = 'button';
      btnEdit.addEventListener('click', () => {
        petEditIdLocal = p.id;
        petName.value = p.name;
        petBreed.value = p.breed || 'SRD (Sem Ra√ßa Definida)';
        petInfo.value = p.info || '';
      });

      const btnDel = document.createElement('button');
      btnDel.textContent = 'Excluir';
      btnDel.className = 'btn btn-small btn-danger';
      btnDel.type = 'button';
      btnDel.addEventListener('click', async () => {
        if (!confirm('Excluir este pet?')) return;
        try {
          await apiDelete('/api/pets/' + p.id);
          await loadPetsForClienteTab(clienteSelecionadoId);
          await loadClientes();
          await loadDashboard();
          await renderTabela();
        } catch (e) { alert(e.message); }
      });

      divActions.appendChild(btnEdit);
      divActions.appendChild(btnDel);
      tdAcoes.appendChild(divActions);

      tr.appendChild(tdId);
      tr.appendChild(tdNome);
      tr.appendChild(tdRaca);
      tr.appendChild(tdInfo);
      tr.appendChild(tdAcoes);

      tbodyPets.appendChild(tr);
    });
  }

  function limparPetsForm() {
    petEditIdLocal = null;
    petName.value = '';
    petBreed.value = 'SRD (Sem Ra√ßa Definida)';
    petInfo.value = '';
    petError.style.display = 'none';
  }

  async function salvarPet() {
    petError.style.display = 'none';
    if (!clienteSelecionadoId) {
      petError.textContent = 'Selecione um cliente na lista ao lado antes de cadastrar o pet.';
      petError.style.display = 'block';
      return;
    }

    const name = petName.value.trim();
    const breed = petBreed.value;
    const info = petInfo.value.trim();

    if (!name || !breed) {
      petError.textContent = 'Informe nome e ra√ßa do pet.';
      petError.style.display = 'block';
      return;
    }

    try {
      if (!petEditIdLocal) {
        await apiPost('/api/pets', { customer_id: clienteSelecionadoId, name, breed, info });
      } else {
        await apiPut('/api/pets/' + petEditIdLocal, { name, breed, info });
      }
      limparPetsForm();
      await loadPetsForClienteTab(clienteSelecionadoId);
      await loadClientes();
      await loadBreeds();
      await loadDashboard();
      await renderTabela();
    } catch (e) {
      petError.textContent = e.message;
      petError.style.display = 'block';
    }
  }

  btnCliLimpar.addEventListener('click', limparClienteForm);
  btnCliSalvar.addEventListener('click', salvarCliente);

  btnPetLimpar.addEventListener('click', limparPetsForm);
  btnPetSalvar.addEventListener('click', salvarPet);

  btnNovoPet.addEventListener('click', () => limparPetsForm);

  btnNovoCliente.addEventListener('click', () => {
    clienteSelecionadoId = null;
    badgeClienteSelecionado.classList.add('hidden');

    cliPhone.value = '';
    cliName.value = '';
    cliError.style.display = 'none';
    clienteFormBlock.classList.remove('hidden');

    petsCard.classList.add('hidden');
    tbodyPets.innerHTML = '';
    limparPetsForm();
  });

  if (dashPeriod && dashPeriod.value === 'custom') dashCustomRange.classList.remove('hidden');

  /* ===== DASHBOARD: inclui financeiro por servi√ßo ===== */
  async function loadDashboard() {
    let period = dashPeriod ? dashPeriod.value : 'today';
    let { start, end } = getPeriodRange(period);

    if (period === 'custom') {
      start = dashStart.value || null;
      end = dashEnd.value || null;
      if (!start || !end) return;
    }

    let bookings = [];
    let totalCustomers = 0;

    try {
      const data = await apiGet('/api/bookings');
      bookings = data.bookings || [];
    } catch (e) {
      console.error('Erro ao carregar bookings para dashboard:', e);
      bookings = [];
    }

    // aplica range por date (YYYY-MM-DD)
    if (start || end) {
      bookings = bookings.filter(b => {
        const d = b.date;
        if (!d) return false;
        if (start && d < start) return false;
        if (end && d > end) return false;
        return true;
      });
    }

    try {
      const cData = await apiGet('/api/customers');
      totalCustomers = (cData.customers || []).length;
    } catch (e) {
      console.error('Erro ao carregar customers para dashboard:', e);
      totalCustomers = 0;
    }

    const uniqueCustomersSet = new Set();
    bookings.forEach(b => {
      const cid = b.customer_id || b.customerId;
      if (cid != null) uniqueCustomersSet.add(cid);
    });

    dashTotalBookings.textContent = bookings.length;
    dashUniqueCustomers.textContent = uniqueCustomersSet.size;
    dashTotalCustomers.textContent = totalCustomers;

    const statusCounts = { agendado:0, confirmado:0, recebido:0, em_servico:0, concluido:0, entregue:0, cancelado:0 };
    const prizeCounts = { 'Tosa Higi√™nica':0, 'Hidrata√ß√£o':0, 'Foto e V√≠deo Profissional':0, 'Patinhas impec√°veis':0 };

    bookings.forEach(b => {
      const s = normStr(b.status);
      if (s === 'agendado') statusCounts.agendado++;
      else if (s === 'confirmado') statusCounts.confirmado++;
      else if (s === 'recebido') statusCounts.recebido++;
      else if (s === 'em servico') statusCounts.em_servico++;
      else if (s === 'concluido') statusCounts.concluido++;
      else if (s === 'entregue') statusCounts.entregue++;
      else if (s === 'cancelado') statusCounts.cancelado++;

      const p = b.prize || '';
      if (prizeCounts.hasOwnProperty(p)) prizeCounts[p]++;
    });

    dashStatusAgendado.textContent = statusCounts.agendado;
    dashStatusConfirmado.textContent = statusCounts.confirmado;
    dashStatusRecebido.textContent = statusCounts.recebido;
    dashStatusEmServico.textContent = statusCounts.em_servico;
    dashStatusConcluido.textContent = statusCounts.concluido;
    dashStatusEntregue.textContent = statusCounts.entregue;
    dashStatusCancelado.textContent = statusCounts.cancelado;

    dashPrizeTosa.textContent = prizeCounts['Tosa Higi√™nica'];
    dashPrizeHidratacao.textContent = prizeCounts['Hidrata√ß√£o'];
    dashPrizeFotoVideo.textContent = prizeCounts['Foto e V√≠deo Profissional'];
    dashPrizePatinhas.textContent = prizeCounts['Patinhas impec√°veis'];

    // financeiro por servi√ßo
    const usage = new Map(); // serviceId -> {title, qty, value_cents}
    let revenueCents = 0;

    bookings.forEach(b => {
      // determinar serviceId
      let sid = b.service_id ?? b.serviceId ?? null;
      if (sid == null) {
        const txt = b.service || b.service_title || '';
        const match = servicesCache.find(s => normStr(s.title) === normStr(txt));
        sid = match ? match.id : null;
      }

      if (sid == null) return;

      const svc = servicesCache.find(s => String(s.id) === String(sid));
      if (!svc) return;

      const key = String(svc.id);
      if (!usage.has(key)) usage.set(key, { title: svc.title, qty: 0, value_cents: Number(svc.value_cents || 0) });
      const row = usage.get(key);
      row.qty += 1;
      const add = row.value_cents;
      revenueCents += add;
    });

    dashRevenue.textContent = formatCentsToBRL(revenueCents);
    const avg = bookings.length ? Math.round(revenueCents / bookings.length) : 0;
    dashAvgTicket.textContent = formatCentsToBRL(avg);

    tbodyDashServices.innerHTML = '';
    const rows = Array.from(usage.values())
      .map(r => ({...r, total_cents: r.qty * r.value_cents}))
      .sort((a,b) => b.total_cents - a.total_cents);

    dashServicesEmpty.style.display = rows.length ? 'none' : 'block';

    rows.forEach(r => {
      const tr = document.createElement('tr');
      const tdTitle = document.createElement('td'); tdTitle.textContent = r.title;
      const tdQty = document.createElement('td'); tdQty.textContent = String(r.qty);
      const tdPrice = document.createElement('td'); tdPrice.textContent = formatCentsToBRL(r.value_cents);
      const tdTotal = document.createElement('td'); tdTotal.textContent = formatCentsToBRL(r.total_cents);
      tr.appendChild(tdTitle);
      tr.appendChild(tdQty);
      tr.appendChild(tdPrice);
      tr.appendChild(tdTotal);
      tbodyDashServices.appendChild(tr);
    });

    renderCharts(bookings);
  }

  
  /* =========================
     HOR√ÅRIO DE FUNCIONAMENTO (Admin)
  ========================= */
  const tbodyHours = document.getElementById('tbodyHours');
  const hoursEmpty = document.getElementById('hoursEmpty');
  const btnHoursSave = document.getElementById('btnHoursSave');
  const btnHoursReload = document.getElementById('btnHoursReload');
  const btnHoursResetDefault = document.getElementById('btnHoursResetDefault');
  const hoursMsg = document.getElementById('hoursMsg');

  const DOW_LABEL = {
    0: 'Domingo',
    1: 'Segunda',
    2: 'Ter√ßa',
    3: 'Quarta',
    4: 'Quinta',
    5: 'Sexta',
    6: 'S√°bado'
  };

  let openingHoursCache = []; // [{dow,is_closed,open_time,close_time,max_per_half_hour,updated_at}]

  function normalizeHHMM(v, fallback) {
    const s = String(v || '').trim();
    if (/^([01]\d|2[0-3]):[0-5]\d$/.test(s)) return s;
    return fallback;
  }

  function getDefaultOpeningHours() {
    return [
      { dow: 1, is_closed: false, open_time: '07:30', close_time: '17:30', max_per_half_hour: 1 },
      { dow: 2, is_closed: false, open_time: '07:30', close_time: '17:30', max_per_half_hour: 1 },
      { dow: 3, is_closed: false, open_time: '07:30', close_time: '17:30', max_per_half_hour: 1 },
      { dow: 4, is_closed: false, open_time: '07:30', close_time: '17:30', max_per_half_hour: 1 },
      { dow: 5, is_closed: false, open_time: '07:30', close_time: '17:30', max_per_half_hour: 1 },
      { dow: 6, is_closed: false, open_time: '07:30', close_time: '13:00', max_per_half_hour: 1 },
      { dow: 0, is_closed: true,  open_time: null,   close_time: null,   max_per_half_hour: 0 },
    ];
  }

  function renderOpeningHoursTable() {
    if (!tbodyHours) return;

    tbodyHours.innerHTML = '';
    const rowsByDow = new Map((openingHoursCache || []).map(r => [Number(r.dow), r]));

    for (const dow of [1,2,3,4,5,6,0]) {
      const r = rowsByDow.get(dow) || { dow, is_closed: true, open_time: null, close_time: null, max_per_half_hour: 0, updated_at: null };

      const tr = document.createElement('tr');

      const tdDay = document.createElement('td');
      tdDay.textContent = DOW_LABEL[dow] || String(dow);

      const tdClosed = document.createElement('td');
      const chk = document.createElement('input');
      chk.type = 'checkbox';
      chk.checked = !!r.is_closed;
      chk.dataset.dow = String(dow);
      chk.addEventListener('change', () => {
        const openEl = document.getElementById('oh_open_' + dow);
        const closeEl = document.getElementById('oh_close_' + dow);
        const capEl = document.getElementById('oh_cap_' + dow);
        const isClosed = chk.checked;
        if (openEl) openEl.disabled = isClosed;
        if (closeEl) closeEl.disabled = isClosed;
        if (capEl) capEl.disabled = isClosed;
        if (isClosed) {
          if (capEl) capEl.value = '0';
        } else {
          if (capEl && (Number(capEl.value || 0) === 0)) capEl.value = '1';
        }
      });
      tdClosed.appendChild(chk);

      const tdOpen = document.createElement('td');
      const open = document.createElement('input');
      open.type = 'time';
      open.id = 'oh_open_' + dow;
      open.value = r.open_time ? String(r.open_time).slice(0,5) : '07:30';
      open.disabled = !!r.is_closed;
      tdOpen.appendChild(open);

      const tdClose = document.createElement('td');
      const close = document.createElement('input');
      close.type = 'time';
      close.id = 'oh_close_' + dow;
      close.value = r.close_time ? String(r.close_time).slice(0,5) : '17:30';
      close.disabled = !!r.is_closed;
      tdClose.appendChild(close);

      const tdCap = document.createElement('td');
      const cap = document.createElement('input');
      cap.type = 'number';
      cap.min = '0';
      cap.step = '1';
      cap.id = 'oh_cap_' + dow;
      cap.value = String(r.max_per_half_hour != null ? r.max_per_half_hour : (r.is_closed ? 0 : 1));
      cap.disabled = !!r.is_closed;
      cap.style.maxWidth = '110px';
      tdCap.appendChild(cap);

      const tdUpd = document.createElement('td');
      tdUpd.textContent = r.updated_at ? formatDateTimeBr(r.updated_at) : '-';

      tr.appendChild(tdDay);
      tr.appendChild(tdClosed);
      tr.appendChild(tdOpen);
      tr.appendChild(tdClose);
      tr.appendChild(tdCap);
      tr.appendChild(tdUpd);

      tbodyHours.appendChild(tr);
    }

    if (hoursEmpty) hoursEmpty.style.display = 'none';
  }

  async function loadOpeningHours() {
    if (!tbodyHours) return;
    if (hoursMsg) hoursMsg.textContent = '';

    try {
      const data = await apiGet('/api/opening-hours');
      openingHoursCache = data.opening_hours || [];
      renderOpeningHoursTable();
    } catch (e) {
      console.error(e);
      openingHoursCache = [];
      tbodyHours.innerHTML = '';
      if (hoursEmpty) {
        hoursEmpty.style.display = 'block';
        hoursEmpty.textContent = 'Erro ao carregar: ' + e.message;
      }
    }
  }

  function collectOpeningHoursFromUI() {
    const out = [];
    for (const dow of [0,1,2,3,4,5,6]) {
      const chk = document.querySelector(`input[type="checkbox"][data-dow="${dow}"]`);
      const is_closed = !!chk?.checked;

      const openEl = document.getElementById('oh_open_' + dow);
      const closeEl = document.getElementById('oh_close_' + dow);
      const capEl = document.getElementById('oh_cap_' + dow);

      let open_time = openEl ? normalizeHHMM(openEl.value, '07:30') : '07:30';
      let close_time = closeEl ? normalizeHHMM(closeEl.value, '17:30') : '17:30';
      let max_per_half_hour = capEl ? Number(capEl.value) : 1;

      if (!Number.isFinite(max_per_half_hour) || max_per_half_hour < 0) max_per_half_hour = 0;

      if (is_closed) {
        open_time = null;
        close_time = null;
        max_per_half_hour = 0;
      } else {
        if (max_per_half_hour === 0) max_per_half_hour = 1;
      }

      out.push({ dow, is_closed, open_time, close_time, max_per_half_hour });
    }
    return out;
  }

  async function saveOpeningHours(rows) {
    if (hoursMsg) hoursMsg.textContent = '';
    try {
      const payload = { opening_hours: rows };
      const data = await apiPut('/api/opening-hours', payload);
      openingHoursCache = data.opening_hours || [];
      renderOpeningHoursTable();
      if (hoursMsg) hoursMsg.textContent = 'Hor√°rios salvos com sucesso.';
    } catch (e) {
      alert(e.message);
      if (hoursMsg) hoursMsg.textContent = 'Erro ao salvar: ' + e.message;
    }
  }

  if (btnHoursReload) btnHoursReload.addEventListener('click', loadOpeningHours);
  if (btnHoursSave) btnHoursSave.addEventListener('click', () => saveOpeningHours(collectOpeningHoursFromUI()));
  if (btnHoursResetDefault) btnHoursResetDefault.addEventListener('click', () => {
    openingHoursCache = getDefaultOpeningHours().map(r => ({...r, updated_at: null}));
    renderOpeningHoursTable();
    if (hoursMsg) hoursMsg.textContent = 'Padr√£o carregado (clique em Salvar para gravar).';
  });

// ===== In√≠cio =====
  tryAutoLogin();

  /* =========================
   SIDEBAR (MENU HAMBURGUER)
========================= */
(function initSidebarMenu(){
  const btnMenu = document.getElementById('btnMenu');
  const btnMenuClose = document.getElementById('btnMenuClose');
  const sidebar = document.getElementById('sidebar');
  const backdrop = document.getElementById('sidebarBackdrop');

  if (!btnMenu || !sidebar || !backdrop) return;

  function openMenu(){
    backdrop.classList.remove('hidden');
    sidebar.classList.remove('hidden');
    requestAnimationFrame(() => sidebar.classList.add('open'));
    btnMenu.setAttribute('aria-expanded', 'true');
  }

  function closeMenu(){
    sidebar.classList.remove('open');
    btnMenu.setAttribute('aria-expanded', 'false');
    setTimeout(() => {
      sidebar.classList.add('hidden');
      backdrop.classList.add('hidden');
    }, 180);
  }

  btnMenu.addEventListener('click', () => {
    const isOpen = sidebar.classList.contains('open');
    if (isOpen) closeMenu();
    else openMenu();
  });

  if (btnMenuClose) btnMenuClose.addEventListener('click', closeMenu);
  backdrop.addEventListener('click', closeMenu);

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && sidebar.classList.contains('open')) closeMenu();
  });

  // Fecha o menu ao clicar em qualquer item do menu (tab-btn)
  sidebar.addEventListener('click', (e) => {
    const btn = e.target.closest('.tab-btn');
    if (btn) closeMenu();
  });
})();


</script>
</body>
</html>
