<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="description" content="Agende banho e tosa na Pet Funny em Ribeir√£o Preto. Escolha o servi√ßo, gire a Roleta de Mimos e marque seu hor√°rio online pelo WhatsApp. R√°pido, pr√°tico e sem burocracia.">
  <meta name="keywords" content="banho e tosa Ribeir√£o Preto, pet shop Ribeir√£o Preto, agendamento banho pet, pet funny, banho e tosa online, banho e tosa com hor√°rio marcado">
  <meta property="og:title" content="Agenda Pet Funny | Banho e Tosa em Ribeir√£o Preto">
  <meta property="og:description" content="Agende banho e tosa na Pet Funny. Escolha o servi√ßo, ganhe um mimo na roleta e confirme pelo WhatsApp.">
  <meta property="og:url" content="https://www.agendapetfunny.com.br/">
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://www.agendapetfunny.com.br/og-image.jpg">
  <meta name="robots" content="index, follow">
  <meta name="theme-color" content="#01ADB7">

  <link rel="canonical" href="https://www.agendapetfunny.com.br/">

  <title>Agenda Pet Funny | Banho e Tosa em Ribeir√£o Preto com Agendamento Online</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --turquesa: #01ADB7;
      --coral: #F9A197;
      --escuro: #222222;
      --cinza-claro: #f4f4f4;
      --branco: #ffffff;
      --bg-grad: radial-gradient(circle at top, #ffffff 0, #f4f7f8 40%, #e9f5f6 100%);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg-grad);
      color: var(--escuro);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }

    .top-brand {
      width: 100%;
      display: flex;
      justify-content: center;
      padding: 10px 16px 4px;
    }
    .top-brand img { max-width: 260px; height: auto; display: block; }
    @media (max-width: 720px) { .top-brand img { max-width: 210px; } }

    .onboarding {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px 16px;
    }
    .onboarding-card {
      max-width: 640px;
      width: 100%;
      background: var(--branco);
      border-radius: 24px;
      box-shadow: 0 22px 50px rgba(0, 0, 0, 0.10);
      padding: 24px 20px 20px;
      position: relative;
      overflow: hidden;
    }
    .onboarding-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(1, 173, 183, 0.08);
      color: #0e5f64;
      margin-bottom: 10px;
    }
    .onboarding-title { font-size: 26px; line-height: 1.2; margin-bottom: 8px; color: #133238; }
    .onboarding-title span { color: var(--turquesa); }
    .onboarding-sub { font-size: 14px; color: #4b5b5f; margin-bottom: 14px; }
    .onboarding-sub strong { color: var(--turquesa); }
    .onboarding-list { list-style: none; margin-bottom: 18px; font-size: 13px; color: #455a64; }
    .onboarding-list li { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
    .onboarding-list li span { font-size: 16px; }
    .onboarding-cta { display: flex; justify-content: flex-start; margin-top: 6px; gap: 8px; flex-wrap: wrap; }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--turquesa), var(--coral));
      color: #ffffff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.16);
      transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s;
      text-decoration: none;
    }
    .btn:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.18);
    }
    .btn:disabled {
      cursor: not-allowed;
      opacity: 0.55;
      box-shadow: none;
      transform: none;
    }
    .btn-secondary {
      background: #eef3f4;
      color: #37474f;
      box-shadow: none;
      text-transform: none;
      letter-spacing: 0.04em;
      font-weight: 500;
    }

    .how-it-works {
      margin-top: 14px;
      padding: 12px 12px 10px;
      border-radius: 16px;
      border: 1px dashed #cfdfe3;
      background: #f7fbfc;
      font-size: 13px;
      color: #455a64;
      animation: fadeIn 0.18s ease-out;
    }
    .how-it-works-title {
      font-weight: 600;
      margin-bottom: 6px;
      color: #16363c;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .how-it-works-steps { list-style: none; margin-top: 4px; }
    .how-it-works-steps li { margin-bottom: 4px; }
    .how-it-works-steps strong { color: var(--turquesa); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

    #app { flex: 1; display: none; flex-direction: column; min-height: 0; }
    .page-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 16px 16px;
    }

    .card {
      max-width: 960px;
      width: 100%;
      background: var(--branco);
      border-radius: 24px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.10);
      padding: 20px 18px 22px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }
    .card-title-block { display: flex; flex-direction: column; gap: 4px; }
    .card-title { font-size: 20px; font-weight: 700; color: #16363c; }
    .card-subtitle { font-size: 13px; color: #607d8b; }

    .step-indicator {
      display: flex;
      gap: 4px;
      font-size: 11px;
      color: #607d8b;
      align-items: center;
      flex-wrap: wrap;
    }
    .step-pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #d0dde0;
      background: #f3f7f8;
      font-weight: 500;
    }
    .step-pill strong { color: var(--turquesa); }

    .steps-wrapper { display: flex; gap: 16px; flex-wrap: wrap; }
    .left-panel { flex: 1 1 280px; min-width: 0; }
    .right-panel {
      flex: 1 1 240px;
      min-width: 0;
      background: #f8fbfc;
      border-radius: 18px;
      padding: 12px 12px 14px;
      border: 1px dashed #d1e4e7;
    }

    .side-title { font-size: 13px; font-weight: 600; color: #37565c; margin-bottom: 6px; }
    .side-list { list-style: none; font-size: 12px; color: #455a64; }
    .side-list li { display: flex; align-items: flex-start; gap: 6px; margin-bottom: 6px; }
    .side-bullet {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      background: linear-gradient(135deg, var(--turquesa), var(--coral));
      color: #fff;
      flex-shrink: 0;
    }
    .side-caption { font-size: 11px; color: #78909c; margin-top: 6px; }

    .field-group { display: flex; flex-direction: column; gap: 6px; margin-bottom: 10px; }
    .field-label { font-size: 12px; font-weight: 500; color: #455a64; }
    .field-help { font-size: 11px; color: #78909c; }

    input[type="text"], input[type="tel"], input[type="date"], input[type="time"], select, textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid #d4dde0;
      padding: 8px 10px;
      font-size: 13px;
      transition: border-color 0.12s ease, box-shadow 0.12s ease;
      font-family: inherit;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--turquesa);
      box-shadow: 0 0 0 2px rgba(1, 173, 183, 0.16);
    }
    textarea { resize: vertical; min-height: 50px; }

    .btn-inline { margin-top: 6px; }
    .error-msg { font-size: 12px; color: #c62828; margin-top: 4px; }
    .success-msg { font-size: 12px; color: #2e7d32; margin-top: 4px; }
    .hidden { display: none !important; }

    .pet-wrapper {
      border: 1px solid #e0e7ea;
      border-radius: 14px;
      padding: 10px 10px 8px;
      margin-bottom: 8px;
      background: #f8fbfc;
    }

    .wheel-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
    }
    .wheel-container {
      position: relative;
      width: 260px;
      height: 260px;
      border-radius: 50%;
      margin: 0 auto;
      background: conic-gradient(
        var(--turquesa) 0deg 90deg,
        var(--coral) 90deg 180deg,
        #ffddc5 180deg 270deg,
        #7fdde4 270deg 360deg
      );
      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.16);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: visible;
    }
    .wheel-inner {
      width: 68%;
      height: 68%;
      border-radius: 50%;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .wheel-center-dot {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--turquesa), var(--coral));
      box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.9);
    }
    .wheel-pointer {
      position: absolute;
      top: -18px;
      left: 50%;
      transform: translateX(-50%);
      width: 0; height: 0;
      border-left: 14px solid transparent;
      border-right: 14px solid transparent;
      border-bottom: 18px solid #ff7043;
      filter: drop-shadow(0 4px 5px rgba(0, 0, 0, 0.2));
    }
    .wheel-shadow {
      position: absolute;
      bottom: -12px;
      left: 50%;
      transform: translateX(-50%);
      width: 70%;
      height: 20px;
      background: radial-gradient(ellipse at center, rgba(0,0,0,0.25), transparent 70%);
      opacity: 0.8;
      pointer-events: none;
    }

    .badge-prize {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--turquesa), var(--coral));
      color: #ffffff;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .badge-icon {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.16);
      font-size: 16px;
    }
    .badge-label { display: flex; flex-direction: column; line-height: 1.2; }
    .badge-label span { font-size: 11px; font-weight: 400; opacity: 0.9; }

    .pet-select-info { font-size: 11px; color: #78909c; margin-top: 2px; }

    .full-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, #ffffff 0, #eaf7f8 40%, #d6eef0 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .overlay-card {
      background: #ffffff;
      border-radius: 24px;
      padding: 24px 22px 20px;
      max-width: 420px;
      width: 90%;
      box-shadow: 0 20px 50px rgba(0,0,0,0.18);
      text-align: center;
    }
    .overlay-icon-circle {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      margin: 0 auto 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--turquesa), var(--coral));
      color: #ffffff;
      font-size: 30px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.16);
    }
    .overlay-title { font-size: 20px; font-weight: 700; color: #16363c; margin-bottom: 6px; }
    .overlay-subtitle { font-size: 13px; color: #546e7a; margin-bottom: 14px; }

    .overlay-dots { display: inline-flex; gap: 6px; margin-top: 4px; }
    .overlay-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--turquesa);
      animation: dotPulse 0.9s infinite ease-in-out;
    }
    .overlay-dot:nth-child(2) { animation-delay: 0.15s; }
    .overlay-dot:nth-child(3) { animation-delay: 0.3s; }
    @keyframes dotPulse {
      0%, 80%, 100% { transform: scale(0.7); opacity: 0.4; }
      40% { transform: scale(1); opacity: 1; }
    }

    .overlay-wheel {
      margin: 10px auto 6px;
      width: 180px;
      height: 180px;
      border-radius: 50%;
      background: conic-gradient(
        var(--turquesa) 0deg 90deg,
        var(--coral) 90deg 180deg,
        #ffddc5 180deg 270deg,
        #7fdde4 270deg 360deg
      );
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.18);
      position: relative;
      animation: overlaySpin 1.2s linear infinite;
    }
    .overlay-wheel::before {
      content: "";
      position: absolute;
      inset: 24%;
      border-radius: 50%;
      background: #ffffff;
      box-shadow: 0 0 0 4px rgba(255,255,255,0.9);
    }
    .overlay-wheel::after {
      content: "";
      position: absolute;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--turquesa), var(--coral));
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 0 4px rgba(255,255,255,0.95);
    }
    .overlay-pointer {
      position: absolute;
      top: -16px;
      left: 50%;
      transform: translateX(-50%);
      width: 0; height: 0;
      border-left: 13px solid transparent;
      border-right: 13px solid transparent;
      border-bottom: 17px solid #ff7043;
      filter: drop-shadow(0 4px 5px rgba(0, 0, 0, 0.2));
    }
    @keyframes overlaySpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .site-footer {
      border-top: 1px solid #dde5e8;
      padding: 12px 16px 16px;
      background: transparent;
    }
    .footer-inner {
      max-width: 1120px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .footer-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .footer-logo { max-width: 140px; height: auto; }
    .footer-info {
      font-size: 14px;
      color: #455a64;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .footer-info strong { font-size: 13px; color: #263238; }

    /* ======= SOCIAL LINKS (NOVO) ======= */
    .footer-social {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 2px;
    }
    .footer-social-label {
      font-size: 14px;
      color: #455a64;
      font-weight: 600;
      margin-right: 4px;
    }
    .social-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #d0dde0;
      background: #f3f7f8;
      color: #37474f;
      text-decoration: none;
      font-size: 14px;
      transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
      white-space: nowrap;
    }
    .social-link:hover {
      border-color: rgba(1, 173, 183, 0.6);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.10);
      transform: translateY(-1px);
    }

    .footer-bottom { font-size: 14px; color: #78909c; text-align: center; margin-top: 4px; }

    @media (max-width: 720px) {
      .card { padding: 18px 14px 18px; }
      .steps-wrapper { flex-direction: column; }
    }
  </style>
</head>
<body>

<header class="top-brand">
  <img src="roleta-de-mimos-logo.svg" width="200" alt="Roleta de Mimos ‚Äì Pet Funny" />
</header>

<section id="onboarding" class="onboarding">
  <div class="onboarding-card">
    <div class="onboarding-badge">üéÅ Roleta de Mimos ‚Ä¢ Pet Funny</div>
    <h1 class="onboarding-title">
  Banho e Tosa em Ribeir√£o Preto com Agendamento Online na Pet Funny.
</h1>

<p><strong>
  Aqui o seu pet entra pra tomar banho e sai
  <span>cheiroso, mimado e feliz</span> üíõ
</strong>
</p><br />

<section style="display:none;">
  <h2>Agendamento de Banho e Tosa em Ribeir√£o Preto</h2>
  <p>
    A Pet Funny oferece banho e tosa com hor√°rio marcado em Ribeir√£o Preto,
    garantindo conforto, seguran√ßa e carinho para seu pet.
  </p>

  <h2>Pet Shop em Ribeir√£o Preto com Atendimento Humanizado</h2>
  <p>
    Trabalhamos com agendamento online, confirma√ß√£o por WhatsApp
    e servi√ßos personalizados para cada pet.
  </p>
</section>

    <p class="onboarding-sub">
      Na <strong>Roleta de Mimos da Pet Funny</strong>, cada agendamento pode ganhar um carinho extra:
      tosa higi√™nica, hidrata√ß√£o, fotos lindas e muito mais. Voc√™ s√≥ precisa
      se cadastrar, girar a roleta e escolher o melhor hor√°rio pro seu melhor amigo.
    </p>

    <ul class="onboarding-list">
      <li><span>üêæ</span> Mimos pensados pra deixar o banho &amp; tosa ainda mais especial.</li>
      <li><span>üïí</span> Tudo organizadinho, com hor√°rio marcado e confirma√ß√£o pelo WhatsApp.</li>
      <li><span>üè°</span> Jeitinho de pet shop de bairro: a gente conhece cada pet pelo nome.</li>
    </ul>

    <div class="onboarding-cta">
      <button id="btnIniciar" class="btn">Quero participar da Roleta de Mimos</button>
      <button id="btnHowItWorks" class="btn btn-secondary" type="button">Entender rapidinho como funciona</button>
    </div>

    <div id="howItWorksBox" class="how-it-works hidden">
      <div class="how-it-works-title">
        <span>‚ú®</span> <span>Em 4 passos, seu pet j√° vem se divertir na Pet Funny:</span>
      </div>
      <ul class="how-it-works-steps">
        <li><strong>1. Voc√™ coloca seu WhatsApp</strong> pra gente reconhecer ou criar seu cadastro.</li>
        <li><strong>2. Cadastra seus pets</strong> (ou confirma os que j√° existem no sistema).</li>
        <li><strong>3. Gira a Roleta de Mimos</strong> e descobre qual presentinho o seu pet ganhou.</li>
        <li><strong>4. Escolhe o dia e hor√°rio</strong> e j√° sai daqui com o agendamento enviado pro nosso WhatsApp.</li>
      </ul>
      <p style="font-size:12px; color:#607d8b; margin-top:6px;">
        Tudo r√°pido, sem burocracia e com a mesma aten√ß√£o que a gente d√° no balc√£o. üíõ
      </p>
    </div>
  </div>
</section>

<div id="app">
  <div class="page-content">
    <main class="card">
      <div class="card-header">
        <div class="card-title-block">
          <div class="card-title">Roleta de Mimos Pet Funny</div>
          <div class="card-subtitle">Cadastre-se, gire a roleta e agende o banho do seu pet com um mimo especial üê∂‚ú®</div>
        </div>
        <div class="step-indicator">
          <div class="step-pill" id="stepPillText"><strong>Passo 1</strong> ‚Ä¢ Identifica√ß√£o</div>
        </div>
      </div>

      <div class="steps-wrapper">
        <div class="left-panel">

          <section id="step1" class="step">
            <div class="field-group">
              <div class="field-label">Qual √© o seu WhatsApp?</div>
              <div class="field-help">Vamos usar apenas para confirmar o agendamento e mandar as informa√ß√µes do seu mimo.</div>
              <input type="tel" id="phoneInput" placeholder="(16) 98153-5338" />
            </div>
            <div id="step1Error" class="error-msg hidden"></div>
            <button id="btnStep1Next" class="btn btn-inline">Continuar</button>
          </section>

          <section id="step2" class="step hidden">
            <div class="field-group">
              <div class="field-label">Seu nome completo</div>
              <input type="text" id="ownerName" placeholder="Como voc√™ gostaria de ser chamado(a)?" />
            </div>

            <div class="field-group">
              <div class="field-label">Pets</div>
              <div class="field-help">
                Cadastre um ou mais pets. Depois voc√™ escolhe qual deles vai usar o mimo na hora de agendar.
              </div>
            </div>

            <div id="petsContainer"></div>

            <button type="button" id="btnAddPet" class="btn btn-secondary btn-inline">
              + Adicionar outro pet
            </button>

            <div id="step2Error" class="error-msg hidden"></div>

            <button id="btnStep2Next" class="btn btn-inline" style="margin-top:10px;">
              Continuar para a Roleta
            </button>
          </section>

          <section id="step3" class="step hidden">
            <div class="wheel-wrapper">
              <div class="wheel-container" id="wheel">
                <div class="wheel-pointer"></div>
                <div class="wheel-inner">
                  <div class="wheel-center-dot"></div>
                </div>
                <div class="wheel-shadow"></div>
              </div>
              <div class="field-help">
                Clique em <strong>‚ÄúGirar roleta‚Äù</strong> e descubra qual mimo o seu pet vai ganhar.
              </div>
              <button id="btnSpin" class="btn">Girar roleta</button>
              <div id="step3Error" class="error-msg hidden"></div>
            </div>
          </section>

          <section id="step4" class="step hidden">
            <div id="prizeBadgeWrapper" class="badge-prize hidden">
              <div class="badge-icon" id="prizeIcon">üéÅ</div>
              <div class="badge-label">
                <strong id="prizeTitle">Mimo sorteado</strong>
                <span id="prizeSubtitle">J√° est√° garantido no pr√≥ximo agendamento.</span>
              </div>
            </div>

            <div class="field-group">
              <div class="field-label">Para qual pet ser√° esse mimo?</div>
              <select id="petSelect"></select>
              <div class="pet-select-info">
                Os pets cadastrados no seu WhatsApp aparecem aqui. Se quiser cadastrar outro, √© s√≥ falar com a gente pelo WhatsApp. üí¨
              </div>
            </div>

            <div class="field-group">
              <div class="field-label">Qual servi√ßo voc√™ deseja agendar?</div>

              <select id="serviceSelect" disabled>
                <option value="">Carregando servi√ßos...</option>
              </select>
              <div class="field-help" id="serviceHelp">O valor ser√° preenchido automaticamente no WhatsApp.</div>
            </div>

            <div class="field-group">
              <div class="field-label">Escolha o dia</div>
              <div class="field-help">
                Atendemos de <strong>segunda a sexta, das 07:30 √†s 17:30</strong>, e
                <strong>aos s√°bados, das 07:30 √†s 13:00</strong>.
              </div>
              <input type="date" id="dateInput" />
            </div>

            <div class="field-group">
              <div class="field-label">Escolha o hor√°rio</div>
              <div style="display:flex; gap:10px;">
                <select id="hourSelect" style="flex:1;"></select>
                <select id="minuteSelect" style="flex:1;"></select>
              </div>
              <div id="availabilityMsg" class="field-help"></div>
            </div>

            <div class="field-group">
              <div class="field-label">Observa√ß√µes (opcional)</div>
              <textarea id="notesInput" placeholder="Ex: busca em casa, pet idoso, medica√ß√£o, etc."></textarea>
            </div>

            <div class="field-group">
              <div class="field-label">Forma de pagamento</div>
              <select id="paymentMethodSelect">
                <option value="balcao" selected>Cart√£o no balc√£o (d√©bito/cr√©dito)</option>
                <option value="pix">Pix (pagar agora)</option>
              </select>
              <div class="field-help">Se escolher Pix, voc√™ ver√° o QR Code para pagar e o sistema confirma automaticamente.</div>
            </div>

            <div id="pixPaymentBox" class="field-group hidden">
              <div class="field-label">Pagamento via Pix</div>
              <div class="field-help" id="pixStatusMsg">Gerando Pix...</div>
              <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start; margin-top:10px;">
                <img id="pixQrImg" alt="QR Code Pix" style="width:220px; height:220px; border-radius:14px; background:#fff; padding:8px; box-shadow:0 10px 22px rgba(0,0,0,.08);"/>
                <div style="flex:1; min-width:240px;">
                  <div class="field-help" style="margin-bottom:8px;">Ou copie e cole no seu app do banco:</div>
                  <textarea id="pixCopyPaste" readonly style="min-height:120px;"></textarea>
                  <div style="display:flex; gap:8px; margin-top:8px;">
                    <button id="btnCopyPix" type="button" class="btn btn-inline" style="padding:10px 14px;">Copiar Pix</button>
                    <button id="btnCancelPix" type="button" class="btn btn-inline" style="padding:10px 14px; opacity:.85;">Cancelar</button>
                  </div>
                </div>
              </div>
            </div>

            <div id="step4Error" class="error-msg hidden"></div>
            <div id="step4Success" class="success-msg hidden"></div>

            <button id="btnConfirmBooking" class="btn btn-inline">
              Confirmar agendamento e falar no WhatsApp
            </button>
          </section>

        </div>

        <aside class="right-panel">
          <div class="side-title">O que o seu pet pode ganhar na Roleta de Mimos?</div>
          <ul class="side-list">
            <li>
              <div class="side-bullet">‚úÇÔ∏è</div>
              <div>
                <strong>Tosa Higi√™nica</strong><br />
                Limpeza das √°reas √≠ntimas, patinhas e orelhas para mais conforto e higiene.
              </div>
            </li>
            <li>
              <div class="side-bullet">üíß</div>
              <div>
                <strong>Hidrata√ß√£o</strong><br />
                Tratamento especial para deixar os pelos mais macios, cheirosos e saud√°veis.
              </div>
            </li>
            <li>
              <div class="side-bullet">üì∏</div>
              <div>
                <strong>Foto e V√≠deo Profissional</strong><br />
                Registro fofo e profissional do banho do seu pet para voc√™ guardar e postar.
              </div>
            </li>
            <li>
              <div class="side-bullet">üêæ</div>
              <div>
                <strong>Patinhas impec√°veis</strong><br />
                Acabamento caprichado nas patinhas para aquele passeio cheio de estilo.
              </div>
            </li>
          </ul>
          <div class="side-caption">
            *Um mimo por agendamento. V√°lido apenas nos hor√°rios dispon√≠veis da agenda Pet Funny. üíõ
          </div>
        </aside>
      </div>
    </main>
  </div>
</div>

<section id="sortingScreen" class="full-overlay hidden">
  <div class="overlay-card">
    <div class="overlay-icon-circle">üéÅ</div>
    <div class="overlay-title">Sorteando o mimo do seu pet...</div>
    <div class="overlay-subtitle">
      Segura a ansiedade! Estamos girando a Roleta de Mimos pra ver qual carinho extra ele vai ganhar hoje. üê∂‚ú®
    </div>
    <div style="position: relative; display:inline-block;">
      <div class="overlay-wheel"></div>
      <div class="overlay-pointer"></div>
    </div>
    <div class="overlay-dots">
      <div class="overlay-dot"></div><div class="overlay-dot"></div><div class="overlay-dot"></div>
    </div>
  </div>
</section>

<section id="successScreen" class="full-overlay hidden">
  <div class="overlay-card">
    <div class="overlay-icon-circle">‚úÖ</div>
    <div class="overlay-title">Agendamento enviado com sucesso!</div>
    <div class="overlay-subtitle">
      Em instantes vamos abrir o WhatsApp da Pet Funny com todos os detalhes do banho
      e do mimo sorteado. √â s√≥ confirmar por l√°. üíö
    </div>
    <div class="overlay-dots">
      <div class="overlay-dot"></div><div class="overlay-dot"></div><div class="overlay-dot"></div>
    </div>
  </div>
</section>

<footer class="site-footer">
  <div class="footer-inner">

    <div class="footer-top footer-line">
  <img src="pet-funny-logo.svg" alt="Pet Funny" class="footer-logo" />

  <div class="footer-copy">
    ¬© <span id="footerYear"></span> Pet Funny ‚Ä¢ Roleta de Mimos. Todos os direitos reservados.
  </div>

  <div class="footer-info">
    <strong>Pet Funny ‚Ä¢ Banho &amp; Tosa</strong>
    <span>Rua Virg√≠lio de Carvalho Neves Neto, 794 ‚Äì Ribeir√£o Preto / SP</span>
    <span>Hor√°rio: <span id="footerHoursText"></span></span>
    <span>WhatsApp: (16) 98153-5338</span>

   <!-- REDES SOCIAIS (NOVO) -->
        <div class="footer-social" aria-label="Redes sociais Pet Funny">
          <span class="footer-social-label">Redes:</span>
          <a class="social-link" href="https://www.youtube.com/@petfunnyrp" target="_blank" rel="noopener noreferrer" aria-label="YouTube Pet Funny">
            ‚ñ∂Ô∏è YouTube
          </a>
          <a class="social-link" href="https://web.facebook.com/petfunnyrp/" target="_blank" rel="noopener noreferrer" aria-label="Facebook Pet Funny">
            üëç Facebook
          </a>
          <a class="social-link" href="https://www.instagram.com/petfunnybanhoetosa/" target="_blank" rel="noopener noreferrer" aria-label="Instagram Pet Funny">
            üì∏ Instagram
          </a>
        </div>
        <!-- /REDES SOCIAIS (NOVO) -->
  </div>
</div>


 
</footer>

<div itemscope itemtype="https://schema.org/PetStore">
  <meta itemprop="name" content="Pet Funny Banho e Tosa">
  <meta itemprop="address" content="Rua Virg√≠lio de Carvalho Neves Neto, 794 ‚Äì Ribeir√£o Preto, SP">
  <meta itemprop="telephone" content="+5516981535338">
  <meta itemprop="url" content="https://www.agendapetfunny.com.br">
</div>

<script>
  const API_BASE_URL = ''; // mesmo host/porta do backend


  /* ===== Footer din√¢mico (cliente): ano vigente + hor√°rio do cadastro ===== */
  (function initClientFooterDynamic(){
    try {
      const yearEl = document.getElementById('footerYear');
      if (yearEl) yearEl.textContent = String(new Date().getFullYear());

      const hoursEl = document.getElementById('footerHoursText');
      if (!hoursEl) return;

      function dayName(dow){
        return ['Domingo','Segunda','Ter√ßa','Quarta','Quinta','Sexta','S√°bado'][dow] || 'Dia';
      }
      function dayShort(dow){
        return ['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'][dow] || 'Dia';
      }
      function rangeLabel(startDow, endDow){
        if (startDow === endDow) return dayName(startDow);
        return dayShort(startDow) + '‚Äì' + dayShort(endDow);
      }

      function buildHoursLabel(rows){
        const clean = (Array.isArray(rows) ? rows : [])
          .map(r => ({
            dow: Number(r.dow),
            is_closed: !!r.is_closed,
            open_time: r.open_time ? String(r.open_time).slice(0,5) : null,
            close_time: r.close_time ? String(r.close_time).slice(0,5) : null
          }))
          .filter(r => Number.isFinite(r.dow) && r.dow >= 0 && r.dow <= 6)
          .sort((a,b) => a.dow - b.dow);

        const openRows = clean.filter(r => !r.is_closed && r.open_time && r.close_time);
        if (!openRows.length) return 'Fechado';

        const groups = [];
        let cur = null;
        for (const r of openRows) {
          if (!cur) {
            cur = { start: r.dow, end: r.dow, open: r.open_time, close: r.close_time };
            continue;
          }
          const sameTime = (r.open_time === cur.open && r.close_time === cur.close);
          const consecutive = (r.dow === cur.end + 1);
          if (sameTime && consecutive) {
            cur.end = r.dow;
          } else {
            groups.push(cur);
            cur = { start: r.dow, end: r.dow, open: r.open_time, close: r.close_time };
          }
        }
        if (cur) groups.push(cur);

        // Monta string tipo: "Seg‚ÄìSex: 07:30 √†s 17:30 ‚Ä¢ S√°bado: 07:30 √†s 13:00"
        return groups.map(g => `${rangeLabel(g.start, g.end)}: ${g.open} √†s ${g.close}`).join(' ‚Ä¢ ');
      }

      async function load(){
        try {
          const url = (API_BASE_URL || '') + '/api/opening-hours';
          const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          const data = await resp.json();
          const rows = (data && (data.opening_hours || data.rows || data.data)) || (Array.isArray(data) ? data : []);
          const label = buildHoursLabel(rows);
          if (label && typeof label === 'string') hoursEl.textContent = label;
        } catch (e) {
          // Mant√©m o texto padr√£o j√° renderizado no HTML para evitar qualquer quebra de layout
        }
      }

      load();
    } catch(_) {}
  })();

  /* ===== Toast (cliente) ‚Äî feedback r√°pido sem alterar layout ===== */
  function pfToast(message, type = 'success', timeout = 2400) {
    try {
      const id = 'pfClientToast';
      let el = document.getElementById(id);
      if (!el) {
        el = document.createElement('div');
        el.id = id;
        el.setAttribute('role', 'status');
        el.setAttribute('aria-live', 'polite');
        el.style.position = 'fixed';
        el.style.left = '50%';
        el.style.bottom = '22px';
        el.style.transform = 'translateX(-50%)';
        el.style.zIndex = '9999';
        el.style.maxWidth = '92vw';
        el.style.padding = '12px 14px';
        el.style.borderRadius = '14px';
        el.style.fontSize = '14px';
        el.style.fontWeight = '600';
        el.style.boxShadow = '0 10px 30px rgba(0,0,0,.18)';
        el.style.opacity = '0';
        el.style.transition = 'opacity 160ms ease, transform 160ms ease';
        document.body.appendChild(el);
      }

      // cores discretas (sem mexer no CSS do layout)
      const bg = (type === 'error') ? '#c0392b' : (type === 'warn') ? '#e67e22' : '#1AB1BB';
      el.style.background = bg;
      el.style.color = '#ffffff';

      el.textContent = String(message || '');
      el.style.display = 'block';

      // anima
      requestAnimationFrame(() => {
        el.style.opacity = '1';
        el.style.transform = 'translateX(-50%) translateY(0)';
      });

      clearTimeout(el.__pfTimer);
      el.__pfTimer = setTimeout(() => {
        el.style.opacity = '0';
        el.style.transform = 'translateX(-50%) translateY(6px)';
        setTimeout(() => { el.style.display = 'none'; }, 180);
      }, Math.max(900, Number(timeout) || 2400));
    } catch (_) {}
  }


  let currentPhoneDigits = null;
  let currentCustomer = null;
  let currentPets = [];
  let selectedPrize = null;
  let spinning = false;

  // Contagem por slot (HH:MM -> quantidade de agendamentos ativos no dia)
  let occupiedCounts = new Map();
  // Hor√°rio de funcionamento por dia da semana (0=Dom..6=S√°b)
  let openingHoursMap = new Map();
  let servicesCache = [];

  const DEFAULT_PRIZES = [
    { key: 'Tosa Higi√™nica', icon: '‚úÇÔ∏è', subtitle: 'Seu pet vai sair ainda mais confort√°vel e limpinho.' },
    { key: 'Hidrata√ß√£o', icon: 'üíß', subtitle: 'Pelos mais macios, cheirosos e saud√°veis.' },
    { key: 'Foto e V√≠deo Profissional', icon: 'üì∏', subtitle: 'Um registro lindo pra voc√™ guardar e postar.' },
    { key: 'Patinhas impec√°veis', icon: 'üêæ', subtitle: 'Acabamento perfeito para o pr√≥ximo passeio.' }
  ];

  // Ser√° carregado dinamicamente do Admin (tab Mimos). Se a API falhar, cai no DEFAULT_PRIZES.
  let prizes = [...DEFAULT_PRIZES];
  let prizesSource = 'default'; // 'api' | 'default'


  const onboardingSection = document.getElementById('onboarding');
  const app = document.getElementById('app');
  const btnIniciar = document.getElementById('btnIniciar');
  const btnHowItWorks = document.getElementById('btnHowItWorks');
  const howItWorksBox = document.getElementById('howItWorksBox');

  const stepPillText = document.getElementById('stepPillText');

  const step1 = document.getElementById('step1');
  const step2 = document.getElementById('step2');
  const step3 = document.getElementById('step3');
  const step4 = document.getElementById('step4');

  const phoneInput = document.getElementById('phoneInput');
  const step1Error = document.getElementById('step1Error');
  const btnStep1Next = document.getElementById('btnStep1Next');

  const ownerName = document.getElementById('ownerName');
  const petsContainer = document.getElementById('petsContainer');
  const btnAddPet = document.getElementById('btnAddPet');
  const step2Error = document.getElementById('step2Error');
  const btnStep2Next = document.getElementById('btnStep2Next');

  const wheel = document.getElementById('wheel');
  const btnSpin = document.getElementById('btnSpin');
  const step3Error = document.getElementById('step3Error');

  const prizeBadgeWrapper = document.getElementById('prizeBadgeWrapper');
  const prizeIcon = document.getElementById('prizeIcon');
  const prizeTitle = document.getElementById('prizeTitle');
  const prizeSubtitle = document.getElementById('prizeSubtitle');

  const petSelect = document.getElementById('petSelect');
  const serviceSelect = document.getElementById('serviceSelect');
  const serviceHelp = document.getElementById('serviceHelp');

  // ===== Multi-servi√ßos (cliente) =====
  let selectedServiceIds = [];
  let servicesUIReady = false;

  // ===== Multi-servi√ßos (cliente): helpers globais (evita ReferenceError por escopo) =====
  function initMultiServicesUI() {
    if (servicesUIReady) return;
    if (!serviceSelect) return;
    const wrap = serviceSelect.parentElement;
    if (!wrap) return;

    // Lista de servi√ßos selecionados
    let box = document.getElementById('selectedServicesList');
    if (!box) {
      box = document.createElement('div');
      box.id = 'selectedServicesList';
      box.style.marginTop = '8px';
      box.style.display = 'none';
      wrap.appendChild(box);
    }

    // Bot√£o "Adicionar servi√ßo"
    let btn = document.getElementById('btnAddServiceClient');
    if (!btn) {
      btn = document.createElement('button');
      btn.type = 'button';
      btn.id = 'btnAddServiceClient';
      btn.className = 'btn btn-secondary btn-inline';
      btn.textContent = '+ Adicionar servi√ßo';
      btn.style.marginTop = '8px';
      wrap.appendChild(btn);

      btn.addEventListener('click', () => {
        const sid = String(serviceSelect.value || '');
        if (!sid) return;
        if (!selectedServiceIds.includes(sid)) selectedServiceIds.push(sid);
        refreshSelectedServicesUI();
      });
    }

    servicesUIReady = true;
    refreshSelectedServicesUI();
  }

  function refreshSelectedServicesUI() {
    const box = document.getElementById('selectedServicesList');
    if (!box) return;

    if (!Array.isArray(selectedServiceIds) || selectedServiceIds.length === 0) {
      box.style.display = 'none';
      box.innerHTML = '';
      return;
    }

    const items = selectedServiceIds
      .map(id => (servicesCache || []).find(s => String(s.id) === String(id)))
      .filter(Boolean);

    if (!items.length) {
      box.style.display = 'none';
      box.innerHTML = '';
      return;
    }

    const totalCents = items.reduce((acc, s) => acc + (Number.isFinite(Number(s.value_cents)) ? Number(s.value_cents) : 0), 0);

    box.style.display = 'block';
    box.innerHTML = `
      <div style="font-size:12px; font-weight:700; margin-bottom:6px;">Servi√ßos selecionados</div>
      <div style="display:flex; flex-direction:column; gap:6px;">
        ${items.map(s => `
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 10px; border:1px solid rgba(0,0,0,0.08); border-radius:12px; background:#fff;">
            <div style="font-size:12px; font-weight:600;">
              ${String(s.title || '')}
              <span style="font-weight:500; color:#607d8b;">${(s.value_cents!=null && s.value_cents!=='') ? (' ‚Ä¢ ' + formatCentsBRL(s.value_cents)) : ''}</span>
            </div>
            <button type="button" class="btn btn-secondary btn-inline" style="padding:6px 10px; font-size:11px;" data-remove-sid="${String(s.id)}">Remover</button>
          </div>
        `).join('')}
      </div>
      <div style="margin-top:8px; font-size:12px; color:#455a64;">
        <strong>Total:</strong> ${formatCentsBRL(totalCents)}
      </div>
    `;

    box.querySelectorAll('[data-remove-sid]').forEach(btn => {
      btn.addEventListener('click', () => {
        const sid = String(btn.getAttribute('data-remove-sid') || '');
        selectedServiceIds = selectedServiceIds.filter(x => String(x) !== sid);
        refreshSelectedServicesUI();
      });
    });
  }

  const dateInput = document.getElementById('dateInput');

  const hourSelect = document.getElementById('hourSelect');
  const minuteSelect = document.getElementById('minuteSelect');
  const availabilityMsg = document.getElementById('availabilityMsg');

  const notesInput = document.getElementById('notesInput');

  // Pagamento (Pix online / cart√£o no balc√£o)
  const paymentMethodSelect = document.getElementById('paymentMethodSelect');
  const pixPaymentBox = document.getElementById('pixPaymentBox');
  const pixStatusMsg = document.getElementById('pixStatusMsg');
  const pixQrImg = document.getElementById('pixQrImg');
  const pixCopyPaste = document.getElementById('pixCopyPaste');
  const btnCopyPix = document.getElementById('btnCopyPix');
  const btnCancelPix = document.getElementById('btnCancelPix');

  let pixPollTimer = null;
  let currentPixBookingId = null;

  function stopPixPolling() {
    if (pixPollTimer) {
      clearInterval(pixPollTimer);
      pixPollTimer = null;
    }
  }

  function resetPixUI() {
    stopPixPolling();
    currentPixBookingId = null;
    if (pixCopyPaste) pixCopyPaste.value = '';
    if (pixQrImg) pixQrImg.src = '';
    if (pixStatusMsg) pixStatusMsg.textContent = '';
    if (pixPaymentBox) pixPaymentBox.classList.add('hidden');
  }


  const step4Error = document.getElementById('step4Error');
  const step4Success = document.getElementById('step4Success');
  const btnConfirmBooking = document.getElementById('btnConfirmBooking');

  function updateConfirmButtonLabel() {
    if (!btnConfirmBooking) return;
    const v = paymentMethodSelect ? String(paymentMethodSelect.value || '') : '';
    if (v === 'pix') {
      btnConfirmBooking.textContent = 'Gerar Pix e confirmar pagamento';
    } else {
      btnConfirmBooking.textContent = 'Confirmar agendamento e falar no WhatsApp';
    }
  }

  if (paymentMethodSelect) {
    paymentMethodSelect.addEventListener('change', () => {
      updateConfirmButtonLabel();
      // Se o usu√°rio trocar para balc√£o, esconda o box do Pix
      if (paymentMethodSelect.value !== 'pix') resetPixUI();
    });
  }

  if (btnCopyPix) {
    btnCopyPix.addEventListener('click', async () => {
      try {
        if (!pixCopyPaste || !pixCopyPaste.value) return;
        await navigator.clipboard.writeText(pixCopyPaste.value);
        pfToast('Pix copiado!', 'success', 1600);
      } catch (e) {
        pfToast('N√£o foi poss√≠vel copiar automaticamente. Selecione e copie manualmente.', 'info', 2500);
      }
    });
  }

  if (btnCancelPix) {
    btnCancelPix.addEventListener('click', () => {
      resetPixUI();
      if (step4Error) {
        step4Error.textContent = 'Pagamento Pix cancelado. Voc√™ pode escolher cart√£o no balc√£o e confirmar.';
        step4Error.classList.remove('hidden');
      }
      updateConfirmButtonLabel();
    });
  }

  // inicial
  updateConfirmButtonLabel();


  const sortingScreen = document.getElementById('sortingScreen');
  const successScreen = document.getElementById('successScreen');

  const today = new Date().toISOString().split('T')[0];
  dateInput.min = today;

  function formatPhone(input) {
    let value = input.value.replace(/\D/g, "");
    if (value.length > 11) value = value.slice(0, 11);

    let formatted = value;
    if (value.length > 0) formatted = `(${value.slice(0, 2)}`;
    if (value.length >= 3) formatted = `(${value.slice(0, 2)}) ${value.slice(2, 3)}`;
    if (value.length >= 4) formatted = `(${value.slice(0, 2)}) ${value.slice(2, 3)} ${value.slice(3, 7)}`;
    if (value.length >= 8) {
      formatted = `(${value.slice(0, 2)}) ${value.slice(2, 3)} ${value.slice(3, 7)}-${value.slice(7, 11)}`;
    }
    input.value = formatted;
  }
  phoneInput.addEventListener("input", () => formatPhone(phoneInput));

  const racas = [
    'SRD (Sem Ra√ßa Definida)','Poodle','Shih Tzu','Lhasa Apso','Labrador Retriever','Golden Retriever',
    'Yorkshire Terrier','Bulldog Franc√™s','Bulldog Ingl√™s','Spitz Alem√£o (Lulu da Pomer√¢nia)','Beagle',
    'Border Collie','Boxer','Dachshund (Salsicha)','Malt√™s','Pinscher','Pastor Alem√£o','Rottweiler',
    'Pitbull','Pug','Cocker Spaniel','Schnauzer','Husky Siberiano','Akita','Chihuahua',
    'Outro (informar nas observa√ß√µes)'
  ];

  async function apiPost(path, body) {
    const resp = await fetch(`${API_BASE_URL}${path}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) throw new Error(data.error || 'Erro ao salvar.');
    return data;
  }

  async function apiGet(path, params = {}) {
    const url = new URL((API_BASE_URL || '') + path, window.location.origin);
    Object.entries(params).forEach(([k, v]) => {
      if (v !== undefined && v !== null && v !== '') url.searchParams.append(k, v);
    });
    const resp = await fetch(url.toString(), { cache: 'no-store', headers: { 'Cache-Control': 'no-cache' } });
    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) throw new Error(data.error || 'Erro ao buscar dados.');
    return data;
  }


  // ======= MIMOS (din√¢mico - vindo do Admin) =======
  function extractFirstEmoji(text) {
    const s = String(text || '');
    try {
      const m = s.match(/[\p{Extended_Pictographic}]/u);
      return m ? m[0] : '';
    } catch {
      // fallback simples (sem unicode property support)
      const m = s.match(/[\u2190-\u2BFF\uD83C-\uDBFF\uDC00-\uDFFF]/);
      return m ? m[0] : '';
    }
  }

  function buildConicGradient(n) {
    const colors = [
      'var(--turquesa)',
      'var(--coral)',
      '#ffddc5',
      '#7fdde4',
      '#b6f2d6',
      '#ffe6a6',
      '#d6c7ff',
      '#ffd1dc'
    ];
    const seg = 360 / Math.max(1, n);
    const parts = [];
    for (let i = 0; i < n; i++) {
      const c = colors[i % colors.length];
      const start = (seg * i).toFixed(2);
      const end = (seg * (i + 1)).toFixed(2);
      parts.push(`${c} ${start}deg ${end}deg`);
    }
    return `conic-gradient(${parts.join(', ')})`;
  }

  function renderMimosSidebar(list) {
    const ul = document.querySelector('.side-list');
    if (!ul) return;

    ul.innerHTML = '';

    (list || []).forEach(item => {
      const li = document.createElement('li');

      const bullet = document.createElement('div');
      bullet.className = 'side-bullet';
      bullet.textContent = item.icon || 'üéÅ';

      const body = document.createElement('div');
      const strong = document.createElement('strong');
      strong.textContent = item.key || 'Mimo';
      body.appendChild(strong);
      body.appendChild(document.createElement('br'));

      const desc = document.createTextNode(item.subtitle || '');
      body.appendChild(desc);

      li.appendChild(bullet);
      li.appendChild(body);
      ul.appendChild(li);
    });
  }

  function applyMimosToWheel(list) {
    // Atualiza o gradiente do wheel e do overlay, mantendo o layout intacto
    const n = (list && list.length) ? list.length : 1;
    const gradient = buildConicGradient(n);

    if (wheel) wheel.style.background = gradient;

    const overlayWheel = document.querySelector('.overlay-wheel');
    if (overlayWheel) overlayWheel.style.background = gradient;
  }

  async function loadMimosForRoleta() {
    try {
      const resp = await apiGet('/api/mimos', { active: 1, at: new Date().toISOString() });
      const mimos = Array.isArray(resp.mimos) ? resp.mimos : [];

      if (mimos.length) {
        prizes = mimos.map(m => {
          const icon = extractFirstEmoji(m.title) || extractFirstEmoji(m.description) || 'üéÅ';
          return {
            key: String(m.title || '').trim() || 'Mimo',
            icon,
            subtitle: String(m.description || '').trim(),
            mimo_id: m.id,
            value_cents: m.value_cents
          };
        });
        prizesSource = 'api';
      } else {
        prizes = [...DEFAULT_PRIZES];
        prizesSource = 'default';
      }
    } catch (e) {
      prizes = [...DEFAULT_PRIZES];
      prizesSource = 'default';
    }

    // Sidebar + wheel
    renderMimosSidebar(prizes);
    applyMimosToWheel(prizes);
  }


  // ======= SERVICES (din√¢mico) =======
  function formatCentsBRL(cents) {
    const n = Number(cents);
    if (!Number.isFinite(n)) return '';
    return (n / 100).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  function normalizeKey(v) {
    return String(v || '')
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .replace(/\s+/g, ' ')
      .trim();
  }

  function getSelectedPetObj() {
    const pid = petSelect ? String(petSelect.value || '') : '';
    if (!pid) return null;
    return (currentPets || []).find(p => String(p.id) === pid) || null;
  }

  function getPetPorteKey(pet) {
    if (!pet) return '';
    const raw = pet.size || pet.porte || '';
    const k = normalizeKey(raw);
    if (k === 'medio') return 'medio';
    return k;
  }

  function filterServicesForPet(pet) {
    const porteKey = getPetPorteKey(pet);
    if (!porteKey) return servicesCache || [];
    return (servicesCache || []).filter(s => {
      const sk = normalizeKey(s.porte || s.size || '');
      return sk === porteKey;
    });
  }


  function renderServiceSelect(services) {
    const current = serviceSelect ? String(serviceSelect.value || '') : '';

    serviceSelect.innerHTML = '';

    const opt0 = document.createElement('option');
    opt0.value = '';
    opt0.textContent = 'Selecione o servi√ßo...';
    serviceSelect.appendChild(opt0);

    if (!services || !services.length) {
      serviceSelect.disabled = true;
      serviceSelect.innerHTML = '<option value="">Nenhum servi√ßo cadastrado</option>';
      return;
    }

    // Igual ao Admin: agrupa por categoria usando <optgroup>
    const grouped = {};
    (services || []).forEach(svc => {
      const cat = String(svc.category || 'Outros').trim() || 'Outros';
      if (!grouped[cat]) grouped[cat] = [];
      grouped[cat].push(svc);
    });

    Object.keys(grouped)
      .sort((a, b) => String(a).localeCompare(String(b), 'pt-BR'))
      .forEach(category => {
        const og = document.createElement('optgroup');
        og.label = category;

        grouped[category].forEach(s => {
          const opt = document.createElement('option');
          opt.value = String(s.id);

          opt.dataset.title = String(s.title || '');
          opt.dataset.valueCents = String(s.value_cents ?? '');
          opt.dataset.durationMin = String(s.duration_min ?? s.tempo_min ?? '');

          const priceLabel = (s.value_cents !== undefined && s.value_cents !== null && s.value_cents !== '')
            ? ` ‚Ä¢ ${formatCentsBRL(s.value_cents)}`
            : '';

          const dur = Number(s.duration_min ?? s.tempo_min);
          const durLabel = (Number.isFinite(dur) && dur > 0) ? ` ‚Ä¢ ${dur} min` : '';

          opt.textContent = `${s.title}${priceLabel}${durLabel}`;
          og.appendChild(opt);
        });

        serviceSelect.appendChild(og);
      });

    serviceSelect.disabled = false;

    // Mant√©m sele√ß√£o, se existir
    if (current) serviceSelect.value = current;
  }

  function initMultiServicesUI() {
    if (servicesUIReady) return;
    if (!serviceSelect) return;
    const wrap = serviceSelect.parentElement;
    if (!wrap) return;

    const list = document.createElement('div');
    list.id = 'selectedServicesList';
    list.style.marginTop = '8px';
    list.style.display = 'none';
    wrap.appendChild(list);

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.id = 'btnAddServiceClient';
    btn.className = 'btn btn-secondary btn-inline';
    btn.textContent = '+ Adicionar servi√ßo';
    btn.style.marginTop = '8px';
    wrap.appendChild(btn);

    btn.addEventListener('click', () => {
      const sid = String(serviceSelect.value || '');
      if (!sid) return;
      if (!selectedServiceIds.includes(sid)) selectedServiceIds.push(sid);
      refreshSelectedServicesUI();
    });

    servicesUIReady = true;
  }

  function refreshSelectedServicesUI() {
    const box = document.getElementById('selectedServicesList');
    if (!box) return;

    if (!selectedServiceIds.length) {
      box.style.display = 'none';
      box.innerHTML = '';
      return;
    }

    const items = selectedServiceIds
      .map(id => (servicesCache || []).find(s => String(s.id) === String(id)))
      .filter(Boolean);

    const totalCents = items.reduce((acc, s) => acc + (Number.isFinite(Number(s.value_cents)) ? Number(s.value_cents) : 0), 0);
    const totalMin = items.reduce((acc, s) => {
      const m = Number(s.duration_min ?? s.tempo_min ?? 0);
      return acc + (Number.isFinite(m) ? m : 0);
    }, 0);

    box.style.display = 'block';
    box.innerHTML = `
      <div style="font-size:12px; font-weight:700; margin-bottom:6px;">Servi√ßos selecionados</div>
      <div style="display:flex; flex-direction:column; gap:6px;">
        ${items.map(s => {
          const dur = Number(s.duration_min ?? s.tempo_min ?? 0);
          const durLabel = (Number.isFinite(dur) && dur > 0) ? ` ‚Ä¢ ${dur} min` : '';
          const priceLabel = (s.value_cents!=null)?(' ‚Ä¢ '+formatCentsBRL(s.value_cents)) : '';
          return `
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 10px; border:1px solid rgba(0,0,0,0.08); border-radius:12px; background:#fff;">
              <div style="font-size:12px; font-weight:600;">
                ${String(s.title || '')}
                <span style="font-weight:500; color:#607d8b;">${priceLabel}${durLabel}</span>
              </div>
              <button type="button" class="btn btn-secondary btn-inline" style="padding:6px 10px; font-size:11px;" data-remove-sid="${String(s.id)}">Remover</button>
            </div>
          `;
        }).join('')}
      </div>
      <div style="margin-top:8px; font-size:12px; color:#455a64; display:flex; flex-direction:column; gap:2px;">
        <div><strong>Total:</strong> ${formatCentsBRL(totalCents)}</div>
        <div><strong>Tempo total:</strong> ${Number.isFinite(totalMin) ? totalMin : 0} min</div>
      </div>
    `;

    box.querySelectorAll('[data-remove-sid]').forEach(btn => {
      btn.addEventListener('click', () => {
        const sid = btn.getAttribute('data-remove-sid');
        selectedServiceIds = selectedServiceIds.filter(x => String(x) !== String(sid));
        refreshSelectedServicesUI();
      });
    });
  }

  function setSingleServiceFromSelectIfEmpty() {
    const sid = String(serviceSelect.value || '');
    if (!selectedServiceIds.length && sid) {
      selectedServiceIds = [sid];
      refreshSelectedServicesUI();
    }
  }

  async function loadServicesForSelect() {
    serviceSelect.disabled = true;
    serviceSelect.innerHTML = '<option value="">Carregando servi√ßos...</option>';

    const resp = await apiGet('/api/services', {});
    servicesCache = resp.services || [];
    initMultiServicesUI();
    const pet = getSelectedPetObj();
    const filtered = filterServicesForPet(pet);
    renderServiceSelect(filtered);
    setSingleServiceFromSelectIfEmpty();
  }

  function showStep(stepNumber) {
    [step1, step2, step3, step4].forEach(s => s.classList.add('hidden'));
    if (stepNumber === 1) {
      step1.classList.remove('hidden');
      stepPillText.innerHTML = '<strong>Passo 1</strong> ‚Ä¢ Identifica√ß√£o';
    } else if (stepNumber === 2) {
      step2.classList.remove('hidden');
      stepPillText.innerHTML = '<strong>Passo 2</strong> ‚Ä¢ Cadastro r√°pido';
    } else if (stepNumber === 3) {
      step3.classList.remove('hidden');
      stepPillText.innerHTML = '<strong>Passo 3</strong> ‚Ä¢ Girar roleta';
    } else if (stepNumber === 4) {
      step4.classList.remove('hidden');
      stepPillText.innerHTML = '<strong>Passo 4</strong> ‚Ä¢ Escolher dia &amp; hor√°rio';
    }
  }

  function sanitizePhone(phone) {
    return (phone || '').replace(/\D/g, '');
  }

  function createPetFields() {
    const wrapper = document.createElement('div');
    wrapper.className = 'pet-wrapper';

    const nameId = 'petName_' + Math.random().toString(36).slice(2);
    const breedId = 'petBreed_' + Math.random().toString(36).slice(2);
    const sizeId = 'petSize_' + Math.random().toString(36).slice(2);
    const coatId = 'petCoat_' + Math.random().toString(36).slice(2);
    const infoId = 'petInfo_' + Math.random().toString(36).slice(2);

    wrapper.innerHTML = `
      <div class="field-group">
        <div class="field-label">Nome do pet</div>
        <input type="text" id="${nameId}" placeholder="Nome do pet" />
      </div>
      <div class="field-group">
        <div class="field-label">Ra√ßa</div>
        <select id="${breedId}" class="pet-breed"></select>
      </div>
      <div class="field-group">
        <div class="field-label">Porte</div>
        <select id="${sizeId}" class="pet-size">
          <option value="pequeno">Pequeno</option>
          <option value="medio">M√©dio</option>
          <option value="grande">Grande</option>
        </select>
      </div>
      <div class="field-group">
        <div class="field-label">Pelagem</div>
        <select id="${coatId}" class="pet-coat">
          <option value="curta">Curta</option>
          <option value="media">M√©dia</option>
          <option value="longa">Longa</option>
        </select>
      </div>
      <div class="field-group">
        <div class="field-label">Mais informa√ß√µes sobre o pet (opcional)</div>
        <textarea id="${infoId}" placeholder="Porte, comportamento, medica√ß√£o, etc."></textarea>
      </div>
      <button type="button" class="btn btn-secondary btn-inline btn-remove-pet">Remover pet</button>
    `;

    const breedSelect = wrapper.querySelector(`#${breedId}`);
    racas.forEach(r => {
      const opt = document.createElement('option');
      opt.value = r;
      opt.textContent = r;
      breedSelect.appendChild(opt);
    });

    wrapper.querySelector('.btn-remove-pet').addEventListener('click', () => {
      petsContainer.removeChild(wrapper);
    });

    petsContainer.appendChild(wrapper);
  }

  function getPetsFromForm() {
    const wrappers = Array.from(petsContainer.querySelectorAll('.pet-wrapper'));
    const pets = [];

    wrappers.forEach(wrapper => {
      const nameInput = wrapper.querySelector('input[type="text"]');
      const breedSelect = wrapper.querySelector('select.pet-breed');
      const sizeSelect = wrapper.querySelector('select.pet-size');
      const coatSelect = wrapper.querySelector('select.pet-coat');
      const infoTextarea = wrapper.querySelector('textarea');

      const name = (nameInput?.value || '').trim();
      const breed = breedSelect?.value || '';
      const size = sizeSelect?.value || 'pequeno';
      const coat = coatSelect?.value || 'curta';
      const info = (infoTextarea?.value || '').trim();

      if (name && breed) pets.push({ name, breed, size, coat, info });
    });

    return pets;
  }

  function fillPetSelect() {
    petSelect.innerHTML = '';
    if (!currentPets || !currentPets.length) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'Nenhum pet encontrado. Fale com a gente no WhatsApp.';
      petSelect.appendChild(opt);
      petSelect.disabled = true;
    } else {
      petSelect.disabled = false;
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = 'Selecione o pet...';
      petSelect.appendChild(opt0);

      currentPets.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.breed ? `${p.name} (${p.breed})` : p.name;
        petSelect.appendChild(opt);
      });
    }
  }

  function onPetSelectChange() {
    try {
      selectedServiceIds = [];
      refreshSelectedServicesUI();
      const pet = getSelectedPetObj();
      const filtered = filterServicesForPet(pet);
      renderServiceSelect(filtered);
      setSingleServiceFromSelectIfEmpty();

      const porteKey = getPetPorteKey(pet);
      if (serviceHelp) {
        if (porteKey) serviceHelp.textContent = 'Servi√ßos filtrados pelo porte do pet selecionado.';
        else serviceHelp.textContent = 'Selecione um pet para ver os servi√ßos compat√≠veis.';
      }
    } catch (e) {
      console.error('Falha ao filtrar servi√ßos por pet:', e);
    }
  }

  if (petSelect) {
    petSelect.addEventListener('change', onPetSelectChange);
  }


  function setPrize(prize) {
    selectedPrize = prize;
    prizeBadgeWrapper.classList.remove('hidden');
    prizeIcon.textContent = prize.icon;
    prizeTitle.textContent = prize.key;
    prizeSubtitle.textContent = prize.subtitle;

    try { localStorage.setItem('petfunny_prize', JSON.stringify(prize)); } catch {}
  }

  (function loadSavedPrize() {
    try {
      const saved = localStorage.getItem('petfunny_prize');
      if (saved) setPrize(JSON.parse(saved));
    } catch {}
  })();

  async function loadOpeningHours() {
    try {
      const resp = await apiGet('/api/opening-hours');
      const rows = resp.opening_hours || [];
      openingHoursMap = new Map(rows.map(r => [Number(r.dow), r]));
    } catch (e) {
      // fallback: se a API falhar, segue com comportamento antigo (Seg-Sab)
      openingHoursMap = new Map();
    }
  }

    function getOpeningForDate(dateStr) {
    if (!dateStr) return null;

    // Mesma l√≥gica do admin (evita diferen√ßa de fuso/parse do Date em browsers)
    const d = new Date(dateStr + 'T00:00:00-03:00');
    if (Number.isNaN(d.getTime())) return null;
    const dow = d.getUTCDay();

    const row = openingHoursMap.get(dow);

    const isClosed = row ? (
      row.is_closed === true ||
      row.is_closed === 1 ||
      row.is_closed === '1' ||
      row.is_closed === 't' ||
      row.is_closed === 'true'
    ) : null;

    if (row) return { ...row, dow, is_closed: !!isClosed };

    // Fallback (se Opening Hours n√£o estiver configurado)
    return {
      dow,
      is_closed: (dow === 0),
      open_time: '07:30',
      close_time: (dow === 6 ? '13:00' : '17:30'),
      max_per_half_hour: 1
    };
  }

  function validarDiaHora(dateStr, timeStr) {
    if (!dateStr || !timeStr) return 'Informe a data e o hor√°rio.';
    const oh = getOpeningForDate(dateStr);
    if (!oh) return 'Data inv√°lida.';

    if (oh.is_closed) return 'Dia fechado para agendamentos.';

    const m = /^([01]\d|2[0-3]):[0-5]\d$/.exec(String(timeStr || '').trim());
    if (!m) return 'Hor√°rio inv√°lido.';

    const t = parseInt(timeStr.slice(0,2), 10) * 60 + parseInt(timeStr.slice(3,5), 10);
    const open = parseInt(String(oh.open_time || '00:00').slice(0,2), 10) * 60 + parseInt(String(oh.open_time || '00:00').slice(3,5), 10);
    const close = parseInt(String(oh.close_time || '00:00').slice(0,2), 10) * 60 + parseInt(String(oh.close_time || '00:00').slice(3,5), 10);

    if (!Number.isFinite(open) || !Number.isFinite(close) || close <= open) return 'Hor√°rio de funcionamento inv√°lido.';
    if (t < open || t >= close) return `Hor√°rios entre ${oh.open_time} e ${oh.close_time}.`;
    if ((t - open) % 30 !== 0) return 'Hor√°rio deve ser em intervalos de 30 minutos.';

    const cap = Number(oh.max_per_half_hour);
    if (!Number.isFinite(cap) || cap <= 0) return 'Este dia est√° sem vagas configuradas.';

    return null;
  }

  function pad2(n) { return String(n).padStart(2, '0'); }

  function buildRangeForDate(dateStr) {
    const oh = getOpeningForDate(dateStr);
    if (!oh) return null;
    if (oh.is_closed) return { closed: true };

    const startMin = timeToMinutes(oh.open_time);
    const endMin = timeToMinutes(oh.close_time);
    if (!Number.isFinite(startMin) || !Number.isFinite(endMin) || endMin <= startMin) return { closed: true };
    return { closed: false, startMin, endMin, cap: Number(oh.max_per_half_hour) || 1 };
  }

  function timeToMinutes(hhmm) {
    const s = String(hhmm || '').trim();
    // aceita HH:MM e HH:MM:SS (PostgreSQL TIME costuma vir com segundos)
    const m = /^([01]\d|2[0-3]):([0-5]\d)(?::([0-5]\d))?$/.exec(s);
    if (!m) return NaN;
    return Number(m[1]) * 60 + Number(m[2]);
  }

  function normalizeHHMM(t) {
    const s = String(t || '').trim();
    const m = s.match(/^(\d{1,2}):(\d{2})$/);
    if (!m) return null;
    const hh = String(parseInt(m[1], 10)).padStart(2, '0');
    const mm = m[2];
    return `${hh}:${mm}`;
  }

  function isActiveBookingStatus(status) {
    const s = String(status || '').toLowerCase();
    return s !== 'cancelado' && s !== 'cancelada' && s !== 'canceled' && s !== 'cancelled';
  }

  async function loadOccupiedTimesForDate(dateStr) {
    occupiedCounts = new Map();
    if (!dateStr) return;

    const resp = await apiGet('/api/bookings', { date: dateStr });
    const bookings = resp.bookings || [];

    bookings.forEach(b => {
      if (!isActiveBookingStatus(b.status)) return;
      const t = normalizeHHMM(b.time);
      if (!t) return;
      occupiedCounts.set(t, (occupiedCounts.get(t) || 0) + 1);
    });
  }

  function countAvailableSlots(dateStr) {
    const range = buildRangeForDate(dateStr);
    if (!range || range.closed) return 0;

    let count = 0;
    for (let m = range.startMin; m < range.endMin; m += 30) {
      const hh = Math.floor(m / 60);
      const mm = m % 60;
      const t = `${pad2(hh)}:${pad2(mm)}`;
      const used = occupiedCounts.get(t) || 0;
      if (used < (range.cap || 1)) count++;
    }
    return count;
  }

  function setAvailabilityMessage(dateStr) {
    if (!availabilityMsg) return;

    if (!dateStr) {
      availabilityMsg.textContent = 'Selecione uma data para ver os hor√°rios dispon√≠veis.';
      return;
    }

    const range = buildRangeForDate(dateStr);
    if (!range || range.closed) {
      availabilityMsg.textContent = 'Dia fechado para agendamentos.';
      return;
    }

    const available = countAvailableSlots(dateStr);
    if (available <= 0) availabilityMsg.textContent = 'Dia lotado. Escolha outra data.';
    else if (available === 1) availabilityMsg.textContent = '1 hor√°rio dispon√≠vel.';
    else availabilityMsg.textContent = `${available} hor√°rios dispon√≠veis.`;
  }

  function resetTimeSelects() {
    hourSelect.innerHTML = '';
    minuteSelect.innerHTML = '';
    hourSelect.appendChild(new Option('Hora...', ''));
    minuteSelect.appendChild(new Option('Min...', ''));
    hourSelect.disabled = true;
    minuteSelect.disabled = true;
  }

  function populateHourSelect(dateStr) {
    hourSelect.innerHTML = '';
    minuteSelect.innerHTML = '';

    hourSelect.appendChild(new Option('Hora...', ''));
    minuteSelect.appendChild(new Option('Min...', ''));

    const range = buildRangeForDate(dateStr);
    if (!dateStr) {
      hourSelect.disabled = true;
      minuteSelect.disabled = true;
      return;
    }
    if (!range || range.closed) {
      hourSelect.disabled = true;
      minuteSelect.disabled = true;
      hourSelect.appendChild(new Option('Fechado', ''));
      return;
    }

    hourSelect.disabled = false;
    minuteSelect.disabled = true;

    const startHour = Math.floor(range.startMin / 60);
    const endHour = Math.floor(range.endMin / 60);

    for (let h = startHour; h <= endHour; h++) {
      const hh = pad2(h);
      const candidates = [`${hh}:00`, `${hh}:30`];

      const hasAnyFree = candidates.some(t => {
        const [H, M] = t.split(':').map(Number);
        const total = H * 60 + M;
        if (total < range.startMin || total >= range.endMin) return false;
        const used = occupiedCounts.get(t) || 0;
        if (used >= (range.cap || 1)) return false;
        return true;
      });

      if (hasAnyFree) hourSelect.appendChild(new Option(hh, hh));
    }

    if (hourSelect.options.length === 1) {
      hourSelect.disabled = true;
      minuteSelect.disabled = true;
      hourSelect.appendChild(new Option('Sem hor√°rios', ''));
    }
  }

  function populateMinuteSelect(dateStr, hh) {
    minuteSelect.innerHTML = '';
    minuteSelect.appendChild(new Option('Min...', ''));

    const range = buildRangeForDate(dateStr);
    if (!range || range.closed || !hh) {
      minuteSelect.disabled = true;
      return;
    }

    const h = parseInt(hh, 10);

    [0, 30].forEach(mm => {
      const total = h * 60 + mm;
      if (total < range.startMin || total >= range.endMin) return;

      const t = `${pad2(h)}:${pad2(mm)}`;
      const used = occupiedCounts.get(t) || 0;
      if (used >= (range.cap || 1)) return;

      minuteSelect.appendChild(new Option(pad2(mm), pad2(mm)));
    });

    if (minuteSelect.options.length === 1) {
      minuteSelect.disabled = true;
      minuteSelect.appendChild(new Option('Sem hor√°rios', ''));
    } else {
      minuteSelect.disabled = false;
    }
  }

  function getSelectedTimeHHMM() {
    const hh = hourSelect.value;
    const mm = minuteSelect.value;
    if (!hh || !mm) return '';
    return `${hh}:${mm}`;
  }

  function findNextAvailableTime(dateStr, fromTimeHHMM) {
    const range = buildRangeForDate(dateStr);
    if (!range || range.closed) return null;

    const fromMin = timeToMinutes(fromTimeHHMM);
    const startMin = Number.isFinite(fromMin) ? (fromMin + 30) : range.startMin;

    for (let m = startMin; m < range.endMin; m += 30) {
      const hh = Math.floor(m / 60);
      const mm = m % 60;
      const t = `${pad2(hh)}:${pad2(mm)}`;
      const used = occupiedCounts.get(t) || 0;
      if (used < (range.cap || 1)) return t;
    }
    return null;
  }

  function showSlotFullMessage(dateStr, timeHHMM) {
    if (!availabilityMsg) return;
    const next = findNextAvailableTime(dateStr, timeHHMM);
    if (next) availabilityMsg.textContent = `Hor√°rio lotado. Pr√≥ximo dispon√≠vel: ${next}.`;
    else availabilityMsg.textContent = 'Hor√°rio lotado e n√£o h√° mais hor√°rios dispon√≠veis nesse dia. Escolha outra data.';
  }

  if (minuteSelect) {
    minuteSelect.addEventListener('change', () => {
      const dateStr = dateInput.value;
      const t = getSelectedTimeHHMM();
      if (!dateStr || !t) return;
      const range = buildRangeForDate(dateStr);
      if (!range || range.closed) return;
      const used = occupiedCounts.get(t) || 0;
      if (used >= (range.cap || 1)) showSlotFullMessage(dateStr, t);
      else setAvailabilityMessage(dateStr);
    });
  }


  // ======= EVENTOS =======
  btnIniciar.addEventListener('click', async () => {
    onboardingSection.style.display = 'none';
    app.style.display = 'flex';
    showStep(1);
    setTimeout(() => phoneInput.focus(), 200);

    try {
      await loadOpeningHours();
      await loadServicesForSelect();

  if (serviceSelect) {
    serviceSelect.addEventListener('change', () => {
      setSingleServiceFromSelectIfEmpty();
    });
  }

  await loadMimosForRoleta();
    } catch (e) {
      console.error('Erro ao carregar servi√ßos:', e);
      serviceSelect.disabled = true;
      serviceSelect.innerHTML = '<option value="">Erro ao carregar servi√ßos</option>';
      if (serviceHelp) serviceHelp.textContent = 'N√£o foi poss√≠vel carregar a lista de servi√ßos.';
    }
  });

  btnHowItWorks.addEventListener('click', () => {
    const isHidden = howItWorksBox.classList.contains('hidden');
    if (isHidden) {
      howItWorksBox.classList.remove('hidden');
      btnHowItWorks.textContent = 'Fechar explica√ß√£o';
    } else {
      howItWorksBox.classList.add('hidden');
      btnHowItWorks.textContent = 'Entender rapidinho como funciona';
    }
  });

  btnStep1Next.addEventListener('click', async () => {
    step1Error.classList.add('hidden');
    const digits = sanitizePhone(phoneInput.value.trim());

    if (!digits || digits.length < 10) {
      step1Error.textContent = 'Por favor, informe um WhatsApp v√°lido (com DDD).';
      step1Error.classList.remove('hidden');
      return;
    }

    currentPhoneDigits = digits;

    try {
      const lookup = await apiPost('/api/customers/lookup', { phone: digits });

      if (lookup.exists && lookup.customer) {
        currentCustomer = lookup.customer;

        try {
          const petsResp = await apiGet('/api/pets', { customer_id: currentCustomer.id });
          currentPets = petsResp.pets || [];
        } catch (e) {
          console.error('Erro ao buscar pets do cliente:', e);
          currentPets = [];
        }

        fillPetSelect();
        showStep(3);
      } else {
        currentCustomer = null;
        currentPets = [];
        ownerName.value = '';
        petsContainer.innerHTML = '';
        createPetFields();
        showStep(2);
      }
    } catch (e) {
      step1Error.textContent = e.message;
      step1Error.classList.remove('hidden');
    }
  });

  btnAddPet.addEventListener('click', () => createPetFields());

  btnStep2Next.addEventListener('click', async () => {
    step2Error.classList.add('hidden');
    const name = ownerName.value.trim();
    const pets = getPetsFromForm();

    if (!name) {
      step2Error.textContent = 'Informe seu nome.';
      step2Error.classList.remove('hidden');
      return;
    }
    if (!pets.length) {
      step2Error.textContent = 'Cadastre pelo menos um pet para continuar.';
      step2Error.classList.remove('hidden');
      return;
    }

    try {
      const cRes = await apiPost('/api/customers', { name, phone: currentPhoneDigits });

      if (!cRes || !cRes.customer || !cRes.customer.id) {
        console.error('Resposta inesperada de /api/customers:', cRes);
        throw new Error('Cadastro do cliente n√£o retornou ID. Verifique a API /api/customers.');
      }

      currentCustomer = cRes.customer;

      currentPets = [];
      for (const p of pets) {
        const respPet = await apiPost('/api/pets', {
          customer_id: currentCustomer.id,
          name: p.name,
          breed: p.breed,
          size: p.size || null,
          coat: p.coat || null,
          info: p.info || null
        });

        if (!respPet || !respPet.pet || !respPet.pet.id) {
          console.error('Resposta inesperada de /api/pets:', respPet);
          throw new Error('Cadastro do pet n√£o retornou ID. Verifique a API /api/pets.');
        }

        currentPets.push(respPet.pet);
      }

      fillPetSelect();
      showStep(3);
    } catch (e) {
      step2Error.textContent = e.message;
      step2Error.classList.remove('hidden');
    }
  });

  btnSpin.addEventListener('click', () => {
    step3Error.classList.add('hidden');
    if (spinning) return;

    spinning = true;
    btnSpin.disabled = true;

    sortingScreen.classList.remove('hidden');

    const randomIndex = Math.floor(Math.random() * prizes.length);
    const prize = prizes[randomIndex];

    const baseRotation = 360 * 4;
    const segmentAngle = 360 / prizes.length;
    const extraRotation = segmentAngle * randomIndex + segmentAngle / 2;
    const finalRotation = baseRotation + extraRotation;

    wheel.style.transition = 'transform 2.5s ease-out';
    wheel.style.transform = `rotate(${finalRotation}deg)`;

    setTimeout(() => {
      wheel.style.transition = 'none';
      const normalized = finalRotation % 360;
      wheel.style.transform = `rotate(${normalized}deg)`;
      setPrize(prize);
      spinning = false;
      btnSpin.disabled = false;
    }, 2600);

    setTimeout(() => {
      sortingScreen.classList.add('hidden');
      showStep(4);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 5000);
  });

  dateInput.addEventListener('change', async () => {
    step4Error.classList.add('hidden');

    resetTimeSelects();
    setAvailabilityMessage(dateInput.value);

    try {
      await loadOccupiedTimesForDate(dateInput.value);
    } catch (e) {
      console.error('Falha ao carregar hor√°rios ocupados:', e);
      occupiedCounts = new Map();
    }

    setAvailabilityMessage(dateInput.value);
    populateHourSelect(dateInput.value);
  });

  hourSelect.addEventListener('change', () => {
    populateMinuteSelect(dateInput.value, hourSelect.value);
  });

  btnConfirmBooking.addEventListener('click', async () => {
    step4Error.classList.add('hidden');
    step4Success.classList.add('hidden');

    if (!currentCustomer) {
      step4Error.textContent = 'Ocorreu um problema com o cadastro. Volte e tente novamente.';
      step4Error.classList.remove('hidden');
      return;
    }

    if (!selectedPrize) {
      step4Error.textContent = 'Gire a roleta antes de confirmar o agendamento.';
      step4Error.classList.remove('hidden');
      return;
    }

    const petId = petSelect.value;

    // servi√ßos (multi)
    const selectedOpt = serviceSelect.options[serviceSelect.selectedIndex];
    const pickedServiceId = String(serviceSelect.value || '');
    if (!selectedServiceIds.length && pickedServiceId) selectedServiceIds = [pickedServiceId];

    const pickedServices = selectedServiceIds
      .map(id => (servicesCache || []).find(s => String(s.id) === String(id)))
      .filter(Boolean);

    const primaryServiceId = pickedServices.length ? Number(pickedServices[0].id) : (pickedServiceId ? Number(pickedServiceId) : null);

    const servicesJson = pickedServices.map(s => ({
      id: Number(s.id),
      title: String(s.title || ''),
      value_cents: (s.value_cents != null ? Number(s.value_cents) : null),
      duration_min: (s.duration_min != null ? Number(s.duration_min) : null)
    }));

    const servicesText = pickedServices.length
      ? pickedServices.map(s => String(s.title || '')).join(' + ')
      : (selectedOpt?.dataset?.title || selectedOpt?.textContent || '');

    const totalCents = pickedServices.reduce((acc, s) => acc + (Number.isFinite(Number(s.value_cents)) ? Number(s.value_cents) : 0), 0);
    const serviceValueBRL = pickedServices.length ? formatCentsBRL(totalCents) : '‚Äî';

    const date = dateInput.value;
    const time = getSelectedTimeHHMM();
    const notes = notesInput.value.trim();

    if (!petId) {
      step4Error.textContent = 'Selecione o pet que vai usar o mimo.';
      step4Error.classList.remove('hidden');
      return;
    }
    if (!selectedServiceIds.length) {
      step4Error.textContent = 'Selecione o servi√ßo do agendamento.';
      step4Error.classList.remove('hidden');
      return;
    }
    if (!date) {
      step4Error.textContent = 'Selecione a data.';
      step4Error.classList.remove('hidden');
      return;
    }
    if (!time) {
      step4Error.textContent = 'Selecione a hora e o minuto (00 ou 30).';
      step4Error.classList.remove('hidden');
      return;
    }

    {
      const range = buildRangeForDate(date);
      const used = occupiedCounts.get(time) || 0;
      const cap = range && !range.closed ? (range.cap || 1) : 0;
      if (cap > 0 && used >= cap) {
        step4Error.textContent = 'Esse hor√°rio acabou de ser preenchido. Escolha outro.';
        step4Error.classList.remove('hidden');
        return;
      }
    }

    const erroHorario = validarDiaHora(date, time);
    if (erroHorario) {
      step4Error.textContent = erroHorario;
      step4Error.classList.remove('hidden');
      return;
    }

    // valida capacidade do slot (antes de bater no backend)
    const range = buildRangeForDate(date);
    if (range && !range.closed) {
      const used = occupiedCounts.get(time) || 0;
      if (used >= (range.cap || 1)) {
        showSlotFullMessage(date, time);
        step4Error.textContent = 'Esse hor√°rio j√° est√° lotado. Escolha outro hor√°rio.';
        step4Error.classList.remove('hidden');
        return;
      }
    }
    try {
      const paymentChoice = paymentMethodSelect ? String(paymentMethodSelect.value || 'balcao') : 'balcao';
      const isPix = paymentChoice === 'pix';

      const created = await apiPost('/api/bookings', {
        customer_id: currentCustomer.id,
        pet_id: parseInt(petId, 10),
        date,
        time,
        service: servicesText,
        service_id: primaryServiceId,
        services: servicesJson,
        prize: selectedPrize.key,
        notes,
        status: 'agendado',
        payment_method: isPix ? 'pix' : 'balcao',
        payment_status: isPix ? 'Aguardando pagamento' : 'N√£o Pago'
      });

      const bookingId = created && created.booking && created.booking.id ? Number(created.booking.id) : null;

      const pet = currentPets.find(p => String(p.id) === String(petId));
      const petName = pet ? pet.name : 'seu pet';

      // Se o cliente escolheu Pix, gerar cobran√ßa e aguardar confirma√ß√£o autom√°tica
      if (isPix) {
        if (!bookingId) throw new Error('N√£o foi poss√≠vel gerar o Pix (agendamento sem ID). Tente novamente.');

        step4Success.classList.add('hidden');
        step4Error.classList.add('hidden');

        btnConfirmBooking.disabled = true;
        updateConfirmButtonLabel();

        pixPaymentBox.classList.remove('hidden');
        pixStatusMsg.textContent = 'Gerando Pix...';

        const pix = await apiPost('/api/payments/mercadopago/pix', { booking_id: bookingId });

        currentPixBookingId = bookingId;

        // QR base64 -> imagem
        if (pix && pix.qr_code_base64) {
          pixQrImg.src = 'data:image/png;base64,' + pix.qr_code_base64;
        } else if (pix && pix.qr_code_image_url) {
          pixQrImg.src = pix.qr_code_image_url;
        } else {
          pixQrImg.src = '';
        }

        pixCopyPaste.value = (pix && pix.qr_code) ? pix.qr_code : '';

        pixStatusMsg.textContent = 'Aguardando pagamento... Assim que confirmar, a tela avisa automaticamente.';

        stopPixPolling();
        pixPollTimer = setInterval(async () => {
          try {
            const resp = await apiGet(`/api/payments/mercadopago/bookings/${bookingId}/sync?t=${Date.now()}`);
            const b = resp && resp.booking ? resp.booking : null;
            const ps = String((b && b.payment_status) || '').toLowerCase();
            const st = String((b && b.status) || '').toLowerCase();

            if (ps === 'pago' || ps === 'pago ' || ps === 'paid' || ps === 'approved' || st === 'confirmado' || st === 'confirmado ' || st === 'approved') {
              stopPixPolling();
              pixStatusMsg.textContent = 'Pagamento confirmado! Finalizando...';
              pfToast('Pagamento Pix confirmado!', 'success', 2000);

              btnConfirmBooking.disabled = false;
              resetPixUI();

              // Continua o fluxo normal: WhatsApp + retorno ao in√≠cio
              const message = buildWhatsappMessage({
                customerName: currentCustomer.name,
                phone: currentCustomer.phone,
                petName,
                servicesText,
                date,
                time,
                prizeKey: selectedPrize.key,
                notes
              }) + "\n\nPagamento: PIX CONFIRMADO ‚úÖ";

              const url = buildWhatsappUrl(message);

              sortingScreen.classList.remove('hidden');
              setTimeout(() => {
                sortingScreen.classList.add('hidden');
                successScreen.classList.remove('hidden');
              }, 850);

              pfToast('Agendamento enviado com sucesso! Te chamamos no WhatsApp üêæ', 'success', 2200);

              setTimeout(() => {
                window.open(url, '_blank');
              }, 650);

              setTimeout(() => {
                successScreen.classList.add('hidden');
                try { localStorage.removeItem('petfunny_prize'); } catch {}
                window.location.href = '/';
              }, 1300);// Atualiza texto de status enquanto aguarda (evita parecer "travado")
if (ps === 'recusado' || ps === 'rejected' || ps === 'cancelled') {
  stopPixPolling();
  btnConfirmBooking.disabled = false;
  pixStatusMsg.textContent = 'Pagamento recusado/cancelado. Voc√™ pode gerar um novo Pix ou escolher pagamento no balc√£o.';
  pfToast('Pix recusado/cancelado', 'error', 2500);
} else if (ps === 'aguardando pagamento' || ps === 'pending' || ps === 'in_process' || ps === 'in process') {
  pixStatusMsg.textContent = 'Aguardando pagamento... (atualizando automaticamente)';
}
            }
          } catch (e) {
            // mant√©m aguardando
          }
        }, 2500);

        // fallback: ap√≥s 3 min, libera e orienta
        setTimeout(() => {
          if (currentPixBookingId === bookingId) {
            stopPixPolling();
            btnConfirmBooking.disabled = false;
            pixStatusMsg.textContent = 'Ainda n√£o identificamos o pagamento. Se j√° pagou, aguarde mais alguns instantes ou fale com a gente pelo WhatsApp.';
          }
        }, 180000);

        return;
      }

      // Pagamento no balc√£o (cart√£o/d√©bito/cr√©dito)
      const message = buildWhatsappMessage({
        customerName: currentCustomer.name,
        phone: currentCustomer.phone,
        petName,
        servicesText,
        date,
        time,
        prizeKey: selectedPrize.key,
        notes
      }) + "\n\nPagamento: CART√ÉO NO BALC√ÉO (D√âBITO/CR√âDITO)";

      const url = buildWhatsappUrl(message);

      sortingScreen.classList.remove('hidden');
      setTimeout(() => {
        sortingScreen.classList.add('hidden');
        successScreen.classList.remove('hidden');
      }, 850);

      // Toast visual + encaminhamento WhatsApp e retorno ao in√≠cio
      pfToast('Agendamento enviado com sucesso! Te chamamos no WhatsApp üêæ', 'success', 2200);

      setTimeout(() => {
        window.open(url, '_blank');
      }, 650);

      setTimeout(() => {
        successScreen.classList.add('hidden');
        try { localStorage.removeItem('petfunny_prize'); } catch {}
        // voltar para o in√≠cio (onboarding)
        window.location.href = '/';
      }, 1300);

    } catch (e) {
      console.error('Erro ao confirmar agendamento:', e);
      btnConfirmBooking.disabled = false;
      step4Error.textContent = e.message || 'Erro ao confirmar agendamento.';
      step4Error.classList.remove('hidden');
    }
  });

  createPetFields();
  resetTimeSelects();
  setAvailabilityMessage('');
</script>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "PetStore",
  "name": "Pet Funny Banho e Tosa",
  "image": "https://www.agendapetfunny.com.br/og-image.jpg",
  "address": {
    "@type": "PostalAddress",
    "streetAddress": "Rua Virg√≠lio de Carvalho Neves Neto, 794",
    "addressLocality": "Ribeir√£o Preto",
    "addressRegion": "SP",
    "addressCountry": "BR"
  },
  "telephone": "+5516981535338",
  "url": "https://www.agendapetfunny.com.br",
  "priceRange": "$$",
  "sameAs": [
    "https://www.instagram.com/petfunny"
  ]
}

      successScreen.classList.remove('hidden');

      // Toast visual
      pfToast(
        'Agendamento enviado com sucesso! Te chamamos no WhatsApp üêæ',
        'success',
        2200
      );

      // Aguarda mais tempo antes de abrir o WhatsApp
      setTimeout(() => {
        window.open(url, '_blank');
      }, 2000); // ‚¨ÖÔ∏è tempo maior aqui (2s)

      // Aguarda mais um pouco e volta para o in√≠cio
      setTimeout(() => {
        successScreen.classList.add('hidden');
        try { localStorage.removeItem('petfunny_prize'); } catch {}
        window.location.href = '/';
      }, 3500); // ‚¨ÖÔ∏è retorno ap√≥s WhatsApp

</script>

</body>
</html>
