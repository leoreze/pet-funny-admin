<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Roleta de Mimos ‚Äì Pet Funny</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --turquesa: #01ADB7;
      --coral: #F9A197;
      --escuro: #222222;
      --cinza-claro: #f4f4f4;
      --branco: #ffffff;
      --bg-grad: radial-gradient(circle at top, #ffffff 0, #f4f7f8 40%, #e9f5f6 100%);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg-grad);
      color: var(--escuro);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }

    .top-brand {
      width: 100%;
      display: flex;
      justify-content: center;
      padding: 10px 16px 4px;
    }
    .top-brand img { max-width: 260px; height: auto; display: block; }
    @media (max-width: 720px) { .top-brand img { max-width: 210px; } }

    .onboarding {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px 16px;
    }
    .onboarding-card {
      max-width: 640px;
      width: 100%;
      background: var(--branco);
      border-radius: 24px;
      box-shadow: 0 22px 50px rgba(0, 0, 0, 0.10);
      padding: 24px 20px 20px;
      position: relative;
      overflow: hidden;
    }
    .onboarding-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(1, 173, 183, 0.08);
      color: #0e5f64;
      margin-bottom: 10px;
    }
    .onboarding-title { font-size: 26px; line-height: 1.2; margin-bottom: 8px; color: #133238; }
    .onboarding-title span { color: var(--turquesa); }
    .onboarding-sub { font-size: 14px; color: #4b5b5f; margin-bottom: 14px; }
    .onboarding-sub strong { color: var(--turquesa); }
    .onboarding-list { list-style: none; margin-bottom: 18px; font-size: 13px; color: #455a64; }
    .onboarding-list li { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
    .onboarding-list li span { font-size: 16px; }
    .onboarding-cta { display: flex; justify-content: flex-start; margin-top: 6px; gap: 8px; flex-wrap: wrap; }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--turquesa), var(--coral));
      color: #ffffff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.16);
      transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s;
      text-decoration: none;
    }
    .btn:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.18);
    }
    .btn:disabled {
      cursor: not-allowed;
      opacity: 0.55;
      box-shadow: none;
      transform: none;
    }
    .btn-secondary {
      background: #eef3f4;
      color: #37474f;
      box-shadow: none;
      text-transform: none;
      letter-spacing: 0.04em;
      font-weight: 500;
    }

    .how-it-works {
      margin-top: 14px;
      padding: 12px 12px 10px;
      border-radius: 16px;
      border: 1px dashed #cfdfe3;
      background: #f7fbfc;
      font-size: 13px;
      color: #455a64;
      animation: fadeIn 0.18s ease-out;
    }
    .how-it-works-title {
      font-weight: 600;
      margin-bottom: 6px;
      color: #16363c;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .how-it-works-steps { list-style: none; margin-top: 4px; }
    .how-it-works-steps li { margin-bottom: 4px; }
    .how-it-works-steps strong { color: var(--turquesa); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

    #app { flex: 1; display: none; flex-direction: column; min-height: 0; }
    .page-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 16px 16px;
    }

    .card {
      max-width: 960px;
      width: 100%;
      background: var(--branco);
      border-radius: 24px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.10);
      padding: 20px 18px 22px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }
    .card-title-block { display: flex; flex-direction: column; gap: 4px; }
    .card-title { font-size: 20px; font-weight: 700; color: #16363c; }
    .card-subtitle { font-size: 13px; color: #607d8b; }

    .step-indicator {
      display: flex;
      gap: 4px;
      font-size: 11px;
      color: #607d8b;
      align-items: center;
      flex-wrap: wrap;
    }
    .step-pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #d0dde0;
      background: #f3f7f8;
      font-weight: 500;
    }
    .step-pill strong { color: var(--turquesa); }

    .steps-wrapper { display: flex; gap: 16px; flex-wrap: wrap; }
    .left-panel { flex: 1 1 280px; min-width: 0; }
    .right-panel {
      flex: 1 1 240px;
      min-width: 0;
      background: #f8fbfc;
      border-radius: 18px;
      padding: 12px 12px 14px;
      border: 1px dashed #d1e4e7;
    }

    .side-title { font-size: 13px; font-weight: 600; color: #37565c; margin-bottom: 6px; }
    .side-list { list-style: none; font-size: 12px; color: #455a64; }
    .side-list li { display: flex; align-items: flex-start; gap: 6px; margin-bottom: 6px; }
    .side-bullet {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      background: linear-gradient(135deg, var(--turquesa), var(--coral));
      color: #fff;
      flex-shrink: 0;
    }
    .side-caption { font-size: 11px; color: #78909c; margin-top: 6px; }

    .field-group { display: flex; flex-direction: column; gap: 6px; margin-bottom: 10px; }
    .field-label { font-size: 12px; font-weight: 500; color: #455a64; }
    .field-help { font-size: 11px; color: #78909c; }

    input[type="text"], input[type="tel"], input[type="date"], input[type="time"], select, textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid #d4dde0;
      padding: 8px 10px;
      font-size: 13px;
      transition: border-color 0.12s ease, box-shadow 0.12s ease;
      font-family: inherit;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--turquesa);
      box-shadow: 0 0 0 2px rgba(1, 173, 183, 0.16);
    }
    textarea { resize: vertical; min-height: 50px; }

    .btn-inline { margin-top: 6px; }
    .error-msg { font-size: 12px; color: #c62828; margin-top: 4px; }
    .success-msg { font-size: 12px; color: #2e7d32; margin-top: 4px; }
    .hidden { display: none !important; }

    .pet-wrapper {
      border: 1px solid #e0e7ea;
      border-radius: 14px;
      padding: 10px 10px 8px;
      margin-bottom: 8px;
      background: #f8fbfc;
    }

    .wheel-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
    }
    .wheel-container {
      position: relative;
      width: 260px;
      height: 260px;
      border-radius: 50%;
      margin: 0 auto;
      background: conic-gradient(
        var(--turquesa) 0deg 90deg,
        var(--coral) 90deg 180deg,
        #ffddc5 180deg 270deg,
        #7fdde4 270deg 360deg
      );
      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.16);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: visible;
    }
    .wheel-inner {
      width: 68%;
      height: 68%;
      border-radius: 50%;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .wheel-center-dot {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--turquesa), var(--coral));
      box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.9);
    }
    .wheel-pointer {
      position: absolute;
      top: -18px;
      left: 50%;
      transform: translateX(-50%);
      width: 0; height: 0;
      border-left: 14px solid transparent;
      border-right: 14px solid transparent;
      border-bottom: 18px solid #ff7043;
      filter: drop-shadow(0 4px 5px rgba(0, 0, 0, 0.2));
    }
    .wheel-shadow {
      position: absolute;
      bottom: -12px;
      left: 50%;
      transform: translateX(-50%);
      width: 70%;
      height: 20px;
      background: radial-gradient(ellipse at center, rgba(0,0,0,0.25), transparent 70%);
      opacity: 0.8;
      pointer-events: none;
    }

    .badge-prize {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--turquesa), var(--coral));
      color: #ffffff;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .badge-icon {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.16);
      font-size: 16px;
    }
    .badge-label { display: flex; flex-direction: column; line-height: 1.2; }
    .badge-label span { font-size: 11px; font-weight: 400; opacity: 0.9; }

    .pet-select-info { font-size: 11px; color: #78909c; margin-top: 2px; }

    .full-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, #ffffff 0, #eaf7f8 40%, #d6eef0 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .overlay-card {
      background: #ffffff;
      border-radius: 24px;
      padding: 24px 22px 20px;
      max-width: 420px;
      width: 90%;
      box-shadow: 0 20px 50px rgba(0,0,0,0.18);
      text-align: center;
    }
    .overlay-icon-circle {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      margin: 0 auto 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--turquesa), var(--coral));
      color: #ffffff;
      font-size: 30px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.16);
    }
    .overlay-title { font-size: 20px; font-weight: 700; color: #16363c; margin-bottom: 6px; }
    .overlay-subtitle { font-size: 13px; color: #546e7a; margin-bottom: 14px; }

    .overlay-dots { display: inline-flex; gap: 6px; margin-top: 4px; }
    .overlay-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--turquesa);
      animation: dotPulse 0.9s infinite ease-in-out;
    }
    .overlay-dot:nth-child(2) { animation-delay: 0.15s; }
    .overlay-dot:nth-child(3) { animation-delay: 0.3s; }
    @keyframes dotPulse {
      0%, 80%, 100% { transform: scale(0.7); opacity: 0.4; }
      40% { transform: scale(1); opacity: 1; }
    }

    .overlay-wheel {
      margin: 10px auto 6px;
      width: 180px;
      height: 180px;
      border-radius: 50%;
      background: conic-gradient(
        var(--turquesa) 0deg 90deg,
        var(--coral) 90deg 180deg,
        #ffddc5 180deg 270deg,
        #7fdde4 270deg 360deg
      );
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.18);
      position: relative;
      animation: overlaySpin 1.2s linear infinite;
    }
    .overlay-wheel::before {
      content: "";
      position: absolute;
      inset: 24%;
      border-radius: 50%;
      background: #ffffff;
      box-shadow: 0 0 0 4px rgba(255,255,255,0.9);
    }
    .overlay-wheel::after {
      content: "";
      position: absolute;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--turquesa), var(--coral));
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 0 4px rgba(255,255,255,0.95);
    }
    .overlay-pointer {
      position: absolute;
      top: -16px;
      left: 50%;
      transform: translateX(-50%);
      width: 0; height: 0;
      border-left: 13px solid transparent;
      border-right: 13px solid transparent;
      border-bottom: 17px solid #ff7043;
      filter: drop-shadow(0 4px 5px rgba(0, 0, 0, 0.2));
    }
    @keyframes overlaySpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .site-footer {
      border-top: 1px solid #dde5e8;
      padding: 12px 16px 16px;
      background: transparent;
    }
    .footer-inner {
      max-width: 1120px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .footer-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .footer-logo { max-width: 140px; height: auto; }
    .footer-info {
      font-size: 12px;
      color: #455a64;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .footer-info strong { font-size: 13px; color: #263238; }
    .footer-bottom { font-size: 11px; color: #78909c; text-align: center; margin-top: 4px; }

    @media (max-width: 720px) {
      .card { padding: 18px 14px 18px; }
      .steps-wrapper { flex-direction: column; }
    }
  </style>
</head>
<body>

<header class="top-brand">
  <img src="roleta-de-mimos-logo.svg" alt="Roleta de Mimos ‚Äì Pet Funny" />
</header>

<section id="onboarding" class="onboarding">
  <div class="onboarding-card">
    <div class="onboarding-badge">üéÅ Roleta de Mimos ‚Ä¢ Pet Funny</div>
    <h1 class="onboarding-title">
      Aqui o seu pet entra pra tomar banho e sai
      <span>cheiroso, mimado e feliz</span> üíõ
    </h1>
    <p class="onboarding-sub">
      Na <strong>Roleta de Mimos da Pet Funny</strong>, cada agendamento pode ganhar um carinho extra:
      tosa higi√™nica, hidrata√ß√£o, fotos lindas e muito mais. Voc√™ s√≥ precisa
      se cadastrar, girar a roleta e escolher o melhor hor√°rio pro seu melhor amigo.
    </p>

    <ul class="onboarding-list">
      <li><span>üêæ</span> Mimos pensados pra deixar o banho &amp; tosa ainda mais especial.</li>
      <li><span>üïí</span> Tudo organizadinho, com hor√°rio marcado e confirma√ß√£o pelo WhatsApp.</li>
      <li><span>üè°</span> Jeitinho de pet shop de bairro: a gente conhece cada pet pelo nome.</li>
    </ul>

    <div class="onboarding-cta">
      <button id="btnIniciar" class="btn">Quero participar da Roleta de Mimos</button>
      <button id="btnHowItWorks" class="btn btn-secondary" type="button">Entender rapidinho como funciona</button>
    </div>

    <div id="howItWorksBox" class="how-it-works hidden">
      <div class="how-it-works-title">
        <span>‚ú®</span> <span>Em 4 passos, seu pet j√° vem se divertir na Pet Funny:</span>
      </div>
      <ul class="how-it-works-steps">
        <li><strong>1. Voc√™ coloca seu WhatsApp</strong> pra gente reconhecer ou criar seu cadastro.</li>
        <li><strong>2. Cadastra seus pets</strong> (ou confirma os que j√° existem no sistema).</li>
        <li><strong>3. Gira a Roleta de Mimos</strong> e descobre qual presentinho o seu pet ganhou.</li>
        <li><strong>4. Escolhe o dia e hor√°rio</strong> e j√° sai daqui com o agendamento enviado pro nosso WhatsApp.</li>
      </ul>
      <p style="font-size:12px; color:#607d8b; margin-top:6px;">
        Tudo r√°pido, sem burocracia e com a mesma aten√ß√£o que a gente d√° no balc√£o. üíõ
      </p>
    </div>
  </div>
</section>

<div id="app">
  <div class="page-content">
    <main class="card">
      <div class="card-header">
        <div class="card-title-block">
          <div class="card-title">Roleta de Mimos Pet Funny</div>
          <div class="card-subtitle">Cadastre-se, gire a roleta e agende o banho do seu pet com um mimo especial üê∂‚ú®</div>
        </div>
        <div class="step-indicator">
          <div class="step-pill" id="stepPillText"><strong>Passo 1</strong> ‚Ä¢ Identifica√ß√£o</div>
        </div>
      </div>

      <div class="steps-wrapper">
        <div class="left-panel">

          <section id="step1" class="step">
            <div class="field-group">
              <div class="field-label">Qual √© o seu WhatsApp?</div>
              <div class="field-help">Vamos usar apenas para confirmar o agendamento e mandar as informa√ß√µes do seu mimo.</div>
              <input type="tel" id="phoneInput" placeholder="(16) 98153-5338" />
            </div>
            <div id="step1Error" class="error-msg hidden"></div>
            <button id="btnStep1Next" class="btn btn-inline">Continuar</button>
          </section>

          <section id="step2" class="step hidden">
            <div class="field-group">
              <div class="field-label">Seu nome completo</div>
              <input type="text" id="ownerName" placeholder="Como voc√™ gostaria de ser chamado(a)?" />
            </div>

            <div class="field-group">
              <div class="field-label">Pets</div>
              <div class="field-help">
                Cadastre um ou mais pets. Depois voc√™ escolhe qual deles vai usar o mimo na hora de agendar.
              </div>
            </div>

            <div id="petsContainer"></div>

            <button type="button" id="btnAddPet" class="btn btn-secondary btn-inline">
              + Adicionar outro pet
            </button>

            <div id="step2Error" class="error-msg hidden"></div>

            <button id="btnStep2Next" class="btn btn-inline" style="margin-top:10px;">
              Continuar para a Roleta
            </button>
          </section>

          <section id="step3" class="step hidden">
            <div class="wheel-wrapper">
              <div class="wheel-container" id="wheel">
                <div class="wheel-pointer"></div>
                <div class="wheel-inner">
                  <div class="wheel-center-dot"></div>
                </div>
                <div class="wheel-shadow"></div>
              </div>
              <div class="field-help">
                Clique em <strong>‚ÄúGirar roleta‚Äù</strong> e descubra qual mimo o seu pet vai ganhar.
              </div>
              <button id="btnSpin" class="btn">Girar roleta</button>
              <div id="step3Error" class="error-msg hidden"></div>
            </div>
          </section>

          <section id="step4" class="step hidden">
            <div id="prizeBadgeWrapper" class="badge-prize hidden">
              <div class="badge-icon" id="prizeIcon">üéÅ</div>
              <div class="badge-label">
                <strong id="prizeTitle">Mimo sorteado</strong>
                <span id="prizeSubtitle">J√° est√° garantido no pr√≥ximo agendamento.</span>
              </div>
            </div>

            <div class="field-group">
              <div class="field-label">Para qual pet ser√° esse mimo?</div>
              <select id="petSelect"></select>
              <div class="pet-select-info">
                Os pets cadastrados no seu WhatsApp aparecem aqui. Se quiser cadastrar outro, √© s√≥ falar com a gente pelo WhatsApp. üí¨
              </div>
            </div>

            <div class="field-group">
              <div class="field-label">Qual servi√ßo voc√™ deseja agendar?</div>

              <select id="serviceSelect" disabled>
                <option value="">Carregando servi√ßos...</option>
              </select>
              <div class="field-help" id="serviceHelp">O valor ser√° preenchido automaticamente no WhatsApp.</div>
            </div>

            <div class="field-group">
              <div class="field-label">Escolha o dia</div>
              <div class="field-help">
                Atendemos de <strong>segunda a sexta, das 07:30 √†s 17:30</strong>, e
                <strong>aos s√°bados, das 07:30 √†s 13:00</strong>.
              </div>
              <input type="date" id="dateInput" />
            </div>

            <div class="field-group">
              <div class="field-label">Escolha o hor√°rio</div>
              <div style="display:flex; gap:10px;">
                <select id="hourSelect" style="flex:1;"></select>
                <select id="minuteSelect" style="flex:1;"></select>
              </div>
              <div id="availabilityMsg" class="field-help"></div>
            </div>

            <div class="field-group">
              <div class="field-label">Observa√ß√µes (opcional)</div>
              <textarea id="notesInput" placeholder="Ex: busca em casa, pet idoso, medica√ß√£o, etc."></textarea>
            </div>

            <div id="step4Error" class="error-msg hidden"></div>
            <div id="step4Success" class="success-msg hidden"></div>

            <button id="btnConfirmBooking" class="btn btn-inline">
              Confirmar agendamento e falar no WhatsApp
            </button>
          </section>

        </div>

        <aside class="right-panel">
          <div class="side-title">O que o seu pet pode ganhar na Roleta de Mimos?</div>
          <ul class="side-list">
            <li>
              <div class="side-bullet">‚úÇÔ∏è</div>
              <div>
                <strong>Tosa Higi√™nica</strong><br />
                Limpeza das √°reas √≠ntimas, patinhas e orelhas para mais conforto e higiene.
              </div>
            </li>
            <li>
              <div class="side-bullet">üíß</div>
              <div>
                <strong>Hidrata√ß√£o</strong><br />
                Tratamento especial para deixar os pelos mais macios, cheirosos e saud√°veis.
              </div>
            </li>
            <li>
              <div class="side-bullet">üì∏</div>
              <div>
                <strong>Foto e V√≠deo Profissional</strong><br />
                Registro fofo e profissional do banho do seu pet para voc√™ guardar e postar.
              </div>
            </li>
            <li>
              <div class="side-bullet">üêæ</div>
              <div>
                <strong>Patinhas impec√°veis</strong><br />
                Acabamento caprichado nas patinhas para aquele passeio cheio de estilo.
              </div>
            </li>
          </ul>
          <div class="side-caption">
            *Um mimo por agendamento. V√°lido apenas nos hor√°rios dispon√≠veis da agenda Pet Funny. üíõ
          </div>
        </aside>
      </div>
    </main>
  </div>
</div>

<section id="sortingScreen" class="full-overlay hidden">
  <div class="overlay-card">
    <div class="overlay-icon-circle">üéÅ</div>
    <div class="overlay-title">Sorteando o mimo do seu pet...</div>
    <div class="overlay-subtitle">
      Segura a ansiedade! Estamos girando a Roleta de Mimos pra ver qual carinho extra ele vai ganhar hoje. üê∂‚ú®
    </div>
    <div style="position: relative; display:inline-block;">
      <div class="overlay-wheel"></div>
      <div class="overlay-pointer"></div>
    </div>
    <div class="overlay-dots">
      <div class="overlay-dot"></div><div class="overlay-dot"></div><div class="overlay-dot"></div>
    </div>
  </div>
</section>

<section id="successScreen" class="full-overlay hidden">
  <div class="overlay-card">
    <div class="overlay-icon-circle">‚úÖ</div>
    <div class="overlay-title">Agendamento enviado com sucesso!</div>
    <div class="overlay-subtitle">
      Em instantes vamos abrir o WhatsApp da Pet Funny com todos os detalhes do banho
      e do mimo sorteado. √â s√≥ confirmar por l√°. üíö
    </div>
    <div class="overlay-dots">
      <div class="overlay-dot"></div><div class="overlay-dot"></div><div class="overlay-dot"></div>
    </div>
  </div>
</section>

<footer class="site-footer">
  <div class="footer-inner">
    <div class="footer-top">
      <img src="pet-funny-logo.svg" alt="Pet Funny" class="footer-logo" />
      <div class="footer-info">
        <strong>Pet Funny ‚Ä¢ Banho &amp; Tosa</strong>
        <span>Rua Virg√≠lio de Carvalho Neves Neto, 794 ‚Äì Ribeir√£o Preto / SP</span>
        <span>Hor√°rio: Seg‚ÄìSex: 07:30 √†s 17:30 ‚Ä¢ S√°bado: 07:30 √†s 13:00</span>
        <span>WhatsApp: (16) 98153-5338</span>
      </div>
    </div>
    <div class="footer-bottom">
      ¬© 2024 Pet Funny ‚Ä¢ Roleta de Mimos. Todos os direitos reservados.
    </div>
  </div>
</footer>

<script>
  const API_BASE_URL = ''; // mesmo host/porta do backend

  let currentPhoneDigits = null;
  let currentCustomer = null;
  let currentPets = [];
  let selectedPrize = null;
  let spinning = false;

  let occupiedTimes = new Set(); // "HH:MM"
  let servicesCache = [];

  const prizes = [
    { key: 'Tosa Higi√™nica', icon: '‚úÇÔ∏è', subtitle: 'Seu pet vai sair ainda mais confort√°vel e limpinho.' },
    { key: 'Hidrata√ß√£o', icon: 'üíß', subtitle: 'Pelos mais macios, cheirosos e saud√°veis.' },
    { key: 'Foto e V√≠deo Profissional', icon: 'üì∏', subtitle: 'Um registro lindo pra voc√™ guardar e postar.' },
    { key: 'Patinhas impec√°veis', icon: 'üêæ', subtitle: 'Acabamento perfeito para o pr√≥ximo passeio.' }
  ];

  const onboardingSection = document.getElementById('onboarding');
  const app = document.getElementById('app');
  const btnIniciar = document.getElementById('btnIniciar');
  const btnHowItWorks = document.getElementById('btnHowItWorks');
  const howItWorksBox = document.getElementById('howItWorksBox');

  const stepPillText = document.getElementById('stepPillText');

  const step1 = document.getElementById('step1');
  const step2 = document.getElementById('step2');
  const step3 = document.getElementById('step3');
  const step4 = document.getElementById('step4');

  const phoneInput = document.getElementById('phoneInput');
  const step1Error = document.getElementById('step1Error');
  const btnStep1Next = document.getElementById('btnStep1Next');

  const ownerName = document.getElementById('ownerName');
  const petsContainer = document.getElementById('petsContainer');
  const btnAddPet = document.getElementById('btnAddPet');
  const step2Error = document.getElementById('step2Error');
  const btnStep2Next = document.getElementById('btnStep2Next');

  const wheel = document.getElementById('wheel');
  const btnSpin = document.getElementById('btnSpin');
  const step3Error = document.getElementById('step3Error');

  const prizeBadgeWrapper = document.getElementById('prizeBadgeWrapper');
  const prizeIcon = document.getElementById('prizeIcon');
  const prizeTitle = document.getElementById('prizeTitle');
  const prizeSubtitle = document.getElementById('prizeSubtitle');

  const petSelect = document.getElementById('petSelect');
  const serviceSelect = document.getElementById('serviceSelect');
  const serviceHelp = document.getElementById('serviceHelp');

  const dateInput = document.getElementById('dateInput');

  const hourSelect = document.getElementById('hourSelect');
  const minuteSelect = document.getElementById('minuteSelect');
  const availabilityMsg = document.getElementById('availabilityMsg');

  const notesInput = document.getElementById('notesInput');

  const step4Error = document.getElementById('step4Error');
  const step4Success = document.getElementById('step4Success');
  const btnConfirmBooking = document.getElementById('btnConfirmBooking');

  const sortingScreen = document.getElementById('sortingScreen');
  const successScreen = document.getElementById('successScreen');

  const today = new Date().toISOString().split('T')[0];
  dateInput.min = today;

  function formatPhone(input) {
    let value = input.value.replace(/\D/g, "");
    if (value.length > 11) value = value.slice(0, 11);

    let formatted = value;
    if (value.length > 0) formatted = `(${value.slice(0, 2)}`;
    if (value.length >= 3) formatted = `(${value.slice(0, 2)}) ${value.slice(2, 3)}`;
    if (value.length >= 4) formatted = `(${value.slice(0, 2)}) ${value.slice(2, 3)} ${value.slice(3, 7)}`;
    if (value.length >= 8) {
      formatted = `(${value.slice(0, 2)}) ${value.slice(2, 3)} ${value.slice(3, 7)}-${value.slice(7, 11)}`;
    }
    input.value = formatted;
  }
  phoneInput.addEventListener("input", () => formatPhone(phoneInput));

  const racas = [
    'SRD (Sem Ra√ßa Definida)','Poodle','Shih Tzu','Lhasa Apso','Labrador Retriever','Golden Retriever',
    'Yorkshire Terrier','Bulldog Franc√™s','Bulldog Ingl√™s','Spitz Alem√£o (Lulu da Pomer√¢nia)','Beagle',
    'Border Collie','Boxer','Dachshund (Salsicha)','Malt√™s','Pinscher','Pastor Alem√£o','Rottweiler',
    'Pitbull','Pug','Cocker Spaniel','Schnauzer','Husky Siberiano','Akita','Chihuahua',
    'Outro (informar nas observa√ß√µes)'
  ];

  async function apiPost(path, body) {
    const resp = await fetch(`${API_BASE_URL}${path}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) throw new Error(data.error || 'Erro ao salvar.');
    return data;
  }

  async function apiGet(path, params = {}) {
    const url = new URL((API_BASE_URL || '') + path, window.location.origin);
    Object.entries(params).forEach(([k, v]) => {
      if (v !== undefined && v !== null && v !== '') url.searchParams.append(k, v);
    });
    const resp = await fetch(url.toString());
    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) throw new Error(data.error || 'Erro ao buscar dados.');
    return data;
  }

  // ======= SERVICES (din√¢mico) =======
  function formatCentsBRL(cents) {
    const n = Number(cents);
    if (!Number.isFinite(n)) return '';
    return (n / 100).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  function renderServiceSelect(services) {
    serviceSelect.innerHTML = '';

    const opt0 = document.createElement('option');
    opt0.value = '';
    opt0.textContent = 'Selecione o servi√ßo...';
    serviceSelect.appendChild(opt0);

    (services || []).forEach(s => {
      const opt = document.createElement('option');
      opt.value = String(s.id);

      opt.dataset.title = String(s.title || '');
      opt.dataset.valueCents = String(s.value_cents ?? '');

      const priceLabel = (s.value_cents !== undefined && s.value_cents !== null && s.value_cents !== '')
        ? ` ‚Ä¢ ${formatCentsBRL(s.value_cents)}`
        : '';

      opt.textContent = `${s.title}${priceLabel}`;
      serviceSelect.appendChild(opt);
    });

    if (!services || !services.length) {
      serviceSelect.disabled = true;
      serviceSelect.innerHTML = '<option value="">Nenhum servi√ßo cadastrado</option>';
    } else {
      serviceSelect.disabled = false;
    }
  }

  async function loadServicesForSelect() {
    serviceSelect.disabled = true;
    serviceSelect.innerHTML = '<option value="">Carregando servi√ßos...</option>';

    const resp = await apiGet('/api/services', {});
    servicesCache = resp.services || [];
    renderServiceSelect(servicesCache);
  }

  function showStep(stepNumber) {
    [step1, step2, step3, step4].forEach(s => s.classList.add('hidden'));
    if (stepNumber === 1) {
      step1.classList.remove('hidden');
      stepPillText.innerHTML = '<strong>Passo 1</strong> ‚Ä¢ Identifica√ß√£o';
    } else if (stepNumber === 2) {
      step2.classList.remove('hidden');
      stepPillText.innerHTML = '<strong>Passo 2</strong> ‚Ä¢ Cadastro r√°pido';
    } else if (stepNumber === 3) {
      step3.classList.remove('hidden');
      stepPillText.innerHTML = '<strong>Passo 3</strong> ‚Ä¢ Girar roleta';
    } else if (stepNumber === 4) {
      step4.classList.remove('hidden');
      stepPillText.innerHTML = '<strong>Passo 4</strong> ‚Ä¢ Escolher dia &amp; hor√°rio';
    }
  }

  function sanitizePhone(phone) {
    return (phone || '').replace(/\D/g, '');
  }

  function createPetFields() {
    const wrapper = document.createElement('div');
    wrapper.className = 'pet-wrapper';

    const nameId = 'petName_' + Math.random().toString(36).slice(2);
    const breedId = 'petBreed_' + Math.random().toString(36).slice(2);
    const infoId = 'petInfo_' + Math.random().toString(36).slice(2);

    wrapper.innerHTML = `
      <div class="field-group">
        <div class="field-label">Nome do pet</div>
        <input type="text" id="${nameId}" placeholder="Nome do pet" />
      </div>
      <div class="field-group">
        <div class="field-label">Ra√ßa</div>
        <select id="${breedId}"></select>
      </div>
      <div class="field-group">
        <div class="field-label">Mais informa√ß√µes sobre o pet (opcional)</div>
        <textarea id="${infoId}" placeholder="Porte, comportamento, medica√ß√£o, etc."></textarea>
      </div>
      <button type="button" class="btn btn-secondary btn-inline btn-remove-pet">Remover pet</button>
    `;

    const breedSelect = wrapper.querySelector(`#${breedId}`);
    racas.forEach(r => {
      const opt = document.createElement('option');
      opt.value = r;
      opt.textContent = r;
      breedSelect.appendChild(opt);
    });

    wrapper.querySelector('.btn-remove-pet').addEventListener('click', () => {
      petsContainer.removeChild(wrapper);
    });

    petsContainer.appendChild(wrapper);
  }

  function getPetsFromForm() {
    const wrappers = Array.from(petsContainer.querySelectorAll('.pet-wrapper'));
    const pets = [];

    wrappers.forEach(wrapper => {
      const nameInput = wrapper.querySelector('input[type="text"]');
      const breedSelect = wrapper.querySelector('select');
      const infoTextarea = wrapper.querySelector('textarea');

      const name = (nameInput?.value || '').trim();
      const breed = breedSelect?.value || '';
      const info = (infoTextarea?.value || '').trim();

      if (name && breed) pets.push({ name, breed, info });
    });

    return pets;
  }

  function fillPetSelect() {
    petSelect.innerHTML = '';
    if (!currentPets || !currentPets.length) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'Nenhum pet encontrado. Fale com a gente no WhatsApp.';
      petSelect.appendChild(opt);
      petSelect.disabled = true;
    } else {
      petSelect.disabled = false;
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = 'Selecione o pet...';
      petSelect.appendChild(opt0);

      currentPets.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.breed ? `${p.name} (${p.breed})` : p.name;
        petSelect.appendChild(opt);
      });
    }
  }

  function setPrize(prize) {
    selectedPrize = prize;
    prizeBadgeWrapper.classList.remove('hidden');
    prizeIcon.textContent = prize.icon;
    prizeTitle.textContent = prize.key;
    prizeSubtitle.textContent = prize.subtitle;

    try { localStorage.setItem('petfunny_prize', JSON.stringify(prize)); } catch {}
  }

  (function loadSavedPrize() {
    try {
      const saved = localStorage.getItem('petfunny_prize');
      if (saved) setPrize(JSON.parse(saved));
    } catch {}
  })();

  function validarDiaHora(dateStr, timeStr) {
    if (!dateStr || !timeStr) return 'Informe a data e o hor√°rio.';

    const date = new Date(dateStr + 'T' + timeStr + ':00');
    if (Number.isNaN(date.getTime())) return 'Data ou hor√°rio inv√°lidos.';

    const diaSemana = date.getDay();
    const [hh, mm] = timeStr.split(':').map(n => parseInt(n, 10));
    const minutos = hh * 60 + mm;

    const inicio = 7 * 60 + 30;

    if (diaSemana === 0) return 'Atendemos apenas de segunda a s√°bado.';
    if (diaSemana >= 1 && diaSemana <= 5) {
      const fim = 17 * 60 + 30;
      if (minutos < inicio || minutos > fim) return 'Segunda a sexta: hor√°rios entre 07:30 e 17:30.';
    }
    if (diaSemana === 6) {
      const fim = 13 * 60;
      if (minutos < inicio || minutos > fim) return 'S√°bado: hor√°rios entre 07:30 e 13:00.';
    }
    return null;
  }

  function pad2(n) { return String(n).padStart(2, '0'); }

  function buildRangeForDate(dateStr) {
    if (!dateStr) return null;
    const d = new Date(dateStr + 'T00:00:00');
    const day = d.getDay();
    if (day === 0) return { closed: true };

    const startMin = 7 * 60 + 30;
    const endMin = (day === 6) ? (13 * 60) : (17 * 60 + 30);
    return { closed: false, startMin, endMin };
  }

  function normalizeHHMM(t) {
    const s = String(t || '').trim();
    const m = s.match(/^(\d{1,2}):(\d{2})$/);
    if (!m) return null;
    const hh = String(parseInt(m[1], 10)).padStart(2, '0');
    const mm = m[2];
    return `${hh}:${mm}`;
  }

  function isActiveBookingStatus(status) {
    const s = String(status || '').toLowerCase();
    return s !== 'cancelado' && s !== 'cancelada' && s !== 'canceled' && s !== 'cancelled';
  }

  async function loadOccupiedTimesForDate(dateStr) {
    occupiedTimes = new Set();
    if (!dateStr) return;

    const resp = await apiGet('/api/bookings', { date: dateStr });
    const bookings = resp.bookings || [];

    bookings.forEach(b => {
      if (!isActiveBookingStatus(b.status)) return;
      const t = normalizeHHMM(b.time);
      if (t) occupiedTimes.add(t);
    });
  }

  function countAvailableSlots(dateStr) {
    const range = buildRangeForDate(dateStr);
    if (!range || range.closed) return 0;

    let count = 0;
    for (let m = range.startMin; m <= range.endMin; m += 30) {
      const hh = Math.floor(m / 60);
      const mm = m % 60;
      const t = `${pad2(hh)}:${pad2(mm)}`;
      if (!occupiedTimes.has(t)) count++;
    }
    return count;
  }

  function setAvailabilityMessage(dateStr) {
    if (!availabilityMsg) return;

    if (!dateStr) {
      availabilityMsg.textContent = 'Selecione uma data para ver os hor√°rios dispon√≠veis.';
      return;
    }

    const range = buildRangeForDate(dateStr);
    if (!range || range.closed) {
      availabilityMsg.textContent = 'Fechado aos domingos.';
      return;
    }

    const available = countAvailableSlots(dateStr);
    if (available <= 0) availabilityMsg.textContent = 'Dia lotado. Escolha outra data.';
    else if (available === 1) availabilityMsg.textContent = '1 hor√°rio dispon√≠vel.';
    else availabilityMsg.textContent = `${available} hor√°rios dispon√≠veis.`;
  }

  function resetTimeSelects() {
    hourSelect.innerHTML = '';
    minuteSelect.innerHTML = '';
    hourSelect.appendChild(new Option('Hora...', ''));
    minuteSelect.appendChild(new Option('Min...', ''));
    hourSelect.disabled = true;
    minuteSelect.disabled = true;
  }

  function populateHourSelect(dateStr) {
    hourSelect.innerHTML = '';
    minuteSelect.innerHTML = '';

    hourSelect.appendChild(new Option('Hora...', ''));
    minuteSelect.appendChild(new Option('Min...', ''));

    const range = buildRangeForDate(dateStr);
    if (!dateStr) {
      hourSelect.disabled = true;
      minuteSelect.disabled = true;
      return;
    }
    if (!range || range.closed) {
      hourSelect.disabled = true;
      minuteSelect.disabled = true;
      hourSelect.appendChild(new Option('Fechado', ''));
      return;
    }

    hourSelect.disabled = false;
    minuteSelect.disabled = true;

    const startHour = Math.floor(range.startMin / 60);
    const endHour = Math.floor(range.endMin / 60);

    for (let h = startHour; h <= endHour; h++) {
      const hh = pad2(h);
      const candidates = [`${hh}:00`, `${hh}:30`];

      const hasAnyFree = candidates.some(t => {
        const [H, M] = t.split(':').map(Number);
        const total = H * 60 + M;
        if (total < range.startMin || total > range.endMin) return false;
        if (occupiedTimes.has(t)) return false;
        return true;
      });

      if (hasAnyFree) hourSelect.appendChild(new Option(hh, hh));
    }

    if (hourSelect.options.length === 1) {
      hourSelect.disabled = true;
      minuteSelect.disabled = true;
      hourSelect.appendChild(new Option('Sem hor√°rios', ''));
    }
  }

  function populateMinuteSelect(dateStr, hh) {
    minuteSelect.innerHTML = '';
    minuteSelect.appendChild(new Option('Min...', ''));

    const range = buildRangeForDate(dateStr);
    if (!range || range.closed || !hh) {
      minuteSelect.disabled = true;
      return;
    }

    const h = parseInt(hh, 10);

    [0, 30].forEach(mm => {
      const total = h * 60 + mm;
      if (total < range.startMin || total > range.endMin) return;

      const t = `${pad2(h)}:${pad2(mm)}`;
      if (occupiedTimes.has(t)) return;

      minuteSelect.appendChild(new Option(pad2(mm), pad2(mm)));
    });

    if (minuteSelect.options.length === 1) {
      minuteSelect.disabled = true;
      minuteSelect.appendChild(new Option('Sem hor√°rios', ''));
    } else {
      minuteSelect.disabled = false;
    }
  }

  function getSelectedTimeHHMM() {
    const hh = hourSelect.value;
    const mm = minuteSelect.value;
    if (!hh || !mm) return '';
    return `${hh}:${mm}`;
  }

  // ======= EVENTOS =======
  btnIniciar.addEventListener('click', async () => {
    onboardingSection.style.display = 'none';
    app.style.display = 'flex';
    showStep(1);
    setTimeout(() => phoneInput.focus(), 200);

    try {
      await loadServicesForSelect();
    } catch (e) {
      console.error('Erro ao carregar servi√ßos:', e);
      serviceSelect.disabled = true;
      serviceSelect.innerHTML = '<option value="">Erro ao carregar servi√ßos</option>';
      if (serviceHelp) serviceHelp.textContent = 'N√£o foi poss√≠vel carregar a lista de servi√ßos.';
    }
  });

  btnHowItWorks.addEventListener('click', () => {
    const isHidden = howItWorksBox.classList.contains('hidden');
    if (isHidden) {
      howItWorksBox.classList.remove('hidden');
      btnHowItWorks.textContent = 'Fechar explica√ß√£o';
    } else {
      howItWorksBox.classList.add('hidden');
      btnHowItWorks.textContent = 'Entender rapidinho como funciona';
    }
  });

  btnStep1Next.addEventListener('click', async () => {
    step1Error.classList.add('hidden');
    const digits = sanitizePhone(phoneInput.value.trim());

    if (!digits || digits.length < 10) {
      step1Error.textContent = 'Por favor, informe um WhatsApp v√°lido (com DDD).';
      step1Error.classList.remove('hidden');
      return;
    }

    currentPhoneDigits = digits;

    try {
      const lookup = await apiPost('/api/customers/lookup', { phone: digits });

      if (lookup.exists && lookup.customer) {
        currentCustomer = lookup.customer;

        try {
          const petsResp = await apiGet('/api/pets', { customer_id: currentCustomer.id });
          currentPets = petsResp.pets || [];
        } catch (e) {
          console.error('Erro ao buscar pets do cliente:', e);
          currentPets = [];
        }

        fillPetSelect();
        showStep(3);
      } else {
        currentCustomer = null;
        currentPets = [];
        ownerName.value = '';
        petsContainer.innerHTML = '';
        createPetFields();
        showStep(2);
      }
    } catch (e) {
      step1Error.textContent = e.message;
      step1Error.classList.remove('hidden');
    }
  });

  btnAddPet.addEventListener('click', () => createPetFields());

  btnStep2Next.addEventListener('click', async () => {
  step2Error.classList.add('hidden');
  const name = ownerName.value.trim();
  const pets = getPetsFromForm();

  if (!name) {
    step2Error.textContent = 'Informe seu nome.';
    step2Error.classList.remove('hidden');
    return;
  }
  if (!pets.length) {
    step2Error.textContent = 'Cadastre pelo menos um pet para continuar.';
    step2Error.classList.remove('hidden');
    return;
  }

  try {
    const cRes = await apiPost('/api/customers', { name, phone: currentPhoneDigits });

    if (!cRes || !cRes.customer || !cRes.customer.id) {
      console.error('Resposta inesperada de /api/customers:', cRes);
      throw new Error('Cadastro do cliente n√£o retornou ID. Verifique a API /api/customers.');
    }

    currentCustomer = cRes.customer;

    currentPets = [];
    for (const p of pets) {
      const respPet = await apiPost('/api/pets', {
        customer_id: currentCustomer.id,
        name: p.name,
        breed: p.breed,
        info: p.info || null
      });

      if (!respPet || !respPet.pet || !respPet.pet.id) {
        console.error('Resposta inesperada de /api/pets:', respPet);
        throw new Error('Cadastro do pet n√£o retornou ID. Verifique a API /api/pets.');
      }

      currentPets.push(respPet.pet);
    }

    fillPetSelect();
    showStep(3);
  } catch (e) {
    step2Error.textContent = e.message;
    step2Error.classList.remove('hidden');
  }
});


  btnSpin.addEventListener('click', () => {
    step3Error.classList.add('hidden');
    if (spinning) return;

    spinning = true;
    btnSpin.disabled = true;

    sortingScreen.classList.remove('hidden');

    const randomIndex = Math.floor(Math.random() * prizes.length);
    const prize = prizes[randomIndex];

    const baseRotation = 360 * 4;
    const segmentAngle = 360 / prizes.length;
    const extraRotation = segmentAngle * randomIndex + segmentAngle / 2;
    const finalRotation = baseRotation + extraRotation;

    wheel.style.transition = 'transform 2.5s ease-out';
    wheel.style.transform = `rotate(${finalRotation}deg)`;

    setTimeout(() => {
      wheel.style.transition = 'none';
      const normalized = finalRotation % 360;
      wheel.style.transform = `rotate(${normalized}deg)`;
      setPrize(prize);
      spinning = false;
      btnSpin.disabled = false;
    }, 2600);

    setTimeout(() => {
      sortingScreen.classList.add('hidden');
      showStep(4);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 5000);
  });

  dateInput.addEventListener('change', async () => {
    step4Error.classList.add('hidden');

    resetTimeSelects();
    setAvailabilityMessage(dateInput.value);

    try {
      await loadOccupiedTimesForDate(dateInput.value);
    } catch (e) {
      console.error('Falha ao carregar hor√°rios ocupados:', e);
      occupiedTimes = new Set();
    }

    setAvailabilityMessage(dateInput.value);
    populateHourSelect(dateInput.value);
  });

  hourSelect.addEventListener('change', () => {
    populateMinuteSelect(dateInput.value, hourSelect.value);
  });

  btnConfirmBooking.addEventListener('click', async () => {
    step4Error.classList.add('hidden');
    step4Success.classList.add('hidden');

    if (!currentCustomer) {
      step4Error.textContent = 'Ocorreu um problema com o cadastro. Volte e tente novamente.';
      step4Error.classList.remove('hidden');
      return;
    }

    if (!selectedPrize) {
      step4Error.textContent = 'Gire a roleta antes de confirmar o agendamento.';
      step4Error.classList.remove('hidden');
      return;
    }

    const petId = petSelect.value;

    const serviceId = serviceSelect.value;
    const selectedOpt = serviceSelect.options[serviceSelect.selectedIndex];
    const serviceTitle = selectedOpt?.dataset?.title || selectedOpt?.textContent || '';

    const serviceValueCents = Number(selectedOpt?.dataset?.valueCents);
    const serviceValueBRL = Number.isFinite(serviceValueCents) ? formatCentsBRL(serviceValueCents) : '‚Äî';

    const date = dateInput.value;
    const time = getSelectedTimeHHMM();
    const notes = notesInput.value.trim();

    if (!petId) {
      step4Error.textContent = 'Selecione o pet que vai usar o mimo.';
      step4Error.classList.remove('hidden');
      return;
    }
    if (!serviceId) {
      step4Error.textContent = 'Selecione o servi√ßo do agendamento.';
      step4Error.classList.remove('hidden');
      return;
    }
    if (!date) {
      step4Error.textContent = 'Selecione a data.';
      step4Error.classList.remove('hidden');
      return;
    }
    if (!time) {
      step4Error.textContent = 'Selecione a hora e o minuto (00 ou 30).';
      step4Error.classList.remove('hidden');
      return;
    }

    if (occupiedTimes.has(time)) {
      step4Error.textContent = 'Esse hor√°rio acabou de ser preenchido. Escolha outro.';
      step4Error.classList.remove('hidden');
      return;
    }

    const erroHorario = validarDiaHora(date, time);
    if (erroHorario) {
      step4Error.textContent = erroHorario;
      step4Error.classList.remove('hidden');
      return;
    }

    try {
      await apiPost('/api/bookings', {
        customer_id: currentCustomer.id,
        pet_id: parseInt(petId, 10),
        date,
        time,
        service: serviceTitle, // mant√©m compat√≠vel com seu backend atual
        prize: selectedPrize.key,
        notes,
        status: 'agendado'
      });

      const pet = currentPets.find(p => String(p.id) === String(petId));
      const petName = pet ? pet.name : 'seu pet';

      const dataBr = (() => {
        const parts = (date || '').split('-');
        if (parts.length === 3) return `${parts[2]}/${parts[1]}/${parts[0]}`;
        return date;
      })();

      function normalizeText(str) {
        return str.normalize('NFC');
      }

      const texto = normalizeText(`
Oi, Pet Funny, meu nome √© ${currentCustomer.name || ''}, realizei um novo agendamento vindo da Roleta de Mimos:

‚Ä¢ Tutor(a): ${currentCustomer.name || ''}
‚Ä¢ WhatsApp do tutor: ${phoneInput.value.trim() || ''}
‚Ä¢ Pet: ${petName}
‚Ä¢ Servi√ßo: ${serviceTitle}
‚Ä¢ Valor do servi√ßo: ${serviceValueBRL}
‚Ä¢ Mimo da Roleta: ${selectedPrize.key}
‚Ä¢ Data: ${dataBr}
‚Ä¢ Hor√°rio: ${time}
‚Ä¢ Observa√ß√µes: ${notes || '‚Äî'}

Aguardo o retorno de confirma√ß√£o do agendamento.`).trim();

      const url = `https://wa.me/5516981535338?text=${encodeURIComponent(texto)}`;

      successScreen.classList.remove('hidden');

      setTimeout(() => {
        window.open(url, '_blank');
        successScreen.classList.add('hidden');
        try { localStorage.removeItem('petfunny_prize'); } catch {}
      }, 5000);

    } catch (e) {
      step4Error.textContent = e.message;
      step4Error.classList.remove('hidden');
    }
  });

  createPetFields();
  resetTimeSelects();
  setAvailabilityMessage('');
</script>

</body>
</html>
